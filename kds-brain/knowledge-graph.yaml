# KDS BRAIN - Knowledge Graph
# Version: 1.1
# Last Updated: 2025-11-03T10:35:00Z
# Purpose: Aggregated learnings from KDS interactions
# STATUS: ACTIVE - Learning from playwright-ids-fab-button session

intent_patterns:
  plan:
    phrases:
      - pattern: "add [X] button"
        confidence: 0.95
        routes_to: "work-planner.md"
        examples:
          - "add share button"
          - "add fab button"
          - "I want to add a FAB button pulse animation"
      - pattern: "create [X] dashboard"
        confidence: 0.95
        routes_to: "work-planner.md"
        examples:
          - "create a SPA dashboard for healthcheck"
          - "create health monitoring dashboard"
      - pattern: "implement [X]"
        confidence: 0.90
        routes_to: "work-planner.md"
        examples:
          - "implement the healthchecks"
          - "implement API integration"
  execute:
    phrases:
      - pattern: "add ids to [component]"
        confidence: 0.95
        routes_to: "direct_execution"
        skip_planning: true
        examples:
          - "add ids to HostControlPanel.razor"
          - "add IDs for playwright tests"
      - pattern: "add [attributes] for [testing]"
        confidence: 0.90
        routes_to: "test_preparation"
        skip_planning: true
        examples:
          - "add data-testid for playwright"
  resume: {}
  correct: {}
  test: {}
  validate: {}
  ask: {}
  govern: {}

file_relationships:
  host_control_panel:
    primary_file: "SPA/NoorCanvas/Pages/HostControlPanel.razor"
    related_files:
      - path: "SPA/NoorCanvas/Services/ShareButtonInjectionService.cs"
        relationship: "service_injection"
        confidence: 1.0
      - path: "SPA/NoorCanvas/wwwroot/css/noor-canvas.css"
        relationship: "styling"
        confidence: 1.0
      - path: "SPA/NoorCanvas/Components/Host/HostControlPanelSidebar.razor"
        relationship: "child_component"
        confidence: 1.0
        description: "Sidebar containing Start Session button"
      - path: "SPA/NoorCanvas/Controllers/HostController.cs"
        relationship: "api_backend"
        confidence: 1.0
        description: "API endpoints for session management"
      - path: "KDS/docs/flows/start-session-button-flow.md"
        relationship: "flow_documentation"
        confidence: 1.0
        description: "Complete flow map of Start Session button execution"
    modification_pattern: "co_modification"
  
  start_session_flow:
    primary_file: "SPA/NoorCanvas/Components/Host/HostControlPanelSidebar.razor"
    button_id: "sidebar-start-session-btn"
    execution_chain:
      - step: 1
        description: "Button click event"
        file: "Components/Host/HostControlPanelSidebar.razor"
        line: 82
        element_id: "sidebar-start-session-btn"
      - step: 2
        description: "Event handler invoked"
        file: "Pages/HostControlPanel.razor"
        line: 1325
        method: "StartSession()"
      - step: 3
        description: "HTTP POST to API"
        endpoint: "/api/host/session/{sessionId}/start"
        method: "POST"
        parameters: ["sessionId", "canvasType"]
      - step: 4
        description: "API controller processes request"
        file: "Controllers/HostController.cs"
        line: 386
        method: "StartSession(int sessionId, string canvasType)"
      - step: 5
        description: "Database update"
        file: "Controllers/HostController.cs"
        line: 410
        updates: ["StartedAt", "Status", "CanvasType"]
      - step: 6
        description: "SignalR broadcast"
        file: "Controllers/HostController.cs"
        line: 429
        event: "SessionBegan"
        target_group: "session_{sessionId}"
      - step: 7
        description: "Response handling and UI update"
        file: "Pages/HostControlPanel.razor"
        line: 1343
        updates: ["SessionStatus", "sessionStartTime", "UI re-render"]
      - step: 8
        description: "Share button injection (two-phase)"
        phase_1:
          name: "Server-side asset buttons"
          file: "Pages/HostControlPanel.razor"
          line: 3190
          method: "InjectShareButtons()"
          target: "Asset containers"
          technology: "C# Regex"
        phase_2:
          name: "Client-side section buttons"
          file: "wwwroot/js/transcript-section-parser.js"
          line: 45
          method: "injectShareButtons()"
          target: "h2 sections"
          technology: "JavaScript DOM"
    documentation: "KDS/docs/flows/start-session-button-flow.md"
    last_mapped: "2025-11-03"
    share_button_injection:
      architecture: "two-phase"
      phase_1_server:
        description: "Asset share buttons injected during HTML transform"
        timing: "After session start, during TransformTranscriptHtmlAsync"
        data_source: "SessionAssets API"
        method: "InjectShareButtons(html, assets)"
        marker: "data-asset-id attribute"
      phase_2_client:
        description: "Section share buttons injected after DOM render"
        timing: "After Blazor render, via HandleTranscriptRendered callback"
        data_source: "DOM h2 elements"
        script: "transcript-section-parser.js"
        method: "TranscriptSectionParser.injectShareButtons()"
        canvas_filter: "Only for transcript canvas (skips asset canvas)"
  
  playwright_test_preparation:
    primary_file: "SPA/NoorCanvas/Components/HostControlPanelContent.razor"
    related_files:
      - path: "Docs/PLAYWRIGHT-IDS-FAB-BUTTON.md"
        relationship: "test_documentation"
        confidence: 1.0
        reason: "Component IDs documented for Playwright testing"
    modification_pattern: "component_with_test_documentation"
    frequency: 1
  
  kds_dashboard:
    primary_file: "KDS/kds-dashboard.html"
    related_files:
      - path: "KDS/scripts/run-health-checks.ps1"
        relationship: "health_check_engine"
        confidence: 1.0
        reason: "Executes health checks called by dashboard"
      - path: "KDS/scripts/dashboard-api-server.ps1"
        relationship: "api_backend"
        confidence: 1.0
        reason: "HTTP server providing health check API"
      - path: "KDS/scripts/launch-dashboard.ps1"
        relationship: "unified_launcher"
        confidence: 1.0
        reason: "All-in-one launcher for server + dashboard"
      - path: "KDS/scripts/open-dashboard.ps1"
        relationship: "simple_launcher"
        confidence: 1.0
        reason: "Dashboard-only launcher"
      - path: "KDS/dashboard/README.md"
        relationship: "primary_documentation"
        confidence: 1.0
        reason: "Main dashboard documentation"
      - path: ".vscode/tasks.json"
        relationship: "vscode_integration"
        confidence: 1.0
        reason: "VS Code tasks for easy launching"
    modification_pattern: "dashboard_ecosystem"
    frequency: 1
    created: "2025-11-03"
    feature_type: "health_monitoring"

workflow_patterns:
  service_layer_ui_injection:
    description: "Service layer injection → JavaScript handlers → Toast UI"
    steps:
      - "Service layer injection"
      - "JavaScript handlers"
      - "Toast UI feedback"
    success_rate: 1.0
    used_in:
      - "hcp-fab-button"
  
  blazor_component_api_flow:
    description: "Blazor component button click → API controller → Database + SignalR → UI update"
    steps:
      - "User clicks button in child Blazor component"
      - "EventCallback triggers parent component method"
      - "Parent makes HTTP POST to API endpoint"
      - "API controller updates database via EF Core"
      - "API broadcasts event via SignalR hub"
      - "API returns success response"
      - "Parent component updates state and re-renders UI"
    key_technologies:
      - "Blazor Server"
      - "ASP.NET Core API"
      - "Entity Framework Core"
      - "SignalR"
    success_rate: 1.0
    confidence: 1.0
    reusable: true
    example_implementation: "Start Session button flow"
    documentation: "KDS/docs/flows/start-session-button-flow.md"
    used_in:
      - "start-session-feature"
  
  two_phase_button_injection:
    description: "Server-side asset buttons + Client-side section buttons"
    architecture: "Hybrid injection pattern"
    phases:
      phase_1:
        name: "Server-Side Asset Buttons"
        timing: "During HTML transformation (before render)"
        technology: "C# Regex + HTML string manipulation"
        data_source: "Database API (SessionAssets)"
        target: "Asset containers (.ayah-card, etc.)"
        marker: "data-asset-id attribute"
        complexity: "High (requires DB metadata)"
      phase_2:
        name: "Client-Side Section Buttons"
        timing: "After Blazor render (DOM ready)"
        technology: "JavaScript DOM manipulation"
        data_source: "DOM parsing (h2 elements)"
        target: "Transcript sections (h2 groupings)"
        marker: "data-section-id attribute"
        complexity: "Low (pure DOM operation)"
        canvas_filter: "Only transcript canvas"
    why_two_phases:
      - "Assets need database metadata → Server-side required"
      - "Sections are HTML-based → Client-side efficient"
      - "Separation improves performance and maintainability"
    shared_characteristics:
      - "Golden NOOR theme (#FFD700)"
      - "Unified marker: data-noor-share-control"
      - "Click handlers call C# methods via JSInvokable"
      - "SignalR broadcast for sharing"
      - "Visual feedback (spinner → success/error)"
    success_rate: 1.0
    confidence: 1.0
    reusable: true
    documentation: "KDS/docs/flows/start-session-button-flow.md"
    used_in:
      - "transcript-share-feature"
      - "asset-share-feature"
  
  test_first_id_preparation:
    description: "Add semantic IDs to components before writing Playwright tests"
    steps:
      - "Analyze component structure"
      - "Add semantic IDs following [component]-[section]-[element] convention"
      - "Document IDs in comprehensive reference"
      - "Provide test examples"
      - "Include Percy visual regression examples"
      - "Mark IDs with [PLAYWRIGHT-IDS] comments"
    success_rate: 1.0
    confidence: 1.0
    reusable: true
    used_in:
      - "playwright-ids-fab-button"
  
  single_file_spa_creation:
    description: "Create portable HTML dashboard with inline CSS/JS and zero dependencies"
    steps:
      - "Design UI structure with tabs and cards"
      - "Inline all CSS (no external stylesheets)"
      - "Inline all JavaScript (no external scripts)"
      - "Add PowerShell launcher script"
      - "Create VS Code task integration"
      - "Write comprehensive documentation"
    file_pattern:
      main_file: "KDS/*.html"
      documentation: "KDS/dashboard/*.md"
      launcher: "KDS/scripts/open-*.ps1"
      tasks: ".vscode/tasks.json"
    success_rate: 1.0
    confidence: 0.95
    reusable: true
    used_in:
      - "kds-health-dashboard"
    benefits:
      - "100% portable (single file)"
      - "Zero external dependencies"
  
  brain_test_synchronization:
    description: "CRITICAL: BRAIN integrity test changes require synchronous updates to health checks and dashboard"
    rule_id: "BRAIN-SYNC-001"
    enforcement: "MANDATORY (change-governor blocks violations)"
    trigger_files:
      - "KDS/tests/test-brain-integrity.ps1"
      - "KDS/tests/test-brain-corruption-scenarios.ps1"
    required_dependencies:
      - path: "KDS/scripts/run-health-checks.ps1"
        section: "Test-BRAINSystem()"
        requirement: "Must map ALL integrity checks from test suite"
      - path: "KDS/kds-dashboard.html"
        section: "renderBRAINMetricsFromAPI()"
        requirement: "Must display ALL integrity checks in BRAIN System tab"
      - path: "KDS/tests/BRAIN-INTEGRITY-TEST.md"
        section: "What Gets Validated"
        requirement: "Must document ALL checks with current count"
    validation_logic:
      - "Detect if test-brain-integrity.ps1 modified"
      - "Verify all 3 dependencies also modified in same commit"
      - "Count checks in test suite (currently 13)"
      - "Verify health script maps all 13 checks"
      - "Verify dashboard displays all 13 checks"
      - "Verify documentation reflects count of 13"
      - "REJECT commit if any dependency missing or count mismatch"
    rationale:
      - "Dashboard must show ALL current BRAIN checks, not subset"
      - "Automated health checks must include every integrity validation"
      - "System components must agree on what 'healthy BRAIN' means"
      - "Users must see accurate, complete BRAIN status"
      - "Silent failures are prevented by enforced synchronization"
    confidence: 1.00
    source: "governance/rules/brain-test-synchronization.md"
    enforced_by: "change-governor.md"
    created: "2025-11-03"
    current_check_count: 13
    success_rate: 1.0
    reusable: false
    scope: "kds_internal_governance"
      - "Works offline"
      - "Fast load time"
      - "Easy to share/deploy"
  
  kds_health_monitoring:
    description: "PowerShell-based health checks with browser dashboard and API server"
    architecture: "Client-Server (browser SPA + local API)"
    components:
      dashboard: "Single-file HTML with auto-detection (Live/Demo modes)"
      api_server: "PowerShell HTTP listener on localhost:8765"
      health_checks: "PowerShell script with categorized validations"
      launcher: "All-in-one script (server + client)"
    steps:
      - "Start PowerShell HTTP server (background job)"
      - "Open dashboard in browser"
      - "Dashboard detects API availability"
      - "Execute health checks on demand"
      - "Display results with status circles"
      - "Generate recommendations from failures"
    technologies:
      - "PowerShell (server + health checks)"
      - "HTML5/CSS3/JavaScript (dashboard)"
      - "HTTP REST API (communication)"
      - "VS Code tasks (easy launch)"
    success_rate: 1.0
    confidence: 0.95
    reusable: true
    used_in:
      - "kds-health-dashboard"
  
  powershell_http_server:
    description: "Simple PowerShell HTTP server for local API endpoints"
    pattern_type: "Local development server"
    implementation:
      - "Create HttpListener on localhost:port"
      - "Set up CORS headers for browser access"
      - "Handle GET/POST requests"
      - "Return JSON responses"
      - "Run as background job"
    use_cases:
      - "Dashboard API integration"
      - "Local testing without IIS/Kestrel"
      - "Lightweight health check endpoints"
    success_rate: 1.0
    confidence: 0.90
    reusable: true
    used_in:
      - "kds-dashboard-api-server"
  
  unified_launcher_pattern:
    description: "Single command to start server + open client application"
    pattern_type: "Developer experience"
    steps:
      - "Start background API server (job)"
      - "Wait for server readiness"
      - "Open client application"
      - "Verify connectivity"
      - "Optional: keep server running or auto-cleanup"
    parameters:
      - "-KeepServerRunning (optional)"
      - "-Port (default 8765)"
    success_rate: 1.0
    confidence: 0.95
    reusable: true
    used_in:
      - "kds-launch-dashboard"
    benefits:
      - "Single command UX"
      - "Automatic cleanup"
      - "User-friendly"
      - "Reduces setup friction"

correction_history:
  file_mismatch:
    total_occurrences: 1
    common_mistakes:
      - incorrect_location: "tmp/PdfExportService.cs"
        correct_location: "SPA/NoorCanvas/Services/PdfExportService.cs"
        reason: "Architectural Thinking Mandate - no temporary files"
        pattern: "Services must be in Services/ directory"
        occurrences: 1
        first_seen: "2025-11-03T20:10:00Z"
        confidence: 0.85
  approach_mismatch:
    total_occurrences: 0
    common_mistakes: []
  scope_mismatch:
    total_occurrences: 0
    common_mistakes: []

validation_insights:
  common_failures: []
  test_patterns:
    playwright_e2e:
      framework: "playwright"
      canonical_test_data: "session-212"
      used_in:
        - "hcp-fab-button"
    
    id_based_playwright_selectors:
      framework: "playwright"
      description: "Use semantic element IDs for reliable test selectors instead of text-based selectors"
      confidence: 1.0
      reusable: true
      naming_convention: "[component]-[section]-[element]"
      examples:
        - "hcp-content-fab-share-btn"
        - "content-qa-toggle-btn"
        - "content-transcript-container"
      benefits:
        - "Resilient to UI text changes"
        - "More maintainable"
        - "Better for visual regression testing"
      used_in:
        - "hcp-fab-button-testing"
    
    dashboard_refresh_automation:
      framework: "playwright"
      description: "Automated testing of dashboard refresh functionality with API integration"
      confidence: 1.0
      reusable: true
      test_pattern: "api_connectivity_validation"
      checks:
        - "API server responds on localhost:8765"
        - "Health check endpoint returns valid JSON"
        - "Dashboard loads and renders"
        - "Refresh button triggers API call"
        - "UI updates with health check results"
      used_in:
        - "kds-dashboard-testing"

feature_components:
  fab_button:
    status: "complete"
    completion_date: "2025-11-01"
    files:
      - "SPA/NoorCanvas/Pages/HostControlPanel.razor"
      - "SPA/NoorCanvas/Services/ShareButtonInjectionService.cs"
      - "SPA/NoorCanvas/wwwroot/css/noor-canvas.css"
      - "Tests/UI/hcp-fab-button-injection-test.spec.ts"
      - "Tests/UI/hcp-fab-button-click-test.spec.ts"
    test_approach: "playwright_e2e_session_212"
    workflow_used: "service_layer_ui_injection"
  
  kds_health_dashboard:
    status: "complete"
    completion_date: "2025-11-03"
    files:
      - "KDS/kds-dashboard.html"
      - "KDS/scripts/run-health-checks.ps1"
      - "KDS/scripts/dashboard-api-server.ps1"
      - "KDS/scripts/launch-dashboard.ps1"
      - "KDS/scripts/open-dashboard.ps1"
      - "KDS/tests/test-dashboard-refresh.ps1"
      - "KDS/dashboard/README.md"
      - "KDS/dashboard/QUICK-START.md"
      - "KDS/dashboard/HEALTHCHECK-INTEGRATION.md"
      - "KDS/dashboard/IMPLEMENTATION-SUMMARY.md"
      - "KDS/dashboard/QUICK-REFERENCE.md"
      - ".vscode/tasks.json"
    test_approach: "playwright_automation"
    workflow_used: "single_file_spa_creation"
    patterns_applied:
      - "single_file_spa_creation"
      - "kds_health_monitoring"
      - "powershell_http_server"
      - "unified_launcher_pattern"
    source: "copilot_chat"

statistics:
  total_events_processed: 15
  last_updated: "2025-11-03T19:00:00Z"
  knowledge_graph_version: "1.4"
  confidence_threshold: 0.70
  learning_enabled: true
  status: "ACTIVE"
  recent_sessions:
    - session_id: "share-button-injection-investigation"
      date: "2025-11-03"
      intent: "ask"
      success: true
      learnings: ["two_phase_button_injection", "server_client_hybrid_pattern", "share_flow_complete"]
    - session_id: "start-session-flow-investigation"
      date: "2025-11-03"
      intent: "ask"
      success: true
      learnings: ["blazor_component_api_flow", "start_session_execution_chain", "flow_documentation"]
    - session_id: "playwright-ids-fab-button"
      date: "2025-11-03"
      intent: "execute"
      success: true
      learnings: ["id_based_playwright_selectors", "test_first_id_preparation"]
    - session_id: "conv-dashboard-2025-11-03"
      date: "2025-11-03"
      intent: "plan"
      success: true
      source: "copilot_chat"
      learnings: ["single_file_spa_creation", "kds_health_monitoring", "powershell_http_server", "unified_launcher_pattern", "dashboard_refresh_automation"]

protection_config:
  enabled: true
  version: "1.0"
  description: "Phase 1 Protection - Confidence checks and learning quality thresholds"
  
  learning_quality:
    min_confidence_threshold: 0.70
    min_occurrences_for_pattern: 3
    max_single_event_confidence: 0.50
    anomaly_confidence_threshold: 0.95
    description: "Prevents learning from insufficient data and detects anomalies"
  
  routing_safety:
    enabled: true
    fallback_on_low_confidence: true
    ask_user_threshold: 0.70
    auto_route_threshold: 0.85
    description: "Asks user for clarification when confidence is low"
  
  correction_memory:
    enabled: true
    alert_on_repeated_mistake: 3
    prevent_action_threshold: 5
    track_correction_patterns: true
    description: "Prevents repeating the same mistakes"
  
  validation:
    validate_confidence_scores: true
    validate_file_references: true
    detect_stale_relationships: true
    max_relationship_age_days: 90
    description: "Ensures data integrity and removes stale information"
