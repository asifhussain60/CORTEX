#!/usr/bin/env python3
"""
CORTEX Feature Capture - Smart context feature logging

Usage:
    cortex-feature "what we built"
    cortex-feature --interactive

Author: Asif Hussain
Copyright: ¬© 2024-2025 Asif Hussain. All rights reserved.
Phase: Phase 4 - Advanced CLI & Integration
"""

import sys
import os
from pathlib import Path
from datetime import datetime
from typing import Optional, List, Dict
import argparse
import subprocess

# Add CORTEX root to path
CORTEX_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(CORTEX_ROOT))

try:
    from src.tier1.working_memory import WorkingMemory
    from src.tier2.knowledge_graph import KnowledgeGraph
except ImportError as e:
    print(f"[ERROR] Failed to import CORTEX modules: {e}")
    sys.exit(1)


class FeatureCapture:
    """Smart context feature capture"""
    
    def __init__(self, repo_path: Optional[Path] = None):
        """Initialize feature capture"""
        self.repo_path = repo_path or Path.cwd()
        self.brain_path = self.repo_path / "cortex-brain"
        
        if not self.brain_path.exists():
            print(f"[ERROR] CORTEX brain not found at: {self.brain_path}")
            sys.exit(1)
        
        self.tier1 = WorkingMemory(self.brain_path)
        self.tier2 = KnowledgeGraph(self.brain_path)
    
    def capture_feature(self, description: str, 
                        components: Optional[List[str]] = None,
                        tests_added: bool = False) -> bool:
        """
        Capture feature with smart context
        
        Args:
            description: Feature description
            components: Components affected
            tests_added: Whether tests were added
        
        Returns:
            bool: True if successful
        """
        try:
            start_time = datetime.now()
            
            # Gather smart context
            context = self._gather_smart_context()
            
            # Create feature record
            feature = {
                "description": description,
                "components": components or context.get("components", []),
                "files_changed": context.get("files_changed", []),
                "tests_added": tests_added,
                "timestamp": datetime.now().isoformat(),
                "git_commit": context.get("git_commit"),
                "branch": context.get("branch")
            }
            
            # Store in Tier 1
            conversation = {
                "role": "user",
                "content": f"FEATURE: {description}",
                "metadata": {
                    "type": "feature",
                    "feature": feature,
                    "source": "cortex-feature"
                }
            }
            
            feature_id = self.tier1.add_conversation(conversation)
            
            # Extract patterns for knowledge graph
            self._extract_feature_patterns(feature)
            
            elapsed = (datetime.now() - start_time).total_seconds()
            
            print(f"‚ú® Feature captured in {elapsed:.2f}s")
            print(f"   ID: {feature_id}")
            print(f"   Files: {len(feature['files_changed'])}")
            if tests_added:
                print(f"   ‚úÖ Tests included")
            
            return True
            
        except Exception as e:
            print(f"‚ùå Failed to capture feature: {e}")
            return False
    
    def interactive_capture(self) -> bool:
        """Interactive feature capture"""
        print("\n=== CORTEX Feature Capture ===\n")
        
        # Description
        description = input("Feature description: ").strip()
        if not description:
            print("‚ùå Description required")
            return False
        
        # Components
        print("\nComponents (comma-separated, or Enter for auto-detect):")
        components_input = input("Components: ").strip()
        components = None
        if components_input:
            components = [c.strip() for c in components_input.split(",")]
        
        # Tests
        tests = input("\nTests added? [y/N]: ").strip().lower() == 'y'
        
        # Show context
        context = self._gather_smart_context()
        if context.get("files_changed"):
            print(f"\nüìÅ Detected {len(context['files_changed'])} changed files")
            if len(context['files_changed']) <= 5:
                for f in context['files_changed']:
                    print(f"   - {f}")
        
        if context.get("branch"):
            print(f"üåø Branch: {context['branch']}")
        
        # Confirm
        print(f"\nüìù Capturing feature:")
        print(f"   Description: {description}")
        if components:
            print(f"   Components: {', '.join(components)}")
        print(f"   Tests: {'Yes' if tests else 'No'}")
        
        confirm = input("\nContinue? [Y/n]: ").strip().lower()
        if confirm and confirm != 'y':
            print("‚ùå Cancelled")
            return False
        
        return self.capture_feature(description, components, tests)
    
    def _gather_smart_context(self) -> Dict:
        """Gather smart context about feature"""
        context = {}
        
        try:
            # Git branch
            branch = subprocess.check_output(
                ["git", "branch", "--show-current"],
                cwd=self.repo_path,
                stderr=subprocess.DEVNULL,
                timeout=1
            ).decode().strip()
            context["branch"] = branch
        except:
            pass
        
        try:
            # Changed files
            changed = subprocess.check_output(
                ["git", "diff", "--name-only", "HEAD"],
                cwd=self.repo_path,
                stderr=subprocess.DEVNULL,
                timeout=1
            ).decode().strip().split('\n')
            context["files_changed"] = [f for f in changed if f]
            
            # Detect components from file paths
            components = set()
            for file in context["files_changed"]:
                parts = Path(file).parts
                if len(parts) >= 2:
                    components.add(parts[1])  # src/component or tests/component
            context["components"] = list(components)
        except:
            pass
        
        try:
            # Last commit
            commit = subprocess.check_output(
                ["git", "log", "-1", "--format=%H %s"],
                cwd=self.repo_path,
                stderr=subprocess.DEVNULL,
                timeout=1
            ).decode().strip()
            context["git_commit"] = commit
        except:
            pass
        
        return context
    
    def _extract_feature_patterns(self, feature: Dict) -> None:
        """Extract patterns for knowledge graph"""
        try:
            # Create pattern from feature
            pattern = {
                "type": "feature",
                "description": feature["description"],
                "components": feature["components"],
                "confidence": 0.8,
                "source": "cortex-feature"
            }
            
            self.tier2.add_pattern(pattern)
        except Exception as e:
            print(f"‚ö†Ô∏è  Pattern extraction failed: {e}")


def main():
    """Main entry point"""
    parser = argparse.ArgumentParser(
        description="CORTEX Feature Capture - Smart context feature logging",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  cortex-feature "Added user authentication"
  cortex-feature "Implemented payment system" --tests
  cortex-feature --interactive
        """
    )
    
    parser.add_argument(
        "description",
        nargs="?",
        help="Feature description"
    )
    
    parser.add_argument(
        "--components",
        help="Comma-separated components"
    )
    
    parser.add_argument(
        "--tests", "-t",
        action="store_true",
        help="Tests were added"
    )
    
    parser.add_argument(
        "--interactive", "-i",
        action="store_true",
        help="Interactive mode"
    )
    
    parser.add_argument(
        "--repo",
        type=Path,
        help="Repository path (default: current directory)"
    )
    
    args = parser.parse_args()
    
    # Initialize
    try:
        capture = FeatureCapture(repo_path=args.repo)
    except Exception as e:
        print(f"[ERROR] Failed to initialize: {e}")
        sys.exit(1)
    
    # Execute
    if args.interactive:
        success = capture.interactive_capture()
    elif args.description:
        components = [c.strip() for c in args.components.split(",")] if args.components else None
        success = capture.capture_feature(args.description, components, args.tests)
    else:
        parser.print_help()
        sys.exit(1)
    
    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
