#!/bin/bash
# KDS Post-Commit Hook - Auto BRAIN Update + Health Checks
# Version: 7.0 (Permanent Instinct Operations)
# Installed via: scripts/setup-git-hooks.ps1

# ========================================
# PHASE 1: Critical Health Checks (< 2s)
# ========================================
echo "ðŸ” Running critical health checks..."
pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/health-check-critical.ps1 -Silent

if [ $? -ne 0 ]; then
  echo "âš ï¸  Health check failed - but commit will proceed"
  echo "   Run: pwsh -File scripts/verify-system-health.ps1"
fi

# ========================================
# PHASE 2: Auto BRAIN Update
# ========================================
# Get commit message
COMMIT_MSG=$(git log -1 --pretty=%B)

# Get files changed
FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | tr '\n' ',' | sed 's/,$//')

# Invoke auto-brain-updater (with throttling)
pwsh -File scripts/auto-brain-updater.ps1 \
    -RequestSummary "Git commit: $COMMIT_MSG" \
    -ResponseType "execute" \
    -AgentInvoked "git-commit" \
    -Silent

# ========================================
# PHASE 3: Tier 1 Auto-Recording
# ========================================
# LAYER 1: Check for Copilot Chat exports
if git diff-tree -r --name-only --no-commit-id HEAD | grep -q ".github/workflows/CopilotChats.txt"; then
  echo "  ðŸ“ Copilot Chat detected - importing to Tier 1..."
  pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/import-copilot-chats.ps1
fi

# LAYER 2: Check for session completions
if git diff-tree -r --name-only --no-commit-id HEAD | grep -q "sessions/.*\.json"; then
  echo "  ðŸ“‹ Session changes detected - checking for completed sessions..."
  # Find session files in this commit
  SESSION_FILES=$(git diff-tree -r --name-only --no-commit-id HEAD | grep "sessions/.*\.json")
  for SESSION_FILE in $SESSION_FILES; do
    if [ -f "$SESSION_FILE" ]; then
      pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/record-session-conversation.ps1 -SessionFile "$SESSION_FILE" 2>/dev/null || true
    fi
  done
fi

# Exit with success (don't block commit)
exit 0
