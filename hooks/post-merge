#!/bin/bash
# KDS Post-Merge Hook - Repository Sync + BRAIN Update  
# Version: 7.0 (Permanent Instinct Operations)
# Installation: Copy to .git/hooks/post-merge and chmod +x

echo "üîÑ KDS Post-Merge Hook - Syncing..."

# 1. Verify we're in KDS repo
REPO_NAME=$(git config --get remote.origin.url | grep -o '[^/]*\.git$' | sed 's/.git$//')

if [ "$REPO_NAME" != "KDS" ]; then
  echo "‚ö†Ô∏è  WARNING: Not in KDS repository (found: $REPO_NAME)"
  echo "This hook is designed for the KDS dedicated repository only"
  exit 0
fi

echo "  ‚úÖ Repository: KDS"

# ========================================
# PHASE 1: Critical Health Checks
# ========================================
echo "  üîç Running critical health checks..."
pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/health-check-critical.ps1 -Silent 2>&1

if [ $? -ne 0 ]; then
  echo "  ‚ö†Ô∏è  Health check failed - review with: pwsh -File scripts/verify-system-health.ps1"
fi

# ========================================
# PHASE 2: BRAIN Update After Merge
# ========================================
echo "  üß† Updating BRAIN after merge..."
pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/update-brain.ps1 -Auto 2>&1

# ========================================
# PHASE 3: Change Detection
# ========================================
# Check if BRAIN files were updated
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q "kds-brain/events.jsonl"; then
  echo "  üìä Events updated - BRAIN refreshed"
fi

# Check for schema changes
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q "schemas/"; then
  echo "  üìã Schema changes detected - validate configurations"
fi

# Check for new crawler implementations
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q "scripts/crawlers/"; then
  echo "  üï∑Ô∏è Crawler changes detected - test before using"
fi

# Check for hook changes
if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -q "hooks/"; then
  echo ""
  echo "  ‚ö†Ô∏è  Git hooks updated - reinstall hooks:"
  echo "     pwsh -File scripts/setup-git-hooks.ps1"
  echo ""
fi

echo "‚úÖ Post-merge sync complete"
echo ""
exit 0