#!/bin/bash
# KDS Branch Validation Hook
# Ensures ONLY KDS/ changes are committed on features/kds branch

BRANCH=$(git branch --show-current)

if [ "$BRANCH" != "features/kds" ]; then
  echo "‚ùå ERROR: KDS changes ONLY allowed on features/kds branch"
  echo ""
  echo "Current branch: $BRANCH"
  echo "Required branch: features/kds"
  echo ""
  echo "To fix:"
  echo "  git checkout features/kds"
  echo "  git cherry-pick <commit-hash>"
  exit 1
fi

# Check if commit touches non-KDS files
NON_KDS_FILES=$(git diff --cached --name-only | grep -v '^\KDS/')

if [ -n "$NON_KDS_FILES" ]; then
  echo "‚ùå ERROR: KDS branch ONLY for KDS/ changes"
  echo ""
  echo "Non-KDS files detected in commit:"
  echo "$NON_KDS_FILES"
  echo ""
  echo "To fix:"
  echo "  1. git reset HEAD <non-kds-file>"
  echo "  2. Commit those files on appropriate branch"
  echo "  3. Return to features/kds for KDS changes"
  exit 1
fi

echo "‚úÖ KDS-only commit validated"
echo "üìÅ Files in commit:"
git diff --cached --name-only | sed 's/^/   - /'
echo ""

# Run KDS light checks (pre-commit fast scan) via PowerShell
REPO_ROOT=$(git rev-parse --show-toplevel)
LIGHT_CHECK_SCRIPT="$REPO_ROOT/KDS/scripts/clean-redundant-files-light.ps1"

if [ -f "$LIGHT_CHECK_SCRIPT" ]; then
  echo "üîé Running KDS light checks..."
  powershell.exe -NoProfile -ExecutionPolicy Bypass -File "$LIGHT_CHECK_SCRIPT"
  EXIT_CODE=$?
  if [ $EXIT_CODE -ne 0 ]; then
    echo "‚ùå Pre-commit light checks failed (see violations above)."
    exit $EXIT_CODE
  fi
  echo "‚úÖ KDS light checks passed"
else
  echo "‚ÑπÔ∏è  KDS light checks script not found: $LIGHT_CHECK_SCRIPT (skipping)"
fi
