<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß† KDS Dashboard</title>
  
  <!-- Chart.js for metrics visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #1e1e1e;
      --bg-secondary: #252526;
      --bg-tertiary: #2d2d30;
      --bg-hover: #37373d;
      
      --success: #4ec9b0;
      --warning: #ce9178;
      --critical: #f48771;
      --info: #007acc;
      --pending: #858585;
      
      --text-primary: #d4d4d4;
      --text-secondary: #858585;
      --text-accent: #4ec9b0;
      
      --border: #3e3e42;
      --border-accent: #007acc;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      background: var(--bg-secondary);
      padding: 24px;
      margin-bottom: 30px;
      border-radius: 8px;
      border-left: 4px solid var(--info);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    h1 {
      font-size: 2em;
      color: var(--text-accent);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--info);
      color: white;
    }

    .btn-primary:hover {
      background: #005a9e;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 122, 204, 0.3);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--info);
    }

    .btn-success {
      background: var(--success);
      color: var(--bg-primary);
    }

    .btn-success:hover {
      background: #3da98a;
      transform: translateY(-2px);
    }

    .header-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: var(--bg-tertiary);
      padding: 16px;
      border-radius: 6px;
      border-left: 3px solid var(--border);
    }

    .stat-label {
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-card.healthy { border-left-color: var(--success); }
    .stat-card.warning { border-left-color: var(--warning); }
    .stat-card.critical { border-left-color: var(--critical); }
    .stat-card.info { border-left-color: var(--info); }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0;
    }

    .nav-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      position: relative;
      transition: all 0.2s;
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .nav-tab.active {
      color: var(--text-accent);
    }

    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--text-accent);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Overview Cards */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .overview-card {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 8px;
      border-left: 4px solid var(--border-accent);
      transition: all 0.2s;
      cursor: pointer;
    }

    .overview-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      border-left-color: var(--text-accent);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 1.2em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-status {
      font-size: 24px;
    }

    .card-stats {
      display: flex;
      gap: 20px;
      margin-top: 12px;
    }

    .card-stat {
      flex: 1;
    }

    .card-stat-label {
      font-size: 0.75em;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-stat-value {
      font-size: 1.5em;
      font-weight: 700;
      margin-top: 4px;
    }

    /* Health Check Section */
    .health-category {
      background: var(--bg-secondary);
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .category-header {
      padding: 20px 24px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
      user-select: none;
    }

    .category-header:hover {
      background: var(--bg-hover);
    }

    .category-title {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 1.1em;
      font-weight: 700;
    }

    .category-progress {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .progress-dots {
      display: flex;
      gap: 6px;
    }

    .progress-text {
      font-size: 0.9em;
      color: var(--text-secondary);
      min-width: 60px;
      text-align: right;
    }

    .expand-icon {
      transition: transform 0.3s;
      color: var(--text-secondary);
    }

    .category-header.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .category-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .category-content.expanded {
      max-height: 2000px;
      transition: max-height 0.5s ease-in;
    }

    .check-list {
      padding: 0 24px 24px;
    }

    .check-item {
      padding: 16px;
      margin-bottom: 8px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s;
    }

    .check-item:hover {
      background: var(--bg-hover);
    }

    .check-item.passed {
      border-left: 3px solid var(--success);
    }

    .check-item.warning {
      border-left: 3px solid var(--warning);
    }

    .check-item.critical {
      border-left: 3px solid var(--critical);
    }

    .check-item.running {
      border-left: 3px solid var(--info);
    }

    .check-item.pending {
      border-left: 3px solid var(--pending);
    }

    /* Status Circles */
    .status-circle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
    }

    .status-circle.pending {
      border: 2px solid var(--pending);
      background: transparent;
    }

    .status-circle.running {
      border: 2px solid var(--info);
      background: var(--info);
      animation: pulse 1.5s infinite;
    }

    .status-circle.passed {
      background: var(--success);
      border: 2px solid var(--success);
    }

    .status-circle.warning {
      background: var(--warning);
      border: 2px solid var(--warning);
      animation: pulse-slow 2s infinite;
    }

    .status-circle.critical {
      background: var(--critical);
      border: 2px solid var(--critical);
      animation: pulse-fast 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes pulse-fast {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.15); }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .status-circle.running::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: var(--info);
      animation: spin 1s linear infinite;
    }

    .check-details {
      flex: 1;
    }

    .check-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .check-status {
      font-size: 0.85em;
      color: var(--text-secondary);
    }

    .check-time {
      font-size: 0.85em;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    /* Recommendations */
    .recommendations {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 8px;
      border-left: 4px solid var(--warning);
      margin-top: 24px;
    }

    .recommendations h3 {
      color: var(--warning);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .recommendation-item {
      background: var(--bg-tertiary);
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 6px;
      display: flex;
      align-items: start;
      gap: 12px;
    }

    .recommendation-item:last-child {
      margin-bottom: 0;
    }

    .recommendation-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .recommendation-content {
      flex: 1;
    }

    .recommendation-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .recommendation-action {
      font-size: 0.85em;
      color: var(--text-secondary);
      font-family: 'Consolas', monospace;
      background: var(--bg-primary);
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 8px;
      display: inline-block;
    }

    /* Activity Log */
    .activity-log {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 8px;
      border-left: 4px solid var(--info);
    }

    .activity-log h3 {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .activity-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 16px;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-time {
      font-size: 0.85em;
      color: var(--text-secondary);
      min-width: 80px;
      flex-shrink: 0;
    }

    .activity-message {
      flex: 1;
    }

    /* Footer */
    footer {
      margin-top: 40px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-critical { color: var(--critical); }
    .text-info { color: var(--info); }
    .text-muted { color: var(--text-secondary); }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }

    .metric-card {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 8px;
      border-left: 4px solid var(--border-accent);
      transition: all 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      border-left-color: var(--text-accent);
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .metric-header h3 {
      font-size: 1.1em;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }

    .metric-value {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--text-accent);
    }

    .metric-card canvas {
      max-height: 300px;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--info);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Progress Bar */
    .progress-bar-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--bg-tertiary);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .progress-bar-container.active {
      opacity: 1;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--info), var(--text-accent));
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px var(--info);
    }

    .progress-bar.indeterminate {
      width: 30%;
      animation: progress-indeterminate 1.5s ease-in-out infinite;
    }

    @keyframes progress-indeterminate {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(400%); }
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 30, 30, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      flex-direction: column;
      gap: 20px;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-message {
      font-size: 1.2em;
      color: var(--text-accent);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .loading-details {
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    /* Refresh Button Animation */
    .btn-primary.refreshing {
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-primary.refreshing::before {
      content: 'üîÑ';
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <!-- Progress Bar -->
  <div class="progress-bar-container" id="progressBar">
    <div class="progress-bar indeterminate"></div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner" style="width: 60px; height: 60px; border-width: 6px;"></div>
    <div class="loading-message">
      <span id="loadingIcon">üîÑ</span>
      <span id="loadingText">Loading...</span>
    </div>
    <div class="loading-details" id="loadingDetails">
      Connecting to API server...
    </div>
  </div>

  <div class="container">
    <!-- Header -->
    <header>
      <div class="header-top">
        <h1>
          <span>üß†</span>
          <span>KDS Dashboard</span>
        </h1>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="copyToClipboard()">
            üìã Copy to Clipboard
          </button>
          <button class="btn btn-secondary" onclick="exportReport()">
            üìä Export Report
          </button>
          <button class="btn btn-primary" onclick="refreshDashboard()">
            üîÑ Refresh
          </button>
        </div>
      </div>
      <div class="header-stats" id="headerStats">
        <!-- Dynamic stats populated by JS -->
      </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('overview')">
        üìä Overview
      </button>
      <button class="nav-tab" onclick="switchTab('health')">
        ‚ù§Ô∏è Health Checks
      </button>
      <button class="nav-tab" onclick="switchTab('brain')">
        üß† BRAIN System
      </button>
      <button class="nav-tab" onclick="switchTab('metrics')">
        üìà Metrics
      </button>
      <button class="nav-tab" onclick="switchTab('activity')">
        üìù Activity Log
      </button>
    </div>

    <!-- Tab: Overview -->
    <div id="tab-overview" class="tab-content active">
      <div class="overview-grid" id="overviewGrid">
        <!-- Dynamic cards populated by JS -->
      </div>
    </div>

    <!-- Tab: Health Checks -->
    <div id="tab-health" class="tab-content">
      <div id="healthChecks">
        <!-- Dynamic health check categories populated by JS -->
      </div>
      <div id="recommendations" class="hidden">
        <!-- Dynamic recommendations populated by JS -->
      </div>
    </div>

    <!-- Tab: BRAIN System -->
    <div id="tab-brain" class="tab-content">
      <div class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 16px;">Loading BRAIN metrics...</p>
      </div>
    </div>

    <!-- Tab: Activity Log -->
    <div id="tab-activity" class="tab-content">
      <div class="activity-log">
        <h3>üìù Recent Activity</h3>
        <div id="activityList">
          <!-- Dynamic activity items populated by JS -->
        </div>
      </div>
    </div>

    <!-- Tab: Metrics -->
    <div id="tab-metrics" class="tab-content">
      <div class="metrics-grid">
        <!-- BRAIN Health Score -->
        <div class="metric-card">
          <div class="metric-header">
            <h3>üß† BRAIN Health Score</h3>
            <span class="metric-value" id="brainHealthValue">--</span>
          </div>
          <canvas id="brainHealthChart"></canvas>
        </div>

        <!-- Routing Accuracy -->
        <div class="metric-card">
          <div class="metric-header">
            <h3>üéØ Routing Accuracy</h3>
            <span class="metric-value" id="routingAccuracyValue">--</span>
          </div>
          <canvas id="routingAccuracyChart"></canvas>
        </div>

        <!-- Knowledge Graph Growth -->
        <div class="metric-card">
          <div class="metric-header">
            <h3>üìö Knowledge Graph Growth</h3>
            <span class="metric-value" id="knowledgeGrowthValue">--</span>
          </div>
          <canvas id="knowledgeGrowthChart"></canvas>
        </div>

        <!-- File Hotspots -->
        <div class="metric-card">
          <div class="metric-header">
            <h3>üî• File Hotspots</h3>
            <span class="metric-value" id="fileHotspotsValue">--</span>
          </div>
          <canvas id="fileHotspotsChart"></canvas>
        </div>

        <!-- Event Activity -->
        <div class="metric-card">
          <div class="metric-header">
            <h3>üìä Event Activity (30 days)</h3>
            <span class="metric-value" id="eventActivityValue">--</span>
          </div>
          <canvas id="eventActivityChart"></canvas>
        </div>

        <!-- Test Success Rate -->
        <div class="metric-card">
          <div class="metric-header">
            <h3>‚úÖ Test Success Rate</h3>
            <span class="metric-value" id="testSuccessValue">--</span>
          </div>
          <canvas id="testSuccessChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <p>KDS Dashboard v1.0 | Workspace: NOOR CANVAS</p>
      <p>Last Updated: <span id="lastUpdate">Loading...</span></p>
    </footer>
  </div>

  <script>
    // ==========================================
    // State Management
    // ==========================================
    const state = {
      currentTab: 'overview',
      lastRefresh: null,
      autoRefresh: true,
      refreshInterval: 30000, // 30 seconds
      healthCategories: [],
      overallStatus: 'UNKNOWN',
      stats: {
        passed: 0,
        totalChecks: 0,
        warnings: 0,
        critical: 0
      },
      apiUrl: 'http://localhost:8765',
      healthData: null,
      apiConnected: false,
      isLoading: false
    };

    // ==========================================
    // UI Feedback Utilities
    // ==========================================
    function showProgressBar() {
      const progressBar = document.getElementById('progressBar');
      progressBar.classList.add('active');
    }

    function hideProgressBar() {
      const progressBar = document.getElementById('progressBar');
      progressBar.classList.remove('active');
    }

    function showLoadingOverlay(message = 'Loading...', details = '') {
      state.isLoading = true;
      const overlay = document.getElementById('loadingOverlay');
      const textElem = document.getElementById('loadingText');
      const detailsElem = document.getElementById('loadingDetails');
      
      textElem.textContent = message;
      detailsElem.textContent = details;
      overlay.classList.add('active');
    }

    function hideLoadingOverlay() {
      state.isLoading = false;
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.remove('active');
    }

    function setRefreshButtonState(isRefreshing) {
      const btn = document.querySelector('.btn-primary');
      if (isRefreshing) {
        btn.classList.add('refreshing');
        btn.disabled = true;
      } else {
        btn.classList.remove('refreshing');
        btn.disabled = false;
      }
    }

    function resetStatsToZero() {
      state.stats = {
        passed: 0,
        totalChecks: 0,
        warnings: 0,
        critical: 0
      };
      state.overallStatus = 'UNKNOWN';
      renderHeaderStats();
    }

    // ==========================================
    // Health Check Definitions (Removed - Using API Data Only)
    // ==========================================
    // Categories are now loaded from the API server dynamically

    // ==========================================
    // Tab Switching
    // ==========================================
    function switchTab(tabName) {
      // Update state
      state.currentTab = tabName;

      // Update tab buttons
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Load tab-specific data
      if (tabName === 'health') {
        renderHealthChecks();
      } else if (tabName === 'brain') {
        loadBRAINMetrics();
      } else if (tabName === 'metrics') {
        loadMetrics();
      } else if (tabName === 'activity') {
        loadActivityLog();
      }
    }

    // ==========================================
    // Overview Rendering
    // ==========================================
    function renderOverview() {
      const grid = document.getElementById('overviewGrid');
      
      if (!state.apiConnected || !state.healthData) {
        grid.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîå</div>
            <h2 style="color: var(--text-secondary); margin-bottom: 12px;">API Server Not Connected</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
              Please start the KDS API server to view health data.
            </p>
            <code style="background: var(--bg-secondary); padding: 12px 24px; border-radius: 6px; display: inline-block;">
              .\\KDS\\scripts\\launch-dashboard.ps1
            </code>
            <div style="margin-top: 24px;">
              <button class="btn btn-primary" onclick="refreshDashboard()">
                üîÑ Retry Connection
              </button>
            </div>
          </div>
        `;
        return;
      }
      
      // Build overview cards from real API data
      const overviewCards = state.healthData.categories.map(category => {
        const totalChecks = category.checks.length;
        const passedChecks = category.checks.filter(c => c.status === 'passed').length;
        const warningChecks = category.checks.filter(c => c.status === 'warning').length;
        const criticalChecks = category.checks.filter(c => c.status === 'critical').length;
        
        let status = '‚úÖ';
        let color = 'var(--success)';
        
        if (criticalChecks > 0) {
          status = '‚ùå';
          color = 'var(--critical)';
        } else if (warningChecks > 0) {
          status = '‚ö†Ô∏è';
          color = 'var(--warning)';
        }
        
        const healthPercent = Math.round((passedChecks / totalChecks) * 100);
        
        return {
          icon: category.icon,
          title: category.name,
          status: status,
          color: color,
          stats: [
            { label: 'Passed', value: `${passedChecks}/${totalChecks}` },
            { label: 'Health', value: `${healthPercent}%` }
          ],
          onclick: `switchTab('health'); expandCategory('${category.id}')`
        };
      });

      grid.innerHTML = overviewCards.map(card => `
        <div class="overview-card" onclick="${card.onclick}">
          <div class="card-header">
            <div class="card-title">
              <span>${card.icon}</span>
              <span>${card.title}</span>
            </div>
            <div class="card-status">${card.status}</div>
          </div>
          <div class="card-stats">
            ${card.stats.map(stat => `
              <div class="card-stat">
                <div class="card-stat-label">${stat.label}</div>
                <div class="card-stat-value" style="color: ${card.color}">${stat.value}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // ==========================================
    // Health Check Rendering
    // ==========================================
    function renderHealthChecks() {
      const container = document.getElementById('healthChecks');
      
      if (!state.apiConnected || !state.healthData) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîå</div>
            <h2 style="color: var(--text-secondary); margin-bottom: 12px;">No Health Data Available</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
              Connect to the API server to view health checks.
            </p>
            <button class="btn btn-primary" onclick="refreshDashboard()">
              üîÑ Retry Connection
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = state.healthData.categories.map(category => {
        const totalChecks = category.checks.length;
        const passedChecks = category.checks.filter(c => c.status === 'passed').length;
        
        return `
          <div class="health-category">
            <div class="category-header" onclick="toggleCategory('${category.id}')">
              <div class="category-title">
                <span>${category.icon}</span>
                <span>${category.name}</span>
              </div>
              <div class="category-progress">
                <div class="progress-dots" id="progress-${category.id}">
                  ${category.checks.map(check => `
                    <div class="status-circle ${check.status}"></div>
                  `).join('')}
                </div>
                <span class="progress-text" id="progress-text-${category.id}">${passedChecks}/${totalChecks}</span>
                <span class="expand-icon">‚ñº</span>
              </div>
            </div>
            <div class="category-content" id="content-${category.id}">
              <div class="check-list">
                ${category.checks.map((check, idx) => `
                  <div class="check-item ${check.status}" id="check-${category.id}-${idx}">
                    <div class="status-circle ${check.status}" id="circle-${category.id}-${idx}"></div>
                    <div class="check-details">
                      <div class="check-name">${check.name}</div>
                      <div class="check-status">${check.message}</div>
                    </div>
                    <div class="check-time" id="time-${category.id}-${idx}">
                      ${check.timestamp ? new Date(check.timestamp).toLocaleTimeString() : 'N/A'}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleCategory(categoryId) {
      const header = event.currentTarget;
      const content = document.getElementById(`content-${categoryId}`);
      
      header.classList.toggle('expanded');
      content.classList.toggle('expanded');
    }

    function expandCategory(categoryId) {
      const header = document.querySelector(`#content-${categoryId}`).previousElementSibling;
      const content = document.getElementById(`content-${categoryId}`);
      
      header.classList.add('expanded');
      content.classList.add('expanded');
    }

    // ==========================================
    // Run Health Checks
    // ==========================================
    async function runHealthChecks() {
      showProgressBar();
      showLoadingOverlay('Running Health Checks...', 'Connecting to API server...');
      resetStatsToZero();
      
      try {
        // Check if API is available
        updateLoadingMessage('Checking API Connection...', 'http://localhost:8765');
        const statusResponse = await fetch(`${state.apiUrl}/api/status`, { 
          signal: AbortSignal.timeout(5000) 
        });
        
        if (!statusResponse.ok) {
          throw new Error('API server not responding');
        }
        
        // Run health checks
        updateLoadingMessage('Running Health Checks...', 'This may take a few moments...');
        const response = await fetch(`${state.apiUrl}/api/health`, { 
          signal: AbortSignal.timeout(30000) 
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.statusText}`);
        }
        
        updateLoadingMessage('Processing Results...', 'Updating dashboard...');
        const data = await response.json();
        
        // Update state
        state.healthData = data;
        state.apiConnected = true;
        state.overallStatus = data.overallStatus || 'UNKNOWN';
        state.stats = data.stats || {
          passed: 0,
          totalChecks: 0,
          warnings: 0,
          critical: 0
        };
        
        // Update UI with real results
        renderHealthChecks();
        updateHeaderStatsFromData(data);
        
        // Show recommendations if any
        if (data.recommendations && data.recommendations.length > 0) {
          showRecommendations(data.recommendations);
        } else {
          document.getElementById('recommendations').classList.add('hidden');
        }
        
        updateLoadingMessage('Complete!', 'Health checks finished successfully');
        await sleep(500); // Brief pause to show completion
        
      } catch (error) {
        console.error('Health check API error:', error);
        state.apiConnected = false;
        state.healthData = null;
        
        updateLoadingMessage('Connection Failed', error.message);
        await sleep(1000);
        
        // Show error message
        const container = document.getElementById('healthChecks');
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--critical);">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
            <h2 style="color: var(--critical); margin-bottom: 12px;">Connection Failed</h2>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">
              ${error.message}
            </p>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
              Please ensure the KDS API server is running.
            </p>
            <code style="background: var(--bg-primary); padding: 12px 24px; border-radius: 6px; display: inline-block; margin-bottom: 24px;">
              .\\KDS\\scripts\\launch-dashboard.ps1
            </code>
            <div>
              <button class="btn btn-primary" onclick="refreshDashboard()">
                üîÑ Retry Connection
              </button>
            </div>
          </div>
        `;
        
        updateHeaderStats();
      } finally {
        hideProgressBar();
        hideLoadingOverlay();
      }
    }

    function updateLoadingMessage(text, details) {
      const textElem = document.getElementById('loadingText');
      const detailsElem = document.getElementById('loadingDetails');
      
      textElem.textContent = text;
      detailsElem.textContent = details;
    }

    function showRecommendations(recommendations) {
      const container = document.getElementById('recommendations');
      
      container.innerHTML = `
        <div class="recommendations">
          <h3>‚ö†Ô∏è Recommendations</h3>
          ${recommendations.map(rec => `
            <div class="recommendation-item">
              <div class="recommendation-icon">üí°</div>
              <div class="recommendation-content">
                <div class="recommendation-title">${rec.category} ‚Üí ${rec.check}</div>
                <div class="recommendation-action">${rec.action}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      container.classList.remove('hidden');
    }

    // ==========================================
    // Header Stats
    // ==========================================
    function renderHeaderStats() {
      const stats = document.getElementById('headerStats');
      
      const mode = state.apiConnected ? 'üîó Live' : 'üîå Disconnected';
      const modeClass = state.apiConnected ? 'success' : 'critical';
      
      stats.innerHTML = `
        <div class="stat-card ${getStatusClass(state.overallStatus)}">
          <div class="stat-label">Overall Status</div>
          <div class="stat-value text-${getStatusClass(state.overallStatus)}">${getStatusEmoji(state.overallStatus)} ${state.overallStatus}</div>
        </div>
        <div class="stat-card ${modeClass}">
          <div class="stat-label">Connection</div>
          <div class="stat-value text-${modeClass}">${mode}</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Checks Passed</div>
          <div class="stat-value text-info">${state.stats.passed || 0} / ${state.stats.totalChecks || 0}</div>
        </div>
        <div class="stat-card ${state.stats.warnings > 0 ? 'warning' : 'info'}">
          <div class="stat-label">Warnings</div>
          <div class="stat-value text-${state.stats.warnings > 0 ? 'warning' : 'info'}">${state.stats.warnings || 0}</div>
        </div>
      `;
    }
    
    function updateHeaderStatsFromData(data) {
      state.overallStatus = data.overallStatus || 'UNKNOWN';
      state.stats = data.stats || {};
      renderHeaderStats();
    }
    
    function updateHeaderStats() {
      renderHeaderStats();
    }
    
    function getStatusClass(status) {
      switch (status) {
        case 'HEALTHY': return 'healthy';
        case 'DEGRADED': return 'warning';
        case 'CRITICAL': return 'critical';
        default: return 'info';
      }
    }
    
    function getStatusEmoji(status) {
      switch (status) {
        case 'HEALTHY': return '‚úÖ';
        case 'DEGRADED': return '‚ö†Ô∏è';
        case 'CRITICAL': return '‚ùå';
        default: return '‚ùì';
      }
    }

    // ==========================================
    // BRAIN Metrics
    // ==========================================
    async function loadBRAINMetrics() {
      const container = document.getElementById('tab-brain');
      
      // Show loading state
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 16px;">Loading BRAIN metrics...</p></div>';
      
      if (!state.apiConnected || !state.healthData) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîå</div>
            <h2 style="color: var(--text-secondary); margin-bottom: 12px;">API Server Not Connected</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
              Connect to the API server to view BRAIN metrics.
            </p>
            <button class="btn btn-primary" onclick="refreshDashboard()">
              üîÑ Retry Connection
            </button>
          </div>
        `;
        return;
      }
      
      try {
        // Get BRAIN-specific data from the health data
        const brainCategory = state.healthData.categories.find(c => c.id === 'brain');
        
        if (!brainCategory) {
          throw new Error('BRAIN category not found in health data');
        }
        
        renderBRAINMetricsFromAPI(brainCategory);
        
      } catch (error) {
        console.error('Could not load BRAIN metrics:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--critical);">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
            <h2 style="color: var(--critical); margin-bottom: 12px;">Error Loading BRAIN Metrics</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
              ${error.message}
            </p>
            <button class="btn btn-primary" onclick="loadBRAINMetrics()">
              üîÑ Retry
            </button>
          </div>
        `;
      }
    }
    
    function renderBRAINMetricsFromAPI(brainCategory) {
      const container = document.getElementById('tab-brain');
      
      // Extract integrity checks
      const integrityChecks = brainCategory.checks.filter(c => c.name.startsWith('Integrity:'));
      const overallIntegrity = brainCategory.checks.find(c => c.name === 'Overall Integrity');
      const eventStream = brainCategory.checks.find(c => c.name === 'Event Stream');
      const knowledgeGraph = brainCategory.checks.find(c => c.name === 'Knowledge Graph');
      
      // Count check statuses
      const passedCount = integrityChecks.filter(c => c.status === 'passed').length;
      const warningCount = integrityChecks.filter(c => c.status === 'warning').length;
      const criticalCount = integrityChecks.filter(c => c.status === 'critical').length;
      
      container.innerHTML = `
        <div class="overview-grid" style="margin-bottom: 24px;">
          <div class="overview-card">
            <div class="card-header">
              <div class="card-title">
                <span>üîç</span>
                <span>Integrity Status</span>
              </div>
              <div class="card-status">${overallIntegrity?.status === 'passed' ? '‚úÖ' : '‚ùå'}</div>
            </div>
            <div class="card-stats">
              <div class="card-stat">
                <div class="card-stat-label">Passed</div>
                <div class="card-stat-value" style="color: var(--success)">${passedCount}</div>
              </div>
              <div class="card-stat">
                <div class="card-stat-label">Issues</div>
                <div class="card-stat-value" style="color: ${criticalCount > 0 ? 'var(--critical)' : 'var(--warning)'}">
                  ${criticalCount + warningCount}
                </div>
              </div>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-header">
              <div class="card-title">
                <span>üìä</span>
                <span>Event Stream</span>
              </div>
              <div class="card-status">${eventStream?.status === 'passed' ? '‚úÖ' : '‚ö†Ô∏è'}</div>
            </div>
            <div class="card-stats">
              <div class="card-stat">
                <div class="card-stat-label">Status</div>
                <div class="card-stat-value" style="color: var(--${eventStream?.status === 'passed' ? 'success' : 'warning'})">${eventStream?.message || 'Unknown'}</div>
              </div>
            </div>
          </div>
          
          <div class="overview-card">
            <div class="card-header">
              <div class="card-title">
                <span>üß†</span>
                <span>Knowledge Graph</span>
              </div>
              <div class="card-status">${knowledgeGraph?.status === 'passed' ? '‚úÖ' : '‚ö†Ô∏è'}</div>
            </div>
            <div class="card-stats">
              <div class="card-stat">
                <div class="card-stat-label">Status</div>
                <div class="card-stat-value" style="color: var(--${knowledgeGraph?.status === 'passed' ? 'success' : 'warning'})">${knowledgeGraph?.message || 'Unknown'}</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="health-category" style="margin-bottom: 20px;">
          <div class="category-header expanded" onclick="toggleCategory('brain-integrity')">
            <div class="category-title">
              <span>üîç</span>
              <span>BRAIN Integrity Checks (${integrityChecks.length} Tests)</span>
            </div>
            <div class="category-progress">
              <span class="progress-text">${passedCount}/${integrityChecks.length}</span>
              <span class="expand-icon">‚ñº</span>
            </div>
          </div>
          <div class="category-content expanded" id="content-brain-integrity">
            <div class="check-list">
              ${integrityChecks.map((check, idx) => {
                const cleanName = check.name.replace('Integrity: ', '');
                return `
                  <div class="check-item ${check.status}">
                    <div class="status-circle ${check.status}"></div>
                    <div class="check-details">
                      <div class="check-name">${cleanName}</div>
                      <div class="check-status">${check.message}</div>
                    </div>
                    <div class="check-time">${check.status === 'passed' ? 'Passed' : check.status === 'warning' ? 'Warning' : 'Failed'}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
        
        ${criticalCount > 0 || warningCount > 0 ? `
          <div class="recommendations">
            <h3>‚ö†Ô∏è BRAIN Issues Detected</h3>
            ${integrityChecks.filter(c => c.status !== 'passed').map(check => `
              <div class="recommendation-item">
                <div class="recommendation-icon">${check.status === 'critical' ? 'üî¥' : '‚ö†Ô∏è'}</div>
                <div class="recommendation-content">
                  <div class="recommendation-title">${check.name.replace('Integrity: ', '')}</div>
                  <div class="recommendation-action">Run: .\\KDS\\tests\\test-brain-integrity.ps1 -Verbose</div>
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;
    }

    // ==========================================
    // Metrics Visualization
    // ==========================================
    let metricsCharts = {};
    
    async function loadMetrics() {
      if (!state.apiConnected) {
        showMetricsError('API server not connected');
        return;
      }
      
      // Remove any error overlay
      const errorOverlay = document.getElementById('metrics-error-overlay');
      if (errorOverlay) {
        errorOverlay.remove();
      }
      
      try {
        const response = await fetch(`${state.apiUrl}/api/metrics`);
        if (!response.ok) {
          throw new Error(`API error: ${response.statusText}`);
        }
        
        const metrics = await response.json();
        
        // Render all charts
        renderBRAINHealthChart(metrics.brainHealth);
        renderRoutingAccuracyChart(metrics.routingAccuracy);
        renderKnowledgeGrowthChart(metrics.knowledgeGraph);
        renderFileHotspotsChart(metrics.fileHotspots);
        renderEventActivityChart(metrics.eventActivity);
        renderTestSuccessChart(metrics.testSuccess);
        
      } catch (error) {
        console.error('Failed to load metrics:', error);
        showMetricsError(error.message);
      }
    }
    
    function showMetricsError(message) {
      const container = document.getElementById('tab-metrics');
      if (!container) return;
      
      // Create error overlay instead of replacing content
      const errorOverlay = document.createElement('div');
      errorOverlay.id = 'metrics-error-overlay';
      errorOverlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      `;
      errorOverlay.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
          <h2 style="color: var(--text-secondary); margin-bottom: 12px;">Metrics Unavailable</h2>
          <p style="color: var(--text-secondary); margin-bottom: 24px;">${message}</p>
          <button class="btn btn-primary" onclick="document.getElementById('metrics-error-overlay')?.remove(); loadMetrics();">
            üîÑ Retry
          </button>
        </div>
      `;
      
      // Remove any existing error overlay
      const existingOverlay = document.getElementById('metrics-error-overlay');
      if (existingOverlay) {
        existingOverlay.remove();
      }
      
      // Add overlay without destroying chart elements
      container.style.position = 'relative';
      container.appendChild(errorOverlay);
    }
    
    function renderBRAINHealthChart(data) {
      const canvas = document.getElementById('brainHealthChart');
      const valueElem = document.getElementById('brainHealthValue');
      
      if (!canvas || !valueElem) {
        console.error('BRAIN Health chart elements not found');
        return;
      }
      
      valueElem.textContent = `${data.score}%`;
      valueElem.style.color = data.score >= 90 ? 'var(--success)' : 
                              data.score >= 70 ? 'var(--warning)' : 'var(--critical)';
      
      // Destroy existing chart
      if (metricsCharts.brainHealth) {
        metricsCharts.brainHealth.destroy();
      }
      
      metricsCharts.brainHealth = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels: ['Health Score', 'Remaining'],
          datasets: [{
            data: [data.score, 100 - data.score],
            backgroundColor: [
              data.score >= 90 ? '#4ec9b0' : data.score >= 70 ? '#ce9178' : '#f48771',
              '#3e3e42'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.label}: ${context.parsed}%`
              }
            }
          }
        }
      });
    }
    
    function renderRoutingAccuracyChart(data) {
      const canvas = document.getElementById('routingAccuracyChart');
      const valueElem = document.getElementById('routingAccuracyValue');
      
      if (!canvas || !valueElem) {
        console.error('Routing Accuracy chart elements not found');
        return;
      }
      
      valueElem.textContent = `${data.overall}%`;
      
      if (metricsCharts.routingAccuracy) {
        metricsCharts.routingAccuracy.destroy();
      }
      
      const intents = Object.keys(data.byIntent);
      const values = Object.values(data.byIntent);
      
      metricsCharts.routingAccuracy = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: intents,
          datasets: [{
            label: 'Accuracy %',
            data: values,
            backgroundColor: '#007acc',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#858585' },
              grid: { color: '#3e3e42' }
            },
            x: {
              ticks: { color: '#858585' },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
    
    function renderKnowledgeGrowthChart(data) {
      const canvas = document.getElementById('knowledgeGrowthChart');
      const valueElem = document.getElementById('knowledgeGrowthValue');
      
      if (!canvas || !valueElem) {
        console.error('Knowledge Growth chart elements not found');
        return;
      }
      
      valueElem.textContent = data.totalEntries;
      
      if (metricsCharts.knowledgeGrowth) {
        metricsCharts.knowledgeGrowth.destroy();
      }
      
      // Generate sample growth data (last 7 days)
      const labels = [];
      const values = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        values.push(Math.max(0, data.totalEntries - (i * 50)));
      }
      
      metricsCharts.knowledgeGrowth = new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Entries',
            data: values,
            borderColor: '#4ec9b0',
            backgroundColor: 'rgba(78, 201, 176, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#858585' },
              grid: { color: '#3e3e42' }
            },
            x: {
              ticks: { color: '#858585' },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
    
    function renderFileHotspotsChart(data) {
      const canvas = document.getElementById('fileHotspotsChart');
      const valueElem = document.getElementById('fileHotspotsValue');
      
      if (!canvas || !valueElem) {
        console.error('File Hotspots chart elements not found');
        return;
      }
      
      valueElem.textContent = data.length;
      
      if (metricsCharts.fileHotspots) {
        metricsCharts.fileHotspots.destroy();
      }
      
      const files = data.map(h => h.file.split('/').pop());
      const churns = data.map(h => h.churn);
      
      metricsCharts.fileHotspots = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: files,
          datasets: [{
            label: 'Churn %',
            data: churns,
            backgroundColor: churns.map(c => c > 20 ? '#f48771' : c > 10 ? '#ce9178' : '#4ec9b0'),
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#858585' },
              grid: { color: '#3e3e42' }
            },
            y: {
              ticks: { color: '#858585', font: { size: 11 } },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
    
    function renderEventActivityChart(data) {
      const canvas = document.getElementById('eventActivityChart');
      const valueElem = document.getElementById('eventActivityValue');
      
      if (!canvas || !valueElem) {
        console.error('Event Activity chart elements not found');
        return;
      }
      
      valueElem.textContent = data.total;
      
      if (metricsCharts.eventActivity) {
        metricsCharts.eventActivity.destroy();
      }
      
      const labels = data.last30Days.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const counts = data.last30Days.map(d => d.count);
      
      metricsCharts.eventActivity = new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['No data'],
          datasets: [{
            label: 'Events',
            data: counts.length > 0 ? counts : [0],
            borderColor: '#007acc',
            backgroundColor: 'rgba(0, 122, 204, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#858585' },
              grid: { color: '#3e3e42' }
            },
            x: {
              ticks: { color: '#858585', maxRotation: 45 },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
    
    function renderTestSuccessChart(data) {
      const canvas = document.getElementById('testSuccessChart');
      const valueElem = document.getElementById('testSuccessValue');
      
      if (!canvas || !valueElem) {
        console.error('Test Success chart elements not found');
        return;
      }
      
      valueElem.textContent = `${data.rate}%`;
      
      if (metricsCharts.testSuccess) {
        metricsCharts.testSuccess.destroy();
      }
      
      // Handle zero data
      if (data.total === 0) {
        metricsCharts.testSuccess = new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: ['No Tests'],
            datasets: [{
              data: [1],
              backgroundColor: ['#3e3e42'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '70%',
            plugins: {
              legend: { display: false }
            }
          }
        });
        return;
      }
      
      metricsCharts.testSuccess = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels: ['Passed', 'Failed'],
          datasets: [{
            data: [data.passed, data.total - data.passed],
            backgroundColor: ['#4ec9b0', '#f48771'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: { 
              display: true,
              position: 'bottom',
              labels: { color: '#d4d4d4' }
            }
          }
        }
      });
    }

    // ==========================================
    // Activity Log
    // ==========================================
    async function loadActivityLog() {
      const container = document.getElementById('activityList');
      
      if (!state.apiConnected || !state.healthData) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîå</div>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
              Connect to the API server to view activity logs.
            </p>
            <button class="btn btn-primary" onclick="refreshDashboard()">
              üîÑ Retry Connection
            </button>
          </div>
        `;
        return;
      }
      
      // Try to load activity from API
      try {
        const response = await fetch(`${state.apiUrl}/api/activity`);
        if (response.ok) {
          const activities = await response.json();
          
          if (activities && activities.length > 0) {
            container.innerHTML = activities.map(activity => `
              <div class="activity-item">
                <div class="activity-time">${activity.time}</div>
                <div class="activity-message">${activity.message}</div>
              </div>
            `).join('');
            return;
          }
        }
      } catch (error) {
        console.warn('Could not load activity log from API:', error);
      }
      
      // Fallback: show message
      container.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <p style="color: var(--text-secondary);">
            No activity data available from the API server.
          </p>
        </div>
      `;
    }

    // ==========================================
    // Actions
    // ==========================================
    async function refreshDashboard() {
      if (state.isLoading) {
        console.log('Already refreshing, ignoring request');
        return;
      }
      
      setRefreshButtonState(true);
      state.lastRefresh = new Date();
      updateLastUpdateTime();
      
      // Reset stats to zero before refresh
      resetStatsToZero();
      
      // Try to fetch fresh data from API
      await runHealthChecks();
      
      // Refresh current tab
      if (state.currentTab === 'overview') {
        renderOverview();
      } else if (state.currentTab === 'health') {
        renderHealthChecks();
      } else if (state.currentTab === 'brain') {
        loadBRAINMetrics();
      } else if (state.currentTab === 'activity') {
        loadActivityLog();
      }
      
      renderHeaderStats();
      setRefreshButtonState(false);
    }

    async function copyToClipboard() {
      if (!state.healthData) {
        alert('No health data available to copy. Please run health checks first (click Refresh).');
        return;
      }
      
      // Build comprehensive metrics analysis
      const metricsAnalysis = generateMetricsAnalysis();
      
      const report = {
        timestamp: new Date().toISOString(),
        status: state.overallStatus,
        stats: state.stats,
        apiConnected: state.apiConnected,
        categories: state.healthData.categories,
        recommendations: state.healthData.recommendations || [],
        metricsAnalysis: metricsAnalysis
      };
      
      const jsonText = JSON.stringify(report, null, 2);
      
      try {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(jsonText);
        } else {
          // Fallback for non-HTTPS or older browsers
          const textArea = document.createElement('textarea');
          textArea.value = jsonText;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          try {
            document.execCommand('copy');
            textArea.remove();
          } catch (err) {
            textArea.remove();
            throw err;
          }
        }
        
        // Visual feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úÖ Copied!';
        btn.style.background = 'var(--success)';
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = '';
        }, 2000);
        
      } catch (error) {
        console.error('Failed to copy to clipboard:', error);
        
        // Show the JSON in a prompt as last resort
        prompt('Copy this JSON (Ctrl+C):', jsonText);
      }
    }

    function exportReport() {
      if (!state.healthData) {
        alert('No health data available to export. Please connect to the API server first.');
        return;
      }
      
      // Build comprehensive metrics analysis
      const metricsAnalysis = generateMetricsAnalysis();
      
      const report = {
        timestamp: new Date().toISOString(),
        status: state.overallStatus,
        stats: state.stats,
        categories: state.healthData.categories,
        recommendations: state.healthData.recommendations || [],
        metricsAnalysis: metricsAnalysis
      };
      
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kds-health-report-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateLastUpdateTime() {
      const elem = document.getElementById('lastUpdate');
      if (state.lastRefresh) {
        elem.textContent = state.lastRefresh.toLocaleString();
      } else {
        elem.textContent = new Date().toLocaleString();
      }
    }

    function generateMetricsAnalysis() {
      const analysis = {
        summary: {
          generated: new Date().toISOString(),
          overallHealth: state.overallStatus,
          healthScore: calculateHealthScore()
        },
        brainMetrics: extractBRAINMetrics(),
        learningMetrics: extractLearningMetrics(),
        performanceMetrics: extractPerformanceMetrics(),
        insights: generateInsights()
      };
      
      return analysis;
    }

    function calculateHealthScore() {
      if (!state.stats) return 0;
      const total = state.stats.totalChecks || 1;
      const passed = state.stats.passed || 0;
      return Math.round((passed / total) * 100);
    }

    function extractBRAINMetrics() {
      const brainCategory = state.healthData?.categories?.find(c => c.name === 'BRAIN System');
      if (!brainCategory) return { available: false };

      const integrityChecks = brainCategory.checks.filter(c => c.name.startsWith('Integrity:'));
      const passedCount = integrityChecks.filter(c => c.status === 'passed').length;
      
      return {
        available: true,
        integrityScore: Math.round((passedCount / integrityChecks.length) * 100),
        totalIntegrityChecks: integrityChecks.length,
        passedIntegrityChecks: passedCount,
        checks: integrityChecks.map(c => ({
          name: c.name.replace('Integrity: ', ''),
          status: c.status,
          message: c.message
        }))
      };
    }

    function extractLearningMetrics() {
      const brainCategory = state.healthData?.categories?.find(c => c.name === 'BRAIN System');
      if (!brainCategory) return { available: false };

      // Extract knowledge graph data from checks
      const kgCheck = brainCategory.checks.find(c => c.name === 'Knowledge Graph');
      const eventCheck = brainCategory.checks.find(c => c.name === 'Event Stream');
      
      return {
        available: true,
        knowledgeGraph: {
          status: kgCheck?.status || 'unknown',
          message: kgCheck?.message || 'No data'
        },
        eventStream: {
          status: eventCheck?.status || 'unknown',
          message: eventCheck?.message || 'No data'
        }
      };
    }

    function extractPerformanceMetrics() {
      const perfCategory = state.healthData?.categories?.find(c => c.name === 'Performance');
      if (!perfCategory) return { available: false };

      return {
        available: true,
        checks: perfCategory.checks.map(c => ({
          name: c.name,
          status: c.status,
          message: c.message
        }))
      };
    }

    function generateInsights() {
      const insights = [];
      
      // Health score insights
      const healthScore = calculateHealthScore();
      if (healthScore === 100) {
        insights.push({
          type: 'success',
          category: 'overall',
          message: 'üü¢ Perfect health - all systems operational'
        });
      } else if (healthScore >= 90) {
        insights.push({
          type: 'info',
          category: 'overall',
          message: 'üü° Excellent health with minor issues'
        });
      } else if (healthScore >= 75) {
        insights.push({
          type: 'warning',
          category: 'overall',
          message: 'üü† Good health but attention needed'
        });
      } else {
        insights.push({
          type: 'critical',
          category: 'overall',
          message: 'üî¥ Critical issues detected - immediate action required'
        });
      }

      // BRAIN-specific insights
      const brainMetrics = extractBRAINMetrics();
      if (brainMetrics.available) {
        if (brainMetrics.integrityScore === 100) {
          insights.push({
            type: 'success',
            category: 'brain',
            message: 'üß† BRAIN integrity perfect - all 13 checks passed'
          });
        } else {
          const failedCount = brainMetrics.totalIntegrityChecks - brainMetrics.passedIntegrityChecks;
          insights.push({
            type: 'warning',
            category: 'brain',
            message: `üß† BRAIN integrity at ${brainMetrics.integrityScore}% - ${failedCount} check(s) failing`
          });
        }
      }

      // Add recommendations from health checks
      if (state.healthData?.recommendations) {
        state.healthData.recommendations.forEach(rec => {
          insights.push({
            type: 'recommendation',
            category: 'system',
            message: rec
          });
        });
      }

      return insights;
    }

    // ==========================================
    // Utilities
    // ==========================================
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ==========================================
    // Initialization
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Show initial loading state
      showLoadingOverlay('Initializing Dashboard...', 'Loading components...');
      
      // Initial render with zero data
      resetStatsToZero();
      renderHeaderStats();
      updateLastUpdateTime();
      
      // Brief pause for visual feedback
      await sleep(800);
      
      // Try to connect to API and load data
      await runHealthChecks();
      renderOverview();
      
      // Auto-refresh if enabled
      if (state.autoRefresh) {
        setInterval(async () => {
          if (document.visibilityState === 'visible' && state.apiConnected && !state.isLoading) {
            console.log('Auto-refresh triggered');
            
            // Refresh current tab data
            if (state.currentTab === 'metrics') {
              await loadMetrics();
            } else {
              await refreshDashboard();
            }
          }
        }, state.refreshInterval);
      }
    });
  </script>
</body>
</html>
