# Git Checkpoint Rules
# Purpose: Define automatic checkpoint creation, retention, and cleanup policies
# Author: Asif Hussain
# Version: 3.2.0
# Last Updated: 2025-11-27

# ============================================================================
# AUTO-CHECKPOINT CONFIGURATION
# ============================================================================

auto_checkpoint:
  enabled: true
  
  # Triggers - When to automatically create checkpoints
  triggers:
    before_implementation: true      # Checkpoint before CORTEX makes any code changes
    after_implementation: true       # Checkpoint after CORTEX completes changes
    before_refactoring: true         # Checkpoint before refactoring operations
    after_refactoring: true          # Checkpoint after refactoring completes
    on_test_failure: true            # Checkpoint when tests fail (debugging aid)
    before_tdd_red: true             # Checkpoint before RED phase (test writing)
    after_tdd_green: true            # Checkpoint after GREEN phase (implementation)
    after_tdd_refactor: true         # Checkpoint after REFACTOR phase
    
  # Operations that trigger checkpoints
  operations:
    - "implement"
    - "refactor"
    - "fix"
    - "optimize"
    - "debug"
    - "tdd"
    - "test"

# ============================================================================
# RETENTION POLICY
# ============================================================================

retention:
  max_age_days: 30                   # Auto-delete checkpoints older than 30 days
  max_count: 50                      # Keep maximum 50 checkpoints per repository
  preserve_named: true               # Never auto-delete user-named checkpoints
  preserve_tagged: true              # Preserve checkpoints with custom tags
  
  # Cleanup strategy
  cleanup:
    auto_cleanup: true               # Automatically cleanup old checkpoints
    cleanup_interval_hours: 24       # Run cleanup every 24 hours
    warn_before_delete: true         # Warn user before deleting old checkpoints
    grace_period_days: 3             # Keep checkpoints for 3 days minimum

# ============================================================================
# NAMING CONVENTIONS
# ============================================================================

naming:
  format: "{type}-{timestamp}"       # checkpoint-20251127-143022
  timestamp_format: "%Y%m%d-%H%M%S"  # YYYYMMDD-HHMMSS
  
  # Checkpoint types
  types:
    generic: "checkpoint"            # Generic checkpoint
    pre_work: "pre-work"            # Before CORTEX starts work
    post_work: "post-work"          # After CORTEX completes work
    implementation: "implementation" # After feature implementation
    refactoring: "refactoring"      # After refactoring
    debugging: "debugging"          # During debug sessions
    tdd_red: "tdd-red"              # After RED phase
    tdd_green: "tdd-green"          # After GREEN phase
    tdd_refactor: "tdd-refactor"    # After REFACTOR phase
    test_failure: "test-failure"    # When tests fail
    
  # Custom user naming
  allow_custom_names: true           # Allow users to name checkpoints
  custom_prefix: "user"              # Prefix for user-named checkpoints

# ============================================================================
# SAFETY CHECKS
# ============================================================================

safety:
  # Uncommitted changes detection
  detect_uncommitted_changes: true
  warn_on_uncommitted: true
  require_confirmation: true         # Require user confirmation if uncommitted changes
  
  # Dirty state detection
  check_merge_in_progress: true
  check_rebase_in_progress: true
  check_cherry_pick_in_progress: true
  block_on_conflict: true            # Block checkpoint if merge conflicts exist
  
  # Untracked files
  warn_on_untracked: true           # Warn if untracked files in scope
  include_untracked_in_scope: true  # Only warn for untracked files in work scope
  
  # Rollback safety
  confirm_rollback: true             # Require confirmation before rollback
  show_changes_to_lose: true         # Show files that will be lost
  create_backup_before_rollback: true # Create safety checkpoint before rollback

# ============================================================================
# CHECKPOINT METADATA
# ============================================================================

metadata:
  capture:
    commit_hash: true                # Store current commit hash
    branch_name: true                # Store current branch
    timestamp: true                  # Store creation timestamp
    user_message: true               # Store user's intent/request
    cortex_operation: true           # Store CORTEX operation type
    file_list: true                  # Store list of modified files
    diff_stats: true                 # Store diff statistics
    
  storage:
    location: "git-tags"             # Store as git tags (not branches)
    annotation: true                 # Use annotated tags (with metadata)
    push_to_remote: false            # Don't push checkpoints to remote by default

# ============================================================================
# USER EXPERIENCE
# ============================================================================

ux:
  notifications:
    show_checkpoint_created: true    # Notify when checkpoint created
    show_checkpoint_name: true       # Show checkpoint name/ID
    show_rollback_command: true      # Show command to rollback
    
  formatting:
    use_emoji: true                  # Use emoji in checkpoint messages
    verbose: false                   # Concise messages by default
    
  colors:
    checkpoint_created: "green"
    checkpoint_warning: "yellow"
    checkpoint_error: "red"

# ============================================================================
# INTEGRATION
# ============================================================================

integration:
  # TDD Workflow
  tdd:
    checkpoint_each_phase: true      # Checkpoint after each TDD phase
    auto_rollback_on_red_fail: false # Don't auto-rollback if RED phase fails
    
  # Planning Workflow
  planning:
    checkpoint_before_implementation: true
    checkpoint_after_phase: true     # Checkpoint after each plan phase
    
  # Debug System
  debug:
    checkpoint_on_debug_start: true  # Checkpoint when debug session starts
    checkpoint_on_debug_end: true    # Checkpoint when debug session ends

# ============================================================================
# EXAMPLES
# ============================================================================

examples:
  auto_checkpoint:
    - trigger: "before_implementation"
      name: "pre-work-20251127-143022"
      message: "Pre-work checkpoint before implementing authentication feature"
      
    - trigger: "after_implementation"
      name: "implementation-20251127-143856"
      message: "Post-work checkpoint after implementing authentication feature"
      
  manual_checkpoint:
    - command: "create checkpoint before-major-refactor"
      name: "user-before-major-refactor-20251127-150000"
      message: "User-created checkpoint before major refactor"
      
  rollback:
    - command: "rollback to pre-work-20251127-143022"
      action: "git reset --hard pre-work-20251127-143022"
      confirmation: "Are you sure? This will discard all changes after checkpoint."

# ============================================================================
# TROUBLESHOOTING
# ============================================================================

troubleshooting:
  checkpoint_creation_failed:
    - "Check git repository status (git status)"
    - "Ensure no merge conflicts exist"
    - "Verify git is installed and accessible"
    - "Check disk space availability"
    
  rollback_failed:
    - "Verify checkpoint exists (git tag -l)"
    - "Check for uncommitted changes"
    - "Ensure not in detached HEAD state"
    - "Try git reflog to find commit"
    
  cleanup_issues:
    - "Check checkpoint age (git tag -l --sort=-creatordate)"
    - "Verify retention policy settings"
    - "Manually delete old tags if needed (git tag -d <tag>)"

# ============================================================================
# VERSION HISTORY
# ============================================================================

version_history:
  - version: "3.2.0"
    date: "2025-11-27"
    changes:
      - "Initial implementation of git checkpoint rules"
      - "Auto-checkpoint triggers for TDD workflow"
      - "Retention policy with 30-day/50-count limits"
      - "Safety checks for dirty state detection"
      - "User experience enhancements"
