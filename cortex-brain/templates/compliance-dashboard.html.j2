<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORTEX Compliance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        header {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007acc;
        }
        
        header h1 {
            font-size: 24px;
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        header .subtitle {
            font-size: 14px;
            color: #858585;
        }
        
        .last-updated {
            font-size: 12px;
            color: #858585;
            margin-top: 10px;
        }
        
        /* Overall Score */
        .score-card {
            background: #252526;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .score-value {
            font-size: 64px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .score-value.healthy { color: #4ec9b0; }
        .score-value.warning { color: #dcdcaa; }
        .score-value.critical { color: #f48771; }
        
        .score-label {
            font-size: 18px;
            color: #858585;
        }
        
        .health-indicator {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            border-left: 3px solid #007acc;
        }
        
        .stat-label {
            font-size: 12px;
            color: #858585;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #d4d4d4;
        }
        
        /* Rules Section */
        .rules-section {
            margin-bottom: 30px;
        }
        
        .section-header {
            background: #252526;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            border-left: 4px solid #007acc;
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .category-group {
            background: #2d2d30;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            margin-bottom: 15px;
        }
        
        .category-title {
            font-size: 16px;
            font-weight: bold;
            color: #4ec9b0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .rule-item {
            background: #252526;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .rule-indicator {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .rule-details {
            flex-grow: 1;
        }
        
        .rule-name {
            font-weight: bold;
            color: #d4d4d4;
            margin-bottom: 5px;
        }
        
        .rule-description {
            font-size: 13px;
            color: #858585;
            margin-bottom: 5px;
        }
        
        .rule-stats {
            font-size: 12px;
            color: #858585;
        }
        
        .rule-stats span {
            margin-right: 15px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-badge.compliant {
            background: #1a3a1a;
            color: #4ec9b0;
        }
        
        .status-badge.warning {
            background: #3a3a1a;
            color: #dcdcaa;
        }
        
        .status-badge.violated {
            background: #3a1a1a;
            color: #f48771;
        }
        
        /* Recent Events */
        .events-section {
            background: #2d2d30;
            padding: 20px;
            border-radius: 0 0 8px 8px;
        }
        
        .event-item {
            background: #252526;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #f48771;
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .event-rule {
            font-weight: bold;
            color: #d4d4d4;
        }
        
        .event-time {
            font-size: 12px;
            color: #858585;
        }
        
        .event-description {
            font-size: 13px;
            color: #d4d4d4;
            margin-bottom: 8px;
        }
        
        .event-file {
            font-size: 12px;
            color: #858585;
            font-family: 'Courier New', monospace;
        }
        
        .severity-badge {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .severity-badge.error {
            background: #3a1a1a;
            color: #f48771;
        }
        
        .severity-badge.warning {
            background: #3a3a1a;
            color: #dcdcaa;
        }
        
        .severity-badge.info {
            background: #1a2a3a;
            color: #569cd6;
        }
        
        /* Auto-refresh indicator */
        .refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #252526;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            color: #858585;
            border: 1px solid #3e3e42;
        }
        
        .refresh-indicator.active {
            border-color: #007acc;
            color: #007acc;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #858585;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>ðŸ§  CORTEX Compliance Dashboard</h1>
            <p class="subtitle">Real-time governance and brain protection monitoring</p>
            <p class="last-updated">Last updated: {{ generated_at }}</p>
        </header>
        
        <!-- Overall Compliance Score -->
        <div class="score-card">
            <div class="health-indicator">{{ health_status.emoji }}</div>
            <div class="score-value {{ health_status.status_class }}">{{ compliance_score }}%</div>
            <div class="score-label">Overall Compliance Score</div>
        </div>
        
        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Rules</div>
                <div class="stat-value">{{ rule_status|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Compliant Rules</div>
                <div class="stat-value" style="color: #4ec9b0;">
                    {{ rule_status|selectattr('violations', 'equalto', 0)|list|length }}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Warning Rules</div>
                <div class="stat-value" style="color: #dcdcaa;">
                    {{ statistics.warning_count if statistics.warning_count is defined else 0 }}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Violated Rules</div>
                <div class="stat-value" style="color: #f48771;">
                    {{ statistics.violated_count if statistics.violated_count is defined else 0 }}
                </div>
            </div>
        </div>
        
        <!-- Rules by Category -->
        <div class="rules-section">
            <div class="section-header">ðŸ“‹ Rules Status by Category</div>
            <div class="category-group">
                {% for category, rules in rules_by_category.items() %}
                <div class="category-title">{{ category|upper }}</div>
                
                {% for rule in rules %}
                <div class="rule-item">
                    <div class="rule-indicator">{{ rule.indicator.emoji }}</div>
                    <div class="rule-details">
                        <div class="rule-name">{{ rule.name }}</div>
                        <div class="rule-description">{{ rule.description or 'No description available' }}</div>
                        <div class="rule-stats">
                            <span>âœ“ {{ rule.total_checks }} checks</span>
                            <span>âœ— {{ rule.violations }} violations</span>
                            <span class="status-badge {{ rule.indicator.status_class }}">
                                {{ rule.indicator.status_text }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not loop.last %}
                <div style="margin: 20px 0;"></div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Recent Events -->
        <div class="rules-section">
            <div class="section-header">ðŸ“… Recent Protection Events</div>
            <div class="events-section">
                {% if recent_events %}
                    {% for event in recent_events %}
                    <div class="event-item">
                        <div class="event-header">
                            <div class="event-rule">
                                {{ event.rule_name or event.rule_id }}
                                <span class="severity-badge {{ event.severity }}">{{ event.severity }}</span>
                            </div>
                            <div class="event-time">{{ event.created_at }}</div>
                        </div>
                        <div class="event-description">{{ event.description }}</div>
                        {% if event.file_path %}
                        <div class="event-file">ðŸ“„ {{ event.file_path }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <p>No recent protection events</p>
                        <p style="font-size: 12px; margin-top: 5px;">All rules are being followed correctly</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Auto-refresh Indicator -->
    <div class="refresh-indicator" id="refreshIndicator">
        ðŸ”„ Auto-refresh in <span id="countdown">{{ refresh_interval }}</span>s
    </div>
    
    <script>
        // Auto-refresh functionality (vanilla JavaScript)
        const REFRESH_INTERVAL = {{ refresh_interval }} * 1000; // Convert to milliseconds
        let countdownSeconds = {{ refresh_interval }};
        
        // Update countdown display
        function updateCountdown() {
            const countdownEl = document.getElementById('countdown');
            const indicatorEl = document.getElementById('refreshIndicator');
            
            countdownSeconds--;
            countdownEl.textContent = countdownSeconds;
            
            // Visual feedback when refreshing
            if (countdownSeconds <= 0) {
                indicatorEl.classList.add('active');
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else if (countdownSeconds <= 5) {
                indicatorEl.classList.add('active');
            }
        }
        
        // Start countdown
        setInterval(updateCountdown, 1000);
        
        // Format timestamps on load
        document.addEventListener('DOMContentLoaded', function() {
            const timeElements = document.querySelectorAll('.event-time');
            timeElements.forEach(el => {
                const timestamp = el.textContent;
                try {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    let timeAgo = '';
                    if (diffDays > 0) {
                        timeAgo = `${diffDays}d ago`;
                    } else if (diffHours > 0) {
                        timeAgo = `${diffHours}h ago`;
                    } else if (diffMins > 0) {
                        timeAgo = `${diffMins}m ago`;
                    } else {
                        timeAgo = 'just now';
                    }
                    
                    el.textContent = timeAgo;
                    el.title = timestamp; // Show full timestamp on hover
                } catch (e) {
                    // Keep original timestamp if parsing fails
                }
            });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // R key: manual refresh
            if (e.key === 'r' || e.key === 'R') {
                location.reload();
            }
        });
        
        console.log('CORTEX Compliance Dashboard loaded');
        console.log(`Auto-refresh enabled: every ${{{ refresh_interval }}} seconds`);
        console.log('Press R to refresh manually');
    </script>
</body>
</html>
