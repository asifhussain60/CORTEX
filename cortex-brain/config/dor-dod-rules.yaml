# DoR/DoD Validation Rules for CORTEX ADO Work Items
# Purpose: Define quality gates, checklists, and approval workflows
# Version: 1.0
# Author: Asif Hussain
# Date: 2025-11-27

# ============================================================================
# DEFINITION OF READY (DoR) - Requirements Quality Gates
# ============================================================================

definition_of_ready:
  enabled: true
  
  # Minimum DoR score to approve work item (0-100%)
  minimum_score_to_approve: 80
  
  # Checklist categories and items
  checklist:
    # Category 1: Completeness
    completeness:
      weight: 30  # 30% of total DoR score
      items:
        - id: title_present
          text: "Work item has clear, descriptive title"
          validation: "metadata.title and len(metadata.title) > 10"
          points: 10
          
        - id: description_present
          text: "Work item has detailed description"
          validation: "metadata.description and len(metadata.description) > 50"
          points: 10
          
        - id: acceptance_criteria_present
          text: "Acceptance criteria defined (at least 2 items)"
          validation: "metadata.acceptance_criteria and len(metadata.acceptance_criteria) >= 2"
          points: 30
          
        - id: work_item_type_specified
          text: "Work item type specified (Story/Feature/Bug)"
          validation: "metadata.work_item_type is not None"
          points: 10
          
        - id: priority_specified
          text: "Priority level specified"
          validation: "metadata.priority in [1, 2, 3, 4]"
          points: 10
          
        - id: assignee_identified
          text: "Assigned to field populated (optional)"
          validation: "True"  # Optional, always passes
          points: 5
          optional: true
    
    # Category 2: Clarity
    clarity:
      weight: 25  # 25% of total DoR score
      items:
        - id: no_vague_language
          text: "Description contains minimal vague language"
          validation: "ambiguity_score < 3"
          points: 20
          
        - id: technical_approach_clear
          text: "Technical approach is clear or clarified"
          validation: "'technical' in metadata.description.lower() or clarification_context"
          points: 15
          
        - id: user_flow_defined
          text: "User flow defined for user-facing work"
          validation: "metadata.work_item_type not in ['STORY', 'FEATURE'] or 'user' in metadata.description.lower()"
          points: 15
          
        - id: dependencies_identified
          text: "Dependencies identified and documented"
          validation: "len(metadata.related_work_items) > 0 or 'no dependencies' in metadata.description.lower()"
          points: 10
          optional: true
    
    # Category 3: Testability
    testability:
      weight: 20  # 20% of total DoR score
      items:
        - id: acceptance_criteria_testable
          text: "Acceptance criteria are testable and measurable"
          validation: "all(any(keyword in criterion.lower() for keyword in ['can', 'should', 'must', 'verify', 'test']) for criterion in metadata.acceptance_criteria)"
          points: 30
          
        - id: test_approach_mentioned
          text: "Testing approach mentioned or implied"
          validation: "any(word in metadata.description.lower() for word in ['test', 'validation', 'verify', 'quality'])"
          points: 20
          
        - id: edge_cases_considered
          text: "Edge cases or error scenarios considered"
          validation: "any(word in metadata.description.lower() for word in ['error', 'edge', 'exception', 'failure', 'invalid'])"
          points: 10
          optional: true
    
    # Category 4: Security
    security:
      weight: 15  # 15% of total DoR score
      items:
        - id: security_review_for_sensitive_work
          text: "Security consideration for auth/data work"
          validation: "not any(word in metadata.description.lower() for word in ['auth', 'password', 'token', 'credential', 'payment']) or 'security' in metadata.description.lower()"
          points: 40
          
        - id: pii_handling_addressed
          text: "PII/GDPR handling addressed if applicable"
          validation: "not any(word in metadata.description.lower() for word in ['personal', 'pii', 'gdpr', 'sensitive']) or any(word in metadata.description.lower() for word in ['privacy', 'security', 'encrypt'])"
          points: 30
          
        - id: access_control_defined
          text: "Access control/authorization specified if needed"
          validation: "not any(word in metadata.description.lower() for word in ['admin', 'role', 'permission']) or 'authorization' in metadata.description.lower()"
          points: 30
    
    # Category 5: Context
    context:
      weight: 10  # 10% of total DoR score
      items:
        - id: git_history_enriched
          text: "Git history context available"
          validation: "metadata.git_context is not None"
          points: 20
          
        - id: quality_score_acceptable
          text: "Quality score from git history >= 60%"
          validation: "metadata.quality_score >= 60.0"
          points: 20
          
        - id: clarifications_resolved
          text: "Interactive clarifications completed"
          validation: "hasattr(metadata, 'clarification_context') and metadata.clarification_context"
          points: 30
          
        - id: high_risk_files_identified
          text: "High-risk files identified and reviewed"
          validation: "len(metadata.high_risk_files) == 0 or 'risk' in metadata.description.lower()"
          points: 30

# ============================================================================
# DEFINITION OF DONE (DoD) - Completion Quality Gates
# ============================================================================

definition_of_done:
  enabled: true
  
  # Minimum DoD score to mark work item complete (0-100%)
  minimum_score_to_complete: 85
  
  # Checklist categories and items
  checklist:
    # Category 1: Implementation
    implementation:
      weight: 30  # 30% of total DoD score
      items:
        - id: code_implemented
          text: "All code changes implemented"
          validation: "summary.code_changes_count > 0"
          points: 30
          
        - id: files_created_documented
          text: "New files documented in summary"
          validation: "len(summary.files_created) > 0 or summary.work_item_type == 'Bug'"
          points: 20
          
        - id: files_modified_documented
          text: "Modified files documented"
          validation: "len(summary.files_modified) > 0"
          points: 20
          
        - id: no_placeholder_code
          text: "No TODO/FIXME/placeholder code"
          validation: "True"  # Manual verification
          points: 10
          manual: true
    
    # Category 2: Testing
    testing:
      weight: 30  # 30% of total DoD score
      items:
        - id: tests_created
          text: "Tests created for new functionality"
          validation: "len(summary.tests_created) > 0"
          points: 40
          
        - id: test_coverage_acceptable
          text: "Test coverage meets minimum threshold (60%+)"
          validation: "summary.test_coverage >= 60.0"
          points: 30
          
        - id: tests_passing
          text: "All tests passing"
          validation: "'passed' in summary.test_results.lower() or 'success' in summary.test_results.lower()"
          points: 30
    
    # Category 3: Documentation
    documentation:
      weight: 15  # 15% of total DoD score
      items:
        - id: documentation_created
          text: "Documentation created or updated"
          validation: "len(summary.documentation_created) > 0"
          points: 40
          
        - id: technical_decisions_documented
          text: "Technical decisions documented"
          validation: "len(summary.technical_decisions) > 0"
          points: 30
          
        - id: api_changes_documented
          text: "API changes documented (if applicable)"
          validation: "True"  # Optional check
          points: 15
          optional: true
    
    # Category 4: Quality
    quality:
      weight: 15  # 15% of total DoD score
      items:
        - id: code_reviewed
          text: "Code reviewed (peer review or self-review)"
          validation: "True"  # Manual verification
          points: 30
          manual: true
          
        - id: no_known_issues
          text: "No known blocking issues"
          validation: "len(summary.known_issues) == 0"
          points: 30
          
        - id: acceptance_criteria_met
          text: "All acceptance criteria met"
          validation: "len(summary.acceptance_criteria_met) > 0"
          points: 40
    
    # Category 5: Integration
    integration:
      weight: 10  # 10% of total DoD score
      items:
        - id: dependencies_resolved
          text: "Dependencies resolved or documented"
          validation: "len(summary.dependencies) == 0 or all('resolved' in dep.lower() for dep in summary.dependencies)"
          points: 30
          
        - id: integration_tested
          text: "Integration with existing code tested"
          validation: "'integration' in summary.test_results.lower() or summary.work_item_type == 'Bug'"
          points: 40
          
        - id: deployment_ready
          text: "Ready for deployment (no blockers)"
          validation: "len(summary.known_issues) == 0"
          points: 30

# ============================================================================
# APPROVAL WORKFLOW
# ============================================================================

approval_workflow:
  enabled: true
  
  # Approval stages
  stages:
    - id: dor_validation
      name: "DoR Validation"
      description: "Validate Definition of Ready"
      required: true
      auto_execute: true
      
    - id: work_execution
      name: "Work Execution"
      description: "Implement the work item"
      required: true
      auto_execute: false
      
    - id: dod_validation
      name: "DoD Validation"
      description: "Validate Definition of Done"
      required: true
      auto_execute: true
      
    - id: final_approval
      name: "Final Approval"
      description: "Final review and approval"
      required: true
      auto_execute: false
  
  # Approval transitions
  transitions:
    - from: "planning"
      to: "active"
      requires: ["dor_validation"]
      minimum_dor_score: 80
      
    - from: "active"
      to: "review"
      requires: ["work_execution"]
      
    - from: "review"
      to: "completed"
      requires: ["dod_validation", "final_approval"]
      minimum_dod_score: 85
      
    - from: "active"
      to: "blocked"
      condition: "blockers_present"
      
    - from: "blocked"
      to: "active"
      condition: "blockers_resolved"
  
  # Auto-approval conditions
  auto_approve:
    enabled: false  # Manual approval required by default
    conditions:
      dor_score_threshold: 95  # Auto-approve if DoR score >= 95%
      dod_score_threshold: 95  # Auto-approve if DoD score >= 95%
      perfect_checklist: true  # All checklist items must pass

# ============================================================================
# QUALITY GATES
# ============================================================================

quality_gates:
  # Gate 1: Before starting work
  gate_before_work:
    name: "Pre-Implementation Gate"
    checks:
      - dor_score >= 80
      - ambiguity_score < 5
      - clarifications_complete
    failure_action: "Block transition to active, require clarification"
  
  # Gate 2: Mid-development (optional)
  gate_mid_development:
    name: "Mid-Development Gate"
    enabled: false
    checks:
      - tests_created
      - code_coverage >= 50
    failure_action: "Warning only"
  
  # Gate 3: Before completion
  gate_before_completion:
    name: "Pre-Completion Gate"
    checks:
      - dod_score >= 85
      - all_tests_passing
      - documentation_present
    failure_action: "Block transition to completed"

# ============================================================================
# REPORTING
# ============================================================================

reporting:
  # DoR Report Format
  dor_report:
    include_score: true
    include_checklist: true
    include_failures: true
    include_recommendations: true
    format: "markdown"
  
  # DoD Report Format
  dod_report:
    include_score: true
    include_checklist: true
    include_summary: true
    include_metrics: true
    format: "markdown"
  
  # Approval Report Format
  approval_report:
    include_dor_score: true
    include_dod_score: true
    include_quality_gates: true
    include_approver: true
    include_timestamp: true
    format: "markdown"

# ============================================================================
# SCORING ALGORITHM
# ============================================================================

scoring:
  # DoR Scoring
  dor:
    calculation: "weighted_average"
    categories:
      completeness: 30
      clarity: 25
      testability: 20
      security: 15
      context: 10
    
    # Bonus points
    bonus:
      all_optional_complete: 5  # Bonus if all optional items complete
      perfect_clarity: 5         # Bonus if ambiguity_score == 0
  
  # DoD Scoring
  dod:
    calculation: "weighted_average"
    categories:
      implementation: 30
      testing: 30
      documentation: 15
      quality: 15
      integration: 10
    
    # Bonus points
    bonus:
      test_coverage_80_plus: 5   # Bonus if coverage >= 80%
      zero_known_issues: 5       # Bonus if no known issues

# ============================================================================
# CUSTOMIZATION
# ============================================================================

customization:
  # Allow custom checklist items
  allow_custom_checklist_items: true
  
  # Allow custom quality gates
  allow_custom_quality_gates: true
  
  # Allow team-specific thresholds
  allow_threshold_override: true
  
  # Validation mode (strict/lenient)
  validation_mode: "strict"  # strict = all required items, lenient = skip optional

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
