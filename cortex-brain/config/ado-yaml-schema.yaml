# ADO Work Item YAML Schema

# Purpose: Schema definition for machine-readable ADO work items
# Version: 1.0
# Author: Asif Hussain
# Date: 2025-11-27

---

# Schema Version
schema_version: "1.0"

# Work Item YAML Format Specification
specification:
  description: "Machine-readable format for Azure DevOps work items with git history context"
  format: "YAML"
  encoding: "UTF-8"
  file_extension: ".yaml"
  naming_convention: "{work_item_type}-{work_item_id}-{title_slug}.yaml"
  
# Required Fields
required_fields:
  - work_item_id
  - work_item_type
  - title
  - description
  - status
  - priority
  - created_at
  - updated_at

# Optional Fields
optional_fields:
  - assigned_to
  - iteration
  - area_path
  - tags
  - acceptance_criteria
  - related_work_items
  - git_context
  - quality_score
  - high_risk_files
  - related_commits
  - contributors
  - sme_suggestions

# Field Definitions
field_definitions:
  
  work_item_id:
    type: string
    format: "{WorkItemType}-{YYYYMMDD}{HHMMSS}"
    description: "Unique identifier for work item"
    example: "UserStory-20251127143022"
    validation:
      pattern: "^(UserStory|Feature|Bug|Task|Epic)-\\d{14}$"
      required: true
  
  work_item_type:
    type: string
    enum:
      - UserStory
      - Feature
      - Bug
      - Task
      - Epic
    description: "Type of work item"
    validation:
      required: true
  
  title:
    type: string
    min_length: 5
    max_length: 200
    description: "Brief title of work item"
    validation:
      required: true
      trim: true
  
  description:
    type: string
    min_length: 10
    max_length: 5000
    description: "Detailed description of work item"
    format: "markdown"
    validation:
      required: true
  
  status:
    type: string
    enum:
      - active
      - completed
      - blocked
      - cancelled
    default: "active"
    description: "Current status of work item"
    validation:
      required: true
  
  priority:
    type: integer
    enum: [1, 2, 3, 4]
    mapping:
      1: "High"
      2: "Medium"
      3: "Low"
      4: "Very Low"
    default: 2
    description: "Priority level (1=High, 2=Medium, 3=Low, 4=Very Low)"
    validation:
      required: true
      range: [1, 4]
  
  assigned_to:
    type: string
    max_length: 100
    description: "Person assigned to work item"
    validation:
      required: false
      format: "name or email"
  
  iteration:
    type: string
    max_length: 50
    description: "Sprint or iteration name"
    example: "Sprint 23"
    validation:
      required: false
  
  area_path:
    type: string
    max_length: 200
    description: "Area path in ADO hierarchy"
    example: "Project\\Team\\Feature"
    validation:
      required: false
  
  tags:
    type: array
    item_type: string
    max_items: 20
    description: "Tags for categorization"
    example: ["authentication", "security", "backend"]
    validation:
      required: false
  
  acceptance_criteria:
    type: array
    item_type: string
    min_items: 1
    max_items: 50
    description: "List of acceptance criteria"
    validation:
      required: false
  
  related_work_items:
    type: array
    item_type: string
    max_items: 20
    description: "IDs of related work items"
    validation:
      required: false
  
  created_at:
    type: string
    format: "ISO 8601"
    description: "Timestamp when work item was created"
    example: "2025-11-27T14:30:22Z"
    validation:
      required: true
  
  updated_at:
    type: string
    format: "ISO 8601"
    description: "Timestamp when work item was last updated"
    example: "2025-11-27T15:45:10Z"
    validation:
      required: true
  
  # Git History Context Fields (Phase 1)
  
  git_context:
    type: object
    description: "Complete git history validation results"
    properties:
      status: 
        type: string
        enum: ["PASS", "WARNING", "FAIL", "BLOCKED"]
      message: string
      quality_score: number
      context_enrichment: object
    validation:
      required: false
  
  quality_score:
    type: number
    format: float
    range: [0.0, 100.0]
    description: "Git history quality score (0-100%)"
    validation:
      required: false
  
  high_risk_files:
    type: array
    item_type: string
    max_items: 50
    description: "Files flagged as high-risk"
    validation:
      required: false
  
  related_commits:
    type: array
    item_type: string
    max_items: 10
    description: "Recent related commit hashes/messages"
    validation:
      required: false
  
  contributors:
    type: array
    item_type: string
    max_items: 20
    description: "Contributors to related files"
    validation:
      required: false
  
  sme_suggestions:
    type: array
    item_type: string
    max_items: 5
    description: "Subject matter expert suggestions"
    validation:
      required: false

# Status Transitions
status_transitions:
  active:
    allowed_next_states: ["completed", "blocked", "cancelled"]
    directory: "active"
    
  completed:
    allowed_next_states: ["active"]  # Can reopen
    directory: "completed"
    
  blocked:
    allowed_next_states: ["active", "cancelled"]
    directory: "blocked"
    
  cancelled:
    allowed_next_states: ["active"]  # Can resurrect
    directory: "completed"

# Directory Structure
directory_structure:
  base: "cortex-brain/documents/planning/ado"
  subdirectories:
    - active
    - completed
    - blocked
  file_naming: "{status}/{work_item_type}-{work_item_id}-{title_slug}.yaml"

# Validation Rules
validation_rules:
  
  # Required field validation
  required_fields_present:
    description: "All required fields must be present"
    severity: "error"
    
  # Type validation
  field_types_correct:
    description: "All fields must match specified types"
    severity: "error"
    
  # Enum validation
  enum_values_valid:
    description: "Enum fields must use allowed values"
    severity: "error"
    
  # Length validation
  string_lengths_valid:
    description: "String fields must be within length limits"
    severity: "warning"
    
  # Status transition validation
  status_transitions_valid:
    description: "Status transitions must follow allowed paths"
    severity: "error"
    
  # Git context consistency
  git_context_consistent:
    description: "If git_context present, related fields should be populated"
    severity: "warning"
    
  # Acceptance criteria format
  acceptance_criteria_format:
    description: "Acceptance criteria should use checkbox format"
    severity: "info"

# YAML â†” Markdown Synchronization
synchronization:
  strategy: "bidirectional"
  markdown_to_yaml:
    trigger: "on_markdown_save"
    parse_sections:
      - title
      - description
      - acceptance_criteria
      - git_history_context
    update_fields: ["title", "description", "acceptance_criteria", "git_context", "updated_at"]
    
  yaml_to_markdown:
    trigger: "on_yaml_save"
    regenerate: true
    preserve_sections:
      - description
      - acceptance_criteria
    update_metadata: true

# Resume Capability
resume_capability:
  
  loading:
    source: "yaml_file"
    reconstruction: "full_metadata"
    validation: "schema_check"
    
  context_restoration:
    conversation_history: true
    git_context: true
    related_work_items: true
    
  usage:
    command: "resume ado {work_item_id}"
    behavior: "load_yaml_reconstruct_metadata_continue_workflow"

# Example YAML Structure
example:
  work_item_id: "Bug-20251127143022"
  work_item_type: "Bug"
  title: "Fix OAuth login timeout issue"
  description: |
    Bug in `src/auth/login.py` causing OAuth users to fail login after session timeout.
    
    ## Current Behavior
    - OAuth users cannot log in after 30-minute timeout
    - Error: "Invalid session token"
    
    ## Expected Behavior
    - OAuth users should be redirected to re-authenticate
    - Session should refresh automatically
  
  status: "active"
  priority: 1  # High
  assigned_to: "John Doe"
  iteration: "Sprint 24"
  area_path: "Project\\Authentication"
  tags:
    - "authentication"
    - "oauth"
    - "bug"
    - "high-priority"
  
  acceptance_criteria:
    - "Review high-risk files: src/auth/login.py, src/auth/oauth.py"
    - "OAuth users can re-authenticate after timeout"
    - "Session refresh works without data loss"
    - "Error handling provides clear user feedback"
    - "All existing authentication tests pass"
    - "New tests added for timeout scenarios"
  
  related_work_items:
    - "UserStory-20251120120000"
    - "Bug-20251115090000"
  
  created_at: "2025-11-27T14:30:22Z"
  updated_at: "2025-11-27T14:30:22Z"
  
  # Git History Context (Phase 1)
  git_context:
    status: "WARNING"
    message: "High-risk files detected"
    quality_score: 85.5
    context_enrichment:
      high_risk_files: ["src/auth/login.py", "src/auth/oauth.py"]
      recent_commits: 18
      contributors: 5
      security_scans: "pass"
  
  quality_score: 85.5
  
  high_risk_files:
    - "src/auth/login.py"
    - "src/auth/oauth.py"
  
  related_commits:
    - "abc123: Fix critical authentication vulnerability in OAuth flow"
    - "def456: Refactor session management for better security"
    - "ghi789: Add comprehensive unit tests for auth edge cases"
    - "jkl012: Implement rate limiting for login attempts"
    - "mno345: Update authentication documentation and examples"
  
  contributors:
    - "John Doe (42 commits)"
    - "Jane Smith (28 commits)"
    - "Bob Wilson (15 commits)"
    - "Alice Johnson (8 commits)"
    - "Charlie Brown (5 commits)"
  
  sme_suggestions:
    - "John Doe (top contributor to authentication module)"

# Schema Compliance
compliance:
  version: "1.0"
  last_updated: "2025-11-27"
  breaking_changes: []
  deprecations: []
  
# Migration Strategy (Future Versions)
migration:
  from_markdown_only:
    description: "Generate YAML from existing markdown files"
    process: "parse_markdown_create_yaml_preserve_markdown"
    
  schema_upgrades:
    description: "Handle schema version upgrades"
    process: "validate_old_schema_transform_to_new_schema_preserve_data"
