# YAML Schema for CORTEX Feature Planning
# Version: 1.0.0
# Purpose: Structured planning format for interactive feature planning
# Replaces: Markdown-based planning documents
# Benefits: Parseable, validatable, auto-generates readable views

schema:
  version: "1.0.0"
  required_fields:
    - metadata
    - phases
    - definition_of_ready
    - definition_of_done
  
  metadata:
    description: "Project-level information and context"
    required_fields:
      - plan_id
      - title
      - created_date
      - created_by
      - status
      - priority
      - estimated_hours
    optional_fields:
      - last_updated
      - completed_date
      - tags
      - related_plans
      - related_issues
      - notes
    
    field_definitions:
      plan_id:
        type: string
        pattern: "^[A-Z0-9-]+$"
        description: "Unique identifier (e.g., CORTEX-GAP-001)"
        example: "CORTEX-GAP-REMEDIATION"
      
      title:
        type: string
        max_length: 200
        description: "Concise plan title"
        example: "Comprehensive Gap Remediation Plan"
      
      created_date:
        type: string
        format: iso8601
        description: "Plan creation timestamp"
        example: "2024-01-15T10:30:00Z"
      
      created_by:
        type: string
        description: "Creator name or identifier"
        example: "GitHub Copilot"
      
      status:
        type: enum
        values:
          - proposed
          - approved
          - in-progress
          - blocked
          - completed
          - cancelled
        description: "Current plan status"
      
      priority:
        type: enum
        values:
          - critical
          - high
          - medium
          - low
        description: "Implementation priority"
      
      estimated_hours:
        type: number
        min: 0
        description: "Total estimated effort in hours"
        example: 18
      
      tags:
        type: list
        item_type: string
        description: "Categorization tags"
        example: ["tdd", "automation", "workflow"]
      
      related_plans:
        type: list
        item_type: string
        description: "References to other plan IDs"
        example: ["CORTEX-FEATURE-001", "CORTEX-BUGFIX-042"]
      
      related_issues:
        type: list
        item_type: string
        description: "GitHub issue URLs or numbers"
        example: ["#67", "#80", "#108"]

  phases:
    description: "Sequential implementation phases"
    type: list
    min_items: 1
    item_schema:
      required_fields:
        - phase_number
        - phase_name
        - estimated_hours
        - tasks
      optional_fields:
        - description
        - dependencies
        - acceptance_criteria
        - risks
        - notes
      
      field_definitions:
        phase_number:
          type: integer
          min: 1
          description: "Sequential phase identifier"
          example: 1
        
        phase_name:
          type: string
          max_length: 100
          description: "Phase title"
          example: "TDD Mastery Enhancements"
        
        estimated_hours:
          type: string
          pattern: "^\\d+(-\\d+)?$"
          description: "Hour estimate or range"
          example: "10-12"
        
        description:
          type: string
          description: "Phase overview"
          example: "Implement automated git checkpoints and metrics tracking"
        
        dependencies:
          type: list
          item_type: string
          description: "Prerequisites (phase numbers or external)"
          example: ["Phase 1", "Database migration"]
        
        tasks:
          type: list
          min_items: 1
          item_schema:
            required_fields:
              - task_id
              - task_name
              - estimated_hours
            optional_fields:
              - description
              - acceptance_criteria
              - implementation_notes
              - files_affected
              - tests_required
            
            field_definitions:
              task_id:
                type: string
                pattern: "^\\d+\\.\\d+$"
                description: "Task identifier (phase.task)"
                example: "1.1"
              
              task_name:
                type: string
                max_length: 150
                description: "Task title"
                example: "Create GitCheckpointOrchestrator"
              
              estimated_hours:
                type: number
                min: 0.25
                step: 0.25
                description: "Task effort estimate"
                example: 2.5
              
              acceptance_criteria:
                type: list
                item_type: string
                description: "Completion conditions"
                example:
                  - "Creates git checkpoint before implementation"
                  - "Tracks checkpoint in .cortex/checkpoints.json"
                  - "Supports rollback to checkpoint"
              
              files_affected:
                type: list
                item_type: string
                description: "Files to create/modify"
                example:
                  - "src/orchestrators/git_checkpoint_orchestrator.py"
                  - "tests/orchestrators/test_git_checkpoint_orchestrator.py"

  definition_of_ready:
    description: "Criteria required before implementation starts"
    type: list
    item_type: string
    min_items: 1
    example:
      - "All dependencies identified and documented"
      - "User stories/requirements clearly defined"
      - "Technical approach agreed upon"
      - "No critical blockers present"

  definition_of_done:
    description: "Criteria required for plan completion"
    type: list
    item_type: string
    min_items: 1
    example:
      - "All tasks implemented and tested"
      - "Documentation updated"
      - "Code review completed"
      - "Acceptance criteria met"
      - "No regressions introduced"

  risks:
    description: "Potential issues and mitigation strategies"
    type: list
    optional: true
    item_schema:
      required_fields:
        - risk_id
        - description
        - likelihood
        - impact
        - mitigation
      
      field_definitions:
        risk_id:
          type: string
          pattern: "^R\\d+$"
          example: "R1"
        
        description:
          type: string
          example: "Git operations may fail on detached HEAD"
        
        likelihood:
          type: enum
          values: [low, medium, high]
        
        impact:
          type: enum
          values: [low, medium, high, critical]
        
        mitigation:
          type: string
          example: "Detect detached HEAD state and warn user before operations"

  acceptance_criteria:
    description: "High-level acceptance criteria for entire plan"
    type: list
    item_type: string
    optional: true
    example:
      - "All 10 gaps remediated with automated workflows"
      - "Metrics tracking integrated into TDD workflow"
      - "Feedback system automated with Gist uploads"
      - "Deployment modernized with git-based publishing"

validation_rules:
  - name: "Unique task IDs"
    description: "All task_id values must be unique within a plan"
    
  - name: "Sequential phases"
    description: "Phase numbers must be sequential starting from 1"
    
  - name: "Valid dependencies"
    description: "Phase dependencies must reference existing phases"
    
  - name: "Total hours consistency"
    description: "Sum of phase hours should match metadata.estimated_hours (±20% tolerance)"
    
  - name: "Status transitions"
    description: "Status must follow: proposed → approved → in-progress → completed"
    
  - name: "ISO 8601 dates"
    description: "All date fields must use ISO 8601 format (YYYY-MM-DDTHH:MM:SSZ)"

markdown_view_template:
  description: "Auto-generated Markdown structure from YAML"
  sections:
    - type: header
      level: 1
      content: "{{ metadata.title }}"
    
    - type: metadata_table
      content: |
        | Field | Value |
        |-------|-------|
        | Plan ID | {{ metadata.plan_id }} |
        | Status | {{ metadata.status }} |
        | Priority | {{ metadata.priority }} |
        | Created | {{ metadata.created_date }} by {{ metadata.created_by }} |
        | Estimated Hours | {{ metadata.estimated_hours }} |
    
    - type: header
      level: 2
      content: "Definition of Ready"
    
    - type: checklist
      items: "{{ definition_of_ready }}"
    
    - type: header
      level: 2
      content: "Implementation Phases"
    
    - type: phases
      for_each: "{{ phases }}"
      content: |
        ### Phase {{ phase.phase_number }}: {{ phase.phase_name }}
        **Estimated Hours:** {{ phase.estimated_hours }}
        
        {{ phase.description }}
        
        #### Tasks
        {% for task in phase.tasks %}
        - **{{ task.task_id }}** - {{ task.task_name }} ({{ task.estimated_hours }}h)
          {% if task.acceptance_criteria %}
          - Acceptance Criteria:
            {% for criterion in task.acceptance_criteria %}
            - {{ criterion }}
            {% endfor %}
          {% endif %}
        {% endfor %}
    
    - type: header
      level: 2
      content: "Definition of Done"
    
    - type: checklist
      items: "{{ definition_of_done }}"
    
    - type: header
      level: 2
      content: "Risks & Mitigation"
      conditional: "{{ risks is defined }}"
    
    - type: risk_table
      conditional: "{{ risks is defined }}"
      content: |
        | ID | Risk | Likelihood | Impact | Mitigation |
        |----|------|------------|--------|------------|
        {% for risk in risks %}
        | {{ risk.risk_id }} | {{ risk.description }} | {{ risk.likelihood }} | {{ risk.impact }} | {{ risk.mitigation }} |
        {% endfor %}

examples:
  - name: "Simple Bug Fix Plan"
    path: "examples/simple-bugfix-plan.yaml"
    description: "Single-phase plan for straightforward bug fix"
  
  - name: "Multi-Phase Feature Plan"
    path: "examples/multi-phase-feature-plan.yaml"
    description: "Complex feature with dependencies and risks"
  
  - name: "Gap Remediation Plan"
    path: "examples/gap-remediation-plan.yaml"
    description: "Current CORTEX gap remediation (reference implementation)"

migration_notes:
  from_markdown:
    - "Extract metadata from header tables"
    - "Parse phase sections (## Phase N: ...)"
    - "Extract task lists under each phase"
    - "Convert checkbox lists to DoR/DoD arrays"
    - "Preserve notes/risks sections"
    - "Generate plan_id from filename or title"
    - "Set created_date to file creation time"
    - "Default status to 'in-progress' if not specified"
  
  validation:
    - "Verify all required fields present"
    - "Check task ID uniqueness"
    - "Validate phase sequence"
    - "Ensure total hours match"
    - "Verify ISO 8601 date formats"
