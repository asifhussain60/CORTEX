# Brain Protector Configuration
# Version: 1.0.0
# Purpose: Protect KDS BRAIN integrity from corruption and architectural degradation

version: "1.0.0"
hemisphere: "RIGHT_BRAIN"
rule: "#22"
status: "ACTIVE"

# Protection Layers (6 layers total)
protection_layers:
  layer1_instinct_immutability:
    protects: "Tier 0 permanent rules (governance/rules.md, agent core logic)"
    
    threats:
      - "Disable TDD for this feature"
      - "Skip DoR validation this time"
      - "Modify agent behavior inline"
      - "Remove SOLID requirements"
      - "Application-specific data in Tier 0"
    
    risks:
      - "Degrades KDS core capabilities"
      - "Future sessions inherit bad behavior"
      - "Violates governance framework"
      - "Cannot be amnesia-reset (Tier 0 permanent)"
    
    alternatives:
      spike_branch:
        description: "Create spike branch for experimentation"
        steps:
          - "Test idea WITHOUT affecting main KDS"
          - "Extract learnings, not code"
          - "Rebuild properly if valuable"
        recommended: true
        
      application_override:
        description: "Use application-specific override"
        steps:
          - "Store override in Tier 2 (application data)"
          - "Amnesia will reset it later"
          - "Doesn't corrupt permanent instinct"
        recommended: false
    
    severity: "CRITICAL"
  
  layer2_tier_boundary:
    protects: "Clean tier separation, no cross-contamination"
    
    threats:
      - "Application file paths in Tier 0"
      - "Conversation data in Tier 2"
      - "Permanent rules in Tier 1 FIFO"
      - "Event backlog > 50 unprocessed"
    
    tier_rules:
      tier0: "KDS core rules only (NO application data)"
      tier1: "Last 20 conversations (FIFO, temporary)"
      tier2: "Application patterns (resettable via amnesia)"
      tier3: "Project metrics (resettable via amnesia)"
      tier4: "Raw events (processed regularly)"
    
    impact:
      - "Amnesia will preserve/delete incorrectly"
      - "Brain queries will fail unexpectedly"
      - "Tier integrity compromised"
    
    correction: "Auto-migrate to correct tier"
    severity: "HIGH"
  
  layer3_solid_compliance:
    protects: "SOLID architectural principles"
    
    violations:
      SRP:
        description: "Single Responsibility Principle"
        example: "Agent doing multiple jobs (code-executor handling execution AND correction)"
        
      OCP:
        description: "Open/Closed Principle"
        example: "Modifying existing agents instead of extending"
        
      LSP:
        description: "Liskov Substitution Principle"
        example: "Breaking agent contracts or interfaces"
        
      ISP:
        description: "Interface Segregation Principle"
        example: "Adding mode switches to agents"
        
      DIP:
        description: "Dependency Inversion Principle"
        example: "Hardcoding concrete implementations (bypassing abstractions)"
    
    risks:
      - "Agent becomes complex and fragile"
      - "Violates v5.0 SOLID refactor goals"
      - "Future maintenance burden increases"
      - "Testing becomes harder"
    
    alternative:
      create_dedicated_agent:
        description: "Create focused agent with clean interface"
        benefits:
          - "Focused responsibility"
          - "Clean interface"
          - "Easy to test"
          - "Follows existing pattern"
    
    severity: "HIGH"
  
  layer4_hemisphere_protection:
    protects: "LEFT/RIGHT brain specialization and coordination"
    
    threats:
      - "Strategic planning in LEFT BRAIN"
      - "Tactical execution in RIGHT BRAIN"
      - "Direct hemisphere communication (bypass corpus callosum)"
      - "Wrong hemisphere processing request"
    
    hemisphere_rules:
      LEFT_BRAIN:
        role: "Tactical"
        responsibilities:
          - "TDD automation"
          - "Code execution"
          - "Test generation"
          - "Detail verification"
          - "Error correction"
      
      RIGHT_BRAIN:
        role: "Strategic"
        responsibilities:
          - "Architecture design"
          - "Strategic planning"
          - "Pattern recognition"
          - "Holistic analysis"
          - "Brain protection"
    
    correction: "Auto-route to correct hemisphere"
    severity: "MEDIUM"
  
  layer5_knowledge_quality:
    protects: "Knowledge graph from corruption"
    
    threats:
      - "Low confidence patterns (< 0.50)"
      - "Stale patterns (> 90 days unused)"
      - "Contradictory patterns"
      - "Spam patterns (100+ similar events)"
    
    quality_rules:
      min_confidence: 0.50
      min_occurrences: 3
      max_age_unused_days: 90
      no_contradictions: true
    
    actions:
      - reject
      - consolidate
      - decay
    
    severity: "MEDIUM"
  
  layer6_commit_integrity:
    protects: "Quality gates enforced through semantic commits"
    
    threats:
      - "Committing brain state files (conversation-context.jsonl)"
      - "Committing auto-generated prompts"
      - "Unstructured commit messages"
      - "Bypassing test-first workflow"
    
    prohibited_files:
      - "KDS/kds-brain/conversation-context.jsonl (auto-generated)"
      - "KDS/kds-brain/conversation-history.jsonl (FIFO state)"
      - "KDS/prompts/internal/*.md (auto-updated)"
      - "KDS/reports/monitoring/* (generated reports)"
    
    requirements:
      - "Semantic commit prefix: feat/fix/test/docs/refactor/chore/perf"
      - "User-created files only"
      - "Auto-generated files reset before commit"
    
    correction: "Use commit-kds-changes.ps1 script"
    severity: "HIGH"

# Workflow Steps
workflow:
  step1_receive:
    description: "Receive request from intent-router or manual invocation"
    
  step2_analyze:
    description: "Analyze modification"
    components:
      - "Identify target (file, tier, agent, rule)"
      - "Classify modification (add, modify, delete)"
      - "Assess scope (tier, hemisphere)"
      - "Understand user intent"
  
  step3_run_protections:
    description: "Run all 6 protection layers in parallel"
    layers:
      - "check_instinct_immutability()"
      - "check_tier_boundaries()"
      - "check_solid_compliance()"
      - "check_hemisphere_specialization()"
      - "check_knowledge_quality()"
      - "check_commit_integrity()"
  
  step4_assess_severity:
    description: "Determine maximum severity"
    levels:
      CRITICAL: "HALT and challenge"
      HIGH: "WARN and suggest alternatives"
      MEDIUM: "WARN and allow with logging"
      LOW: "LOG only"
  
  step5_build_challenge:
    description: "Build comprehensive challenge if needed"
    triggers: ["CRITICAL", "HIGH"]
    components:
      - "Request summary"
      - "Threats detected"
      - "Alternatives generated"
      - "Recommendation selected"
  
  step6_log_decision:
    description: "Log to corpus-callosum"
    location: "corpus-callosum/protection-events.jsonl"
    data:
      - "timestamp"
      - "type"
      - "hemisphere"
      - "agent"
      - "request"
      - "threats"
      - "decision"
      - "outcome"
  
  step7_update_metrics:
    description: "Update protection statistics"
    file: "kds-brain/right-hemisphere/protection-stats.yaml"
    metrics:
      - "challenges_issued"
      - "overrides_accepted"
      - "alternatives_adopted"
      - "threats_prevented"

# Challenge Template Structure
challenge_template:
  header:
    - "üß† BRAIN PROTECTION CHALLENGE (RIGHT BRAIN)"
    - "Request: {user_request}"
    - "Hemisphere: RIGHT BRAIN (Strategic Guardian)"
    - "Rule: #22 (Brain Protection System)"
  
  body:
    - "‚ö†Ô∏è THREATS DETECTED: {threat_list}"
    - "VIOLATIONS: {violation_details}"
    - "ARCHITECTURAL IMPACT: {impact_analysis}"
    - "RISKS: {risk_assessment}"
  
  alternatives:
    - "1. {alternative_1} ‚úÖ RECOMMENDED"
    - "   - {benefit_1}"
    - "   - {rationale_1}"
    - "2. {alternative_2}"
    - "   - {benefit_2}"
    - "   - {rationale_2}"
  
  recommendation:
    - "RECOMMENDATION: Alternative {best_alternative}"
  
  options:
    - "1. Accept recommended alternative (SAFE)"
    - "2. Provide different approach (REVIEW)"
    - "3. Type 'OVERRIDE' with justification (RISKY)"

# Metrics Tracking
metrics:
  target_metrics:
    solid_compliance_rate: 0.95  # 95%+
    tier_boundary_integrity: 1.00  # 100%
    instinct_immutability: 1.00  # 100%
    alternative_adoption_rate: 0.70  # 70%+
    override_rate: 0.20  # <=20%
  
  tracked_statistics:
    - total_challenges_issued
    - overrides_accepted
    - overrides_rejected
    - alternatives_adopted
    - threats_prevented
    - solid_compliance_rate
    - tier_boundary_integrity
    - instinct_immutability
  
  threat_categories:
    - instinct_modification
    - tier_boundary_violation
    - solid_violation
    - hemisphere_confusion
    - knowledge_corruption
    - commit_integrity

# Integration Points
integration:
  inputs:
    - source: "intent-router.md"
      trigger: "KDS modification detected"
      
    - source: "change-governor.md"
      trigger: "Governance changes proposed"
      
    - source: "work-planner.md"
      trigger: "Query for architectural validation"
  
  outputs:
    - destination: "corpus-callosum"
      file: "protection-events.jsonl"
      content: "All challenges"
      
    - destination: "corpus-callosum"
      file: "override-log.jsonl"
      content: "User overrides with justification"
      
    - destination: "corpus-callosum"
      file: "alternative-adoptions.jsonl"
      content: "Successful threat prevention"
  
  coordination:
    hemisphere: "RIGHT_BRAIN"
    corpus_callosum: true
    queries_left_brain: true

# Success Criteria
success_criteria:
  - "Threats detected BEFORE harm occurs"
  - "Alternatives are SOLID-compliant and practical"
  - "User understands WHY request is harmful"
  - "Tier boundaries remain clean (100% integrity)"
  - "SOLID compliance maintained (95%+)"
  - "Instinct layer never polluted"
  - "Protection metrics show threat prevention"

# Key Principles
principles:
  - "Strategic thinking: RIGHT BRAIN - big picture, architecture, long-term health"
  - "Challenge with alternatives: Never just say 'no'"
  - "Protect Tier 0: Instinct layer is sacred"
  - "Enforce SOLID: v5.0 refactor must be maintained"
  - "Log everything: All challenges go to corpus-callosum"
  - "Be firm but helpful: Protect integrity while enabling success"
