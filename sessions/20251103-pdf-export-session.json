{
    "session_id": "20251103-pdf-export",
    "feature": "Canvas PDF Export with Visual Regression Tests",
    "created_by": "github_copilot",
    "created_at": "2025-11-03T20:00:00Z",
    "correlation_id": "test-phase1-abc123",
    "branch": "features/kds-testing",
    "status": "IN_PROGRESS",
    "last_updated": "2025-11-03T20:07:00Z",
    "current_phase": 1,
    "current_task": "1.1",
    "tasks_completed": 3,
    "intents": [
        "PLAN",
        "TEST"
    ],
    "phases": [
        {
            "phase_number": 0,
            "name": "Architectural Discovery",
            "description": "Query BRAIN for patterns and validate architectural conventions before implementation",
            "architectural_thinking_mandate": true,
            "tasks": [
                {
                    "task_id": "0.1",
                    "description": "Query BRAIN for export feature patterns and button component locations",
                    "files": [],
                    "tests": [],
                    "rules": [
                        "Architectural Thinking Mandate - BRAIN Query Required"
                    ],
                    "status": "completed",
                    "completed_at": "2025-11-03T20:05:00Z",
                    "brain_queries": [
                        "Where do export buttons typically live in the codebase?",
                        "What naming conventions exist for export services?",
                        "What visual regression patterns exist for canvas features?"
                    ],
                    "brain_query_results": {
                        "export_button_locations": "Components/Canvas/ (discovered from existing patterns)",
                        "service_conventions": "Services/{ServiceName}Service.cs with interface in Services/Abstractions/",
                        "button_id_convention": "#{area}-{function}-btn",
                        "visual_regression_framework": "Playwright + Percy in Tests/UI/"
                    }
                },
                {
                    "task_id": "0.2",
                    "description": "Validate file structure conventions (Components/Canvas/, Services/, Tests/UI/)",
                    "files": [],
                    "tests": [],
                    "rules": [
                        "Architectural Thinking Mandate - No Temporary Solutions"
                    ],
                    "status": "completed",
                    "completed_at": "2025-11-03T20:06:00Z",
                    "validations": [
                        "Services go in: SPA/NoorCanvas/Services/{ServiceName}Service.cs",
                        "Components go in: SPA/NoorCanvas/Components/Canvas/{ComponentName}.razor",
                        "Buttons follow: #{area}-{function}-btn convention",
                        "Tests go in: Tests/UI/{feature}-{test-type}.spec.ts"
                    ],
                    "validation_results": {
                        "all_conventions_validated": true,
                        "no_temporary_solutions": true,
                        "follows_architectural_patterns": true
                    }
                }
            ]
        },
        {
            "phase_number": 1,
            "name": "Service Layer Implementation",
            "description": "Create PdfExportService following discovered architectural patterns",
            "tasks": [
                {
                    "task_id": "1.1",
                    "description": "Create IPdfExportService interface in Services/Abstractions/",
                    "files": [
                        "SPA/NoorCanvas/Services/Abstractions/IPdfExportService.cs"
                    ],
                    "tests": [],
                    "rules": [
                        "SOLID - Interface Segregation Principle"
                    ],
                    "status": "completed",
                    "completed_at": "2025-11-03T20:07:00Z",
                    "interface_methods": [
                        "Task<byte[]> ExportCanvasToPdfAsync(int sessionId, string canvasType)",
                        "Task<PdfExportResult> ValidateExportAsync(int sessionId)"
                    ],
                    "file_created": "SPA/NoorCanvas/Services/Abstractions/IPdfExportService.cs",
                    "solid_compliance": "ISP - Focused interface with only export-related methods"
                },
                {
                    "task_id": "1.2",
                    "description": "Implement PdfExportService.cs using existing canvas HTML transform patterns",
                    "files": [
                        "SPA/NoorCanvas/Services/PdfExportService.cs"
                    ],
                    "tests": [
                        "Tests/Unit/PdfExportServiceTests.cs"
                    ],
                    "rules": [
                        "SOLID - Single Responsibility",
                        "Test-First Development"
                    ],
                    "status": "not_started",
                    "dependencies": [
                        "IHtmlTransformService (for canvas HTML)",
                        "ISessionService (for session validation)",
                        "ILogger<PdfExportService>"
                    ]
                },
                {
                    "task_id": "1.3",
                    "description": "Register service in Program.cs with DI container",
                    "files": [
                        "SPA/NoorCanvas/Program.cs"
                    ],
                    "tests": [],
                    "rules": [
                        "SOLID - Dependency Inversion"
                    ],
                    "status": "not_started"
                }
            ]
        },
        {
            "phase_number": 2,
            "name": "Component Creation",
            "description": "Add PDF export button to canvas component following established patterns",
            "tasks": [
                {
                    "task_id": "2.1",
                    "description": "Add export button to TranscriptCanvas.razor with semantic ID",
                    "files": [
                        "SPA/NoorCanvas/Components/Canvas/TranscriptCanvas.razor"
                    ],
                    "tests": [],
                    "rules": [
                        "Playwright Test-First - Semantic IDs Required"
                    ],
                    "status": "not_started",
                    "button_spec": {
                        "id": "canvas-export-pdf-btn",
                        "location": "Canvas action toolbar",
                        "styling": "Golden NOOR theme (#FFD700)",
                        "icon": "ðŸ“„ Export PDF"
                    }
                },
                {
                    "task_id": "2.2",
                    "description": "Wire button click handler to IPdfExportService",
                    "files": [
                        "SPA/NoorCanvas/Components/Canvas/TranscriptCanvas.razor"
                    ],
                    "tests": [],
                    "rules": [
                        "SOLID - Dependency Inversion"
                    ],
                    "status": "not_started",
                    "implementation": "@inject IPdfExportService PdfExportService"
                },
                {
                    "task_id": "2.3",
                    "description": "Add loading spinner and success/error toast feedback",
                    "files": [
                        "SPA/NoorCanvas/Components/Canvas/TranscriptCanvas.razor",
                        "SPA/NoorCanvas/wwwroot/css/noor-canvas.css"
                    ],
                    "tests": [],
                    "rules": [
                        "UX Best Practice - Visual Feedback Required"
                    ],
                    "status": "not_started"
                }
            ]
        },
        {
            "phase_number": 3,
            "name": "API Endpoint",
            "description": "Create API endpoint for PDF export requests",
            "tasks": [
                {
                    "task_id": "3.1",
                    "description": "Add POST endpoint: /api/canvas/{sessionId}/export-pdf",
                    "files": [
                        "SPA/NoorCanvas/Controllers/CanvasController.cs"
                    ],
                    "tests": [
                        "Tests/Integration/CanvasControllerTests.cs"
                    ],
                    "rules": [
                        "RESTful API Design",
                        "Test-First Development"
                    ],
                    "status": "not_started",
                    "endpoint_spec": {
                        "method": "POST",
                        "route": "/api/canvas/{sessionId}/export-pdf",
                        "parameters": [
                            "sessionId",
                            "canvasType"
                        ],
                        "returns": "FileResult (application/pdf)"
                    }
                },
                {
                    "task_id": "3.2",
                    "description": "Add error handling and validation",
                    "files": [
                        "SPA/NoorCanvas/Controllers/CanvasController.cs"
                    ],
                    "tests": [],
                    "rules": [
                        "Defensive Programming"
                    ],
                    "status": "not_started",
                    "validations": [
                        "Session exists",
                        "Canvas has content",
                        "User has permission"
                    ]
                }
            ]
        },
        {
            "phase_number": 4,
            "name": "Visual Regression Tests (Percy)",
            "description": "Create comprehensive Playwright + Percy tests for PDF export feature",
            "test_phase": true,
            "tasks": [
                {
                    "task_id": "4.1",
                    "description": "Create canvas-export-pdf-button-visual.spec.ts for button appearance",
                    "files": [
                        "Tests/UI/canvas-export-pdf-button-visual.spec.ts"
                    ],
                    "tests": [
                        "Button visible",
                        "Button styling",
                        "Button hover state"
                    ],
                    "rules": [
                        "Percy Visual Regression - Required for UI Changes"
                    ],
                    "status": "not_started",
                    "percy_snapshots": [
                        "Canvas with export button (idle)",
                        "Canvas with export button (hover)",
                        "Canvas with export button (loading)"
                    ]
                },
                {
                    "task_id": "4.2",
                    "description": "Create canvas-export-pdf-flow.spec.ts for export interaction",
                    "files": [
                        "Tests/UI/canvas-export-pdf-flow.spec.ts"
                    ],
                    "tests": [
                        "Click â†’ Loading â†’ Success",
                        "Click â†’ Error state"
                    ],
                    "rules": [
                        "Playwright E2E - Multi-Step Workflows"
                    ],
                    "status": "not_started",
                    "test_scenarios": [
                        "Successful PDF export flow",
                        "Export failure with error message",
                        "Export with empty canvas (validation error)"
                    ]
                },
                {
                    "task_id": "4.3",
                    "description": "Add test orchestration script (run app â†’ execute tests â†’ teardown)",
                    "files": [
                        "Scripts/run-pdf-export-visual-tests.ps1"
                    ],
                    "tests": [],
                    "rules": [
                        "Test Automation - Orchestration Required"
                    ],
                    "status": "not_started",
                    "orchestration": {
                        "step_1": "Start app (dotnet run in background)",
                        "step_2": "Wait for app ready (http://localhost:9091)",
                        "step_3": "Run Percy tests",
                        "step_4": "Teardown app"
                    }
                }
            ]
        },
        {
            "phase_number": 5,
            "name": "Integration Validation",
            "description": "Run all tests and validate integration",
            "tasks": [
                {
                    "task_id": "5.1",
                    "description": "Run unit tests (PdfExportService, CanvasController)",
                    "files": [],
                    "tests": [
                        "dotnet test"
                    ],
                    "rules": [
                        "Test-First - All Tests Must Pass"
                    ],
                    "status": "not_started"
                },
                {
                    "task_id": "5.2",
                    "description": "Run Playwright functional tests",
                    "files": [],
                    "tests": [
                        "npx playwright test canvas-export-pdf-flow.spec.ts"
                    ],
                    "rules": [
                        "E2E Testing Required"
                    ],
                    "status": "not_started"
                },
                {
                    "task_id": "5.3",
                    "description": "Run Percy visual regression tests",
                    "files": [],
                    "tests": [
                        "npm run test:percy:visual -- canvas-export-pdf-button-visual.spec.ts"
                    ],
                    "rules": [
                        "Visual Regression - UI Changes Must Have Percy Tests"
                    ],
                    "status": "not_started"
                },
                {
                    "task_id": "5.4",
                    "description": "Validate build succeeds",
                    "files": [],
                    "tests": [
                        "dotnet build"
                    ],
                    "rules": [
                        "Build Validation Required"
                    ],
                    "status": "not_started"
                }
            ]
        }
    ],
    "summary": {
        "total_phases": 6,
        "total_tasks": 13,
        "test_phase_included": true,
        "architectural_discovery_phase": true,
        "estimated_hours": 8.5,
        "files_to_create": 8,
        "files_to_modify": 4,
        "tests_to_create": 5
    },
    "brain_events_logged": [
        {
            "event": "plan_created",
            "timestamp": "2025-11-03T20:00:00Z",
            "details": {
                "intents": [
                    "PLAN",
                    "TEST"
                ],
                "multi_intent": true,
                "phases": 6,
                "test_phase_auto_included": true,
                "architectural_discovery_included": true
            }
        }
    ],
    "solid_compliance": {
        "srp": "Each service/component has single responsibility (PdfExportService exports, TranscriptCanvas renders)",
        "ocp": "IPdfExportService interface allows extension without modification",
        "lsp": "Not applicable (no inheritance hierarchy)",
        "isp": "IPdfExportService has focused interface (export + validation only)",
        "dip": "Components depend on abstraction (IPdfExportService) not concrete implementation"
    },
    "architectural_thinking_validation": {
        "phase_0_included": true,
        "brain_queried": true,
        "no_refactoring_phases": true,
        "follows_conventions": true,
        "files_in_correct_locations": true,
        "no_temporary_solutions": true
    }
}