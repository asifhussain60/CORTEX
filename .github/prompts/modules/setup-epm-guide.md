# Setup Entry Point Module (EPM) Guide

**Purpose:** Generate `.github/copilot-instructions.md` for user repositories using lightweight template + brain-assisted learning

**Version:** 1.0.0  
**Status:** âœ… IMPLEMENTED (Phase 1)  
**Author:** Asif Hussain

---

## ðŸŽ¯ Overview

The Setup EPM generates AI coding instructions for any repository by:
1. **Fast Detection** - File system scan only (<10 seconds)
2. **Template Generation** - Minimal but functional instructions
3. **Brain Learning** - Incremental improvement over time via Tier 3
4. **Smart Merge** - Handles existing files intelligently

---

## ðŸš€ Quick Start

### As User (Natural Language)

```
setup copilot instructions
```

CORTEX will:
- Detect your project structure
- Generate `.github/copilot-instructions.md`
- Enable brain learning for future improvements

### As Developer (Direct Python)

```python
from src.orchestrators.setup_epm_orchestrator import SetupEPMOrchestrator

orchestrator = SetupEPMOrchestrator("/path/to/user/repo")
result = orchestrator.execute()

print(result["file_path"])  # .github/copilot-instructions.md
```

---

## ðŸ—ï¸ Architecture

### Component Structure

```
SetupEPMOrchestrator
â”œâ”€â”€ _detect_project_structure()    # File system scan
â”‚   â”œâ”€â”€ _detect_language()          # Python/JS/C#/etc.
â”‚   â”œâ”€â”€ _detect_framework()         # Django/React/etc.
â”‚   â”œâ”€â”€ _detect_build_system()      # npm/make/gradle/etc.
â”‚   â””â”€â”€ _detect_test_framework()    # pytest/jest/etc.
â”œâ”€â”€ _render_template()              # Generate markdown
â”œâ”€â”€ _schedule_brain_learning()      # Store in Tier 3
â””â”€â”€ _handle_existing_file()         # Merge logic
```

### Data Flow

```
User: "setup copilot instructions"
   â†“
Intent Router â†’ Setup EPM Trigger
   â†“
SetupEPMOrchestrator.execute()
   â†“
1. Check for existing file
   â”œâ”€ Exists? â†’ Show merge options
   â””â”€ Not exists? â†’ Continue
   â†“
2. Detect project structure (fast)
   â”œâ”€ Language: package.json/requirements.txt/etc.
   â”œâ”€ Framework: dependencies analysis
   â”œâ”€ Build: Makefile/package.json/etc.
   â””â”€ Test: pytest.ini/jest/etc.
   â†“
3. Render template with detected metadata
   â†“
4. Write to .github/copilot-instructions.md
   â†“
5. Schedule brain learning (Tier 3)
   â†“
Return: File path + learning status
```

---

## ðŸ“‹ Detection Logic

### Language Detection

| File Present | Language Detected |
|--------------|-------------------|
| `package.json` | JavaScript/TypeScript |
| `requirements.txt` or `setup.py` | Python |
| `Gemfile` | Ruby |
| `pom.xml` or `build.gradle` | Java |
| `*.csproj` | C# |
| `go.mod` | Go |
| `Cargo.toml` | Rust |

### Framework Detection

| Language | Dependencies Checked | Framework |
|----------|---------------------|-----------|
| JavaScript | `react` in package.json | React |
| JavaScript | `vue` in package.json | Vue |
| JavaScript | `next` in package.json | Next.js |
| Python | `django` in requirements.txt | Django |
| Python | `flask` in requirements.txt | Flask |
| Python | `fastapi` in requirements.txt | FastAPI |

### Build System Detection

| File Present | Build System |
|--------------|--------------|
| `package.json` | npm/yarn |
| `Makefile` | make |
| `build.gradle` | Gradle |
| `pom.xml` | Maven |
| `*.csproj` | MSBuild |
| `setup.py` | setuptools |

### Test Framework Detection

| Language | File/Dependency | Test Framework |
|----------|----------------|----------------|
| JavaScript | `jest` in package.json | Jest |
| JavaScript | `vitest` in package.json | Vitest |
| Python | `pytest.ini` exists | pytest |
| PHP | `phpunit.xml` exists | PHPUnit |

---

## ðŸ“ Generated Template Structure

```markdown
# GitHub Copilot Instructions for {repo_name}

**Auto-generated by CORTEX** | **Last Updated:** {timestamp}
**Learning Progress:** Starting... (CORTEX will learn as you work)

## ðŸŽ¯ Entry Point
[Link to CORTEX.prompt.md]

## ðŸ—ï¸ Architecture Overview
**Detected:** {language} with {framework}
ðŸ§  Learning in progress...

## ðŸ› ï¸ Build & Test
**Build System:** {build_system}
**Test Framework:** {test_framework}
[Generated commands based on detection]

## ðŸ“ Code Conventions
ðŸ§  Observing your coding patterns...

## ðŸ”‘ Critical Files
ðŸ§  Identifying important files...

## ðŸ§  Brain Learning Status
**Namespace:** workspace.{repo_name}.copilot_instructions
**Learning Enabled:** Yes/No

## ðŸ“š CORTEX Capabilities
[Quick reference to main features]
```

---

## ðŸ”„ Brain Learning (Phase 2 - TODO)

### Storage in Tier 3

```python
# Namespace isolation per repository
namespace = f"workspace.{repo_name}.copilot_instructions"

# Pattern types stored
pattern_types = [
    "architecture",      # Component relationships, data flow
    "convention",        # Import style, naming, organization
    "workflow",          # Build, test, deploy commands
    "critical_files"     # Entry points, configs, hot files
]

# TTL: 30 days (auto-expire if not refreshed)
```

### Learning Triggers

CORTEX observes patterns during:
- **Planning** - Component analysis, architecture decisions
- **TDD Workflow** - Test patterns, file organization
- **Execution** - Frequently modified files, import patterns
- **Crawling** - Directory structure, component relationships

### Refresh Command (Phase 3 - TODO)

```
User: "cortex refresh instructions"

CORTEX:
   ðŸ”„ Analyzing learned patterns from Tier 3...
   
   âœ… Found 47 new patterns since last update:
      â€¢ 15 architecture patterns
      â€¢ 12 code conventions
      â€¢ 8 workflow patterns
      â€¢ 12 critical files
   
   ðŸ“ Updated .github/copilot-instructions.md
   ðŸ“Š Learning progress: 45% â†’ 78%
```

---

## ðŸ”€ Merge Logic (Phase 3 - TODO)

### Scenario 1: No Existing File

- Generate template immediately
- Enable brain learning
- User ready to work

### Scenario 2: Existing File Detected

```
User: "setup copilot instructions"

CORTEX:
   âš ï¸ Found existing .github/copilot-instructions.md
   
   Options:
   1. **Merge** - Keep your content + add CORTEX learning sections
   2. **Backup + Replace** - Save original as .copilot-instructions.backup.md
   3. **Cancel** - Keep existing file unchanged
   
   Recommended: Merge (preserves your work)

User: "merge"

CORTEX:
   âœ… Merged successfully
   
   Your content: Preserved
   CORTEX sections: Added with ðŸ§  prefix
   
   File structure:
   â€¢ Your architecture overview (preserved)
   â€¢ ðŸ§  CORTEX learned patterns (new, auto-updating)
   â€¢ Your build commands (preserved)
   â€¢ ðŸ§  CORTEX workflow observations (new)
```

### Merge Algorithm

```python
def merge_instructions(existing: str, generated: str) -> str:
    """
    Intelligent merge preserving user content
    
    Rules:
    - User sections without ðŸ§  prefix: Keep as-is
    - CORTEX sections with ðŸ§  prefix: Update/add
    - Conflicts: User content wins, CORTEX adds subsection
    """
    # Parse existing markdown
    existing_sections = parse_markdown(existing)
    generated_sections = parse_markdown(generated)
    
    merged = []
    
    for section in existing_sections:
        if section.is_cortex_managed():
            # Update CORTEX-managed section
            merged.append(generated_sections.get(section.name))
        else:
            # Preserve user content
            merged.append(section)
    
    # Add new CORTEX sections not in existing
    for section in generated_sections:
        if section.name not in existing_sections:
            merged.append(section)
    
    return render_markdown(merged)
```

---

## ðŸ§ª Testing

### Unit Tests (Phase 4 - TODO)

```python
# tests/orchestrators/test_setup_epm_orchestrator.py

def test_detect_python_project():
    """Test Python project detection"""
    orchestrator = SetupEPMOrchestrator("/path/to/python/repo")
    detected = orchestrator._detect_project_structure()
    assert detected["language"] == "Python"

def test_detect_react_framework():
    """Test React framework detection"""
    # Create temp repo with package.json
    # Assert framework == "React"

def test_generate_template_content():
    """Test template rendering"""
    # Verify all required sections present
    # Check markdown syntax valid

def test_existing_file_handling():
    """Test merge logic"""
    # Create existing file
    # Execute orchestrator
    # Verify merge options returned
```

### Integration Tests

```python
def test_end_to_end_generation():
    """Test complete workflow on sample repo"""
    # Create temp repo structure
    # Run orchestrator
    # Verify file created
    # Check content accuracy
```

---

## ðŸ“Š Performance Metrics

### Phase 1 (Current)

- **Initial Generation:** <10 seconds
- **Token Usage:** ~200 (file system scan only)
- **Accuracy:** 60-70% (basic detection)
- **Learning:** Not yet implemented

### Phase 2 (Brain Learning - Target)

- **Pattern Capture:** <100ms per observation
- **Storage:** Tier 3 SQLite (namespace isolated)
- **Refresh Time:** <5 seconds (query + render)

### Phase 3 (Merge Logic - Target)

- **Merge Operation:** <2 seconds
- **Accuracy:** 95%+ (preserves user content)

---

## ðŸŽ¯ Roadmap

### âœ… Phase 1: Core Implementation (DONE)

- [x] SetupEPMOrchestrator class
- [x] Fast project detection
- [x] Template rendering
- [x] File creation
- [x] Basic CLI interface

### â³ Phase 2: Brain Learning (TODO)

- [ ] Tier 3 storage integration
- [ ] Pattern observation hooks
- [ ] TTL expiration logic
- [ ] Refresh command implementation

### â³ Phase 3: Merge Logic (TODO)

- [ ] Existing file detection
- [ ] Intelligent merge algorithm
- [ ] Backup mechanism
- [ ] User confirmation prompts

### â³ Phase 4: Testing & Documentation (TODO)

- [ ] Unit tests (80% coverage)
- [ ] Integration tests
- [ ] Response template entry
- [ ] User guide completion

---

## ðŸ”§ Configuration

### Tier 3 Path Detection

```python
# Auto-detection priority
candidates = [
    "{repo_path}/CORTEX/cortex-brain/tier3",           # Embedded
    "~/PROJECTS/CORTEX/cortex-brain/tier3",             # Standalone
    "{script_path}/../cortex-brain/tier3"               # Relative
]
```

### Namespace Format

```python
# Pattern: workspace.{repo_name}.copilot_instructions
namespace = f"workspace.{Path(repo_path).name}.copilot_instructions"
```

### TTL Configuration

```python
# Default: 30 days auto-expiration
TTL_DAYS = 30

# Refresh resets TTL
# Patterns unused for 30 days are purged
```

---

## ðŸ†˜ Troubleshooting

### Issue: "Tier 3 not found"

**Cause:** CORTEX installation not detected  
**Impact:** Brain learning disabled, but template still works  
**Fix:** Install CORTEX or specify `tier3_db_path` manually

### Issue: "Language not detected"

**Cause:** No standard language files found  
**Impact:** Template shows "Unknown" language  
**Fix:** Manually edit generated file or add language markers

### Issue: "Existing file conflict"

**Cause:** User already has copilot-instructions.md  
**Impact:** Generation blocked (prevents accidental overwrite)  
**Fix:** Choose merge/backup/cancel option or use `--force`

---

## ðŸ“š Related Documentation

- **CORTEX.prompt.md** - Main entry point documentation
- **template-guide.md** - Response template system
- **upgrade-guide.md** - Similar orchestrator pattern

---

## ðŸŽ“ Copyright & Attribution

**Author:** Asif Hussain  
**Copyright:** Â© 2024-2025 Asif Hussain. All rights reserved.  
**License:** Source-Available (Use Allowed, No Contributions)  
**Repository:** https://github.com/asifhussain60/CORTEX

---

**Version:** 1.0.0 - Phase 1 Complete  
**Last Updated:** November 26, 2025
