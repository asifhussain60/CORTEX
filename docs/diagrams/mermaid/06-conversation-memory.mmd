%% CORTEX Conversation Memory Flow
%% Shows how conversations are captured and stored in Tier 1

graph TB
    START([User-Copilot<br/>Conversation])
    
    subgraph capture["üì° CAPTURE METHODS"]
        M1["PowerShell Script<br/>Manual Trigger"]
        M2["Python CLI<br/>cortex remember"]
        M3["Ambient Daemon<br/>Auto-capture (30s idle)"]
    end

    subgraph process["‚öôÔ∏è PROCESSING"]
        P1["Extract Messages<br/>User + Assistant"]
        P2["Entity Detection<br/>Files, Classes, Methods"]
        P3["Intent Classification<br/>PLAN, EXECUTE, TEST, etc."]
        P4["Context Enrichment<br/>Git branch, errors, session"]
    end

    subgraph storage["üíæ TIER 1 STORAGE"]
        S1[("conversations.db<br/>(SQLite)")]
        S2["conversation-context.jsonl<br/>(Backup)"]
        S3["Entity Index<br/>Fast Lookup"]
    end

    subgraph fifo["üîÑ FIFO QUEUE"]
        F1["Current: 18/20<br/>conversations"]
        F2{"Queue Full?"}
        F3["Archive Oldest<br/>conversation-001"]
        F4["Store New<br/>conversation-019"]
    end

    subgraph tier2["üß© TIER 2 EXTRACTION"]
        T2_1["Pattern Learning<br/>Intent ‚Üí Agent mapping"]
        T2_2["File Relationships<br/>Co-modification tracking"]
        T2_3["Correction History<br/>Wrong file patterns"]
    end

    START --> capture
    capture --> P1
    P1 --> P2
    P2 --> P3
    P3 --> P4
    P4 --> F2
    
    F2 -->|"Yes"| F3
    F2 -->|"No"| F4
    F3 --> F4
    F4 --> S1
    S1 --> S2
    S1 --> S3
    
    S1 -.->|"Extract Patterns"| T2_1
    S1 -.->|"Track Files"| T2_2
    S1 -.->|"Learn Corrections"| T2_3

    style capture fill:#3B82F6,stroke:#1E3A8A,color:#fff
    style process fill:#10B981,stroke:#065F46,color:#fff
    style storage fill:#3B82F6,stroke:#1E3A8A,color:#fff
    style fifo fill:#F59E0B,stroke:#92400E,color:#fff
    style tier2 fill:#10B981,stroke:#065F46,color:#fff
