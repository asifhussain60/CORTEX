%% CORTEX Data Flow: Simple Request to Completion
%% End-to-end flow for "Add purple button" request

graph TD
    START([ğŸ‘¤ User:<br/>'Add purple button to dashboard'])
    
    subgraph tier1_in["ğŸ’¾ TIER 1: Context Check"]
        T1_1["Check Recent<br/>Conversations"]
        T1_2["Find 'dashboard'<br/>entity reference"]
        T1_3["Load context:<br/>DashboardPanel.razor"]
    end

    subgraph route["ğŸ§­ INTENT ROUTING"]
        R1["Parse keywords:<br/>add, button, purple"]
        R2["Match intent:<br/>EXECUTE (0.89)"]
        R3["Route to:<br/>Code Executor"]
    end

    subgraph tier2_check["ğŸ§© TIER 2: Pattern Search"]
        T2_1["Search patterns:<br/>'add button'"]
        T2_2["Found workflow:<br/>button_creation (0.85)"]
        T2_3["Load workflow:<br/>3-step process"]
    end

    subgraph execute["âš™ï¸ CODE EXECUTOR"]
        E1["Generate Test (RED)<br/>test_purple_button()"]
        E2["Implement Button<br/>with purple styling"]
        E3["Run Tests (GREEN)<br/>âœ… Pass"]
        E4["Refactor Code<br/>Extract styles"]
    end

    subgraph validate["âœ… HEALTH VALIDATOR"]
        V1["Check Errors<br/>0 errors"]
        V2["Check Warnings<br/>0 warnings"]
        V3["Run Full Suite<br/>All pass"]
        V4["DoD Status:<br/>âœ… Complete"]
    end

    subgraph commit["ğŸŒ¿ COMMIT HANDLER"]
        C1["Create message:<br/>feat(ui): Add purple button"]
        C2["Git commit<br/>Atomic change"]
    end

    subgraph tier1_out["ğŸ’¾ TIER 1: Store"]
        T1_4["Store conversation"]
        T1_5["Track entities:<br/>button, purple, dashboard"]
    end

    subgraph tier2_out["ğŸ§© TIER 2: Learn"]
        T2_4["Update pattern:<br/>button_creation"]
        T2_5["Boost confidence:<br/>0.85 â†’ 0.88"]
        T2_6["Track file:<br/>DashboardPanel.razor"]
    end

    subgraph tier3_out["ğŸ“Š TIER 3: Analyze"]
        T3_1["Record commit"]
        T3_2["Update file stability"]
        T3_3["Session analytics"]
    end

    START --> T1_1
    T1_1 --> T1_2
    T1_2 --> T1_3
    T1_3 --> R1
    
    R1 --> R2
    R2 --> R3
    R3 --> T2_1
    
    T2_1 --> T2_2
    T2_2 --> T2_3
    T2_3 --> E1
    
    E1 --> E2
    E2 --> E3
    E3 --> E4
    E4 --> V1
    
    V1 --> V2
    V2 --> V3
    V3 --> V4
    V4 --> C1
    
    C1 --> C2
    C2 --> T1_4
    
    T1_4 --> T1_5
    T1_5 --> T2_4
    
    T2_4 --> T2_5
    T2_5 --> T2_6
    T2_6 --> T3_1
    
    T3_1 --> T3_2
    T3_2 --> T3_3
    T3_3 --> DONE([âœ… Feature Complete<br/>Memory Updated])

    style tier1_in fill:#3B82F6,stroke:#1E3A8A,color:#fff
    style route fill:#F59E0B,stroke:#92400E,color:#fff
    style tier2_check fill:#10B981,stroke:#065F46,color:#fff
    style execute fill:#3B82F6,stroke:#1E3A8A,color:#fff
    style validate fill:#6B46C1,stroke:#4C1D95,color:#fff
    style commit fill:#10B981,stroke:#065F46,color:#fff
    style tier1_out fill:#3B82F6,stroke:#1E3A8A,color:#fff
    style tier2_out fill:#10B981,stroke:#065F46,color:#fff
    style tier3_out fill:#F59E0B,stroke:#92400E,color:#fff
