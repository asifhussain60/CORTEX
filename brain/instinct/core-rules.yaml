# TIER 0: INSTINCT LAYER - Core Governance Rules
# Version: 4.2.0 (migrated from governance/rules.md)
# Last Updated: 2025-11-02
# Permanence: NEVER reset during brain amnesia
# Source: KDS/governance/rules.md

rules:
  rule_01_dual_interface:
    id: 1
    title: "Dual Interface (KDS Prompt + Markdown Docs)"
    severity: "CRITICAL"
    scope: "all_prompts"
    description: |
      Every KDS prompt MUST have a human-readable counterpart in governance/ or docs/.
      Technical prompts are optimized for agents, markdown docs for human understanding.
    validation:
      - check: "prompt_has_companion_doc"
        algorithm: "check_prompt_companion"
        failure_action: "HALT"
    benefits:
      - "Humans understand KDS design"
      - "Agents execute efficiently"
      - "Documentation never stale"
    
  rule_02_live_design_doc:
    id: 2
    title: "Live Design Doc (Update KDS-DESIGN.md + governance/rules.md)"
    severity: "CRITICAL"
    scope: "kds_modifications"
    description: |
      When KDS changes, BOTH design docs must be updated:
      - KDS-DESIGN.md (architecture, philosophy)
      - governance/rules.md (validation algorithms)
    validation:
      - check: "design_doc_updated"
        algorithm: "check_design_doc_updated"
        failure_action: "HALT"
      - check: "rules_md_updated"
        algorithm: "check_rules_md_updated"
        failure_action: "HALT"
    benefits:
      - "Documentation always current"
      - "Design decisions captured"
      - "No knowledge loss"
    
  rule_03_delete_over_archive:
    id: 3
    title: "Delete Over Archive (No archive/ folders)"
    severity: "CRITICAL"
    scope: "file_management"
    description: |
      Use git history for rollback, never archive/ folders.
      Delete files when obsolete - git preserves history.
    validation:
      - check: "no_archive_folders"
        algorithm: "check_archive_folders"
        failure_action: "HALT"
      - check: "no_old_backup_files"
        algorithm: "check_old_backup_files"
        failure_action: "AUTO_DELETE"
    benefits:
      - "Cleaner workspace"
      - "Git is single source of truth"
      - "No duplication"
    
  rule_04_function_naming:
    id: 4
    title: "Function Naming (Verb-Noun for context)"
    severity: "MEDIUM"
    scope: "code_style"
    description: |
      Use verb-noun pattern for functions:
      - Good: ProcessInvoice(), GenerateReport(), ValidateInput()
      - Bad: Invoice(), Report(), Input()
    validation:
      - check: "function_names_verb_noun"
        algorithm: "check_function_naming"
        failure_action: "WARN"
    benefits:
      - "Clear intent"
      - "Better code completion"
      - "Self-documenting"
    
  rule_05_kds_branch_isolation:
    id: 5
    title: "KDS Branch Isolation (features/kds only)"
    severity: "CRITICAL"
    scope: "git_workflow"
    description: |
      KDS modifications MUST:
      - Be on features/kds branch
      - Only touch files under KDS/ directory
      - Auto-switch to features/kds after merge to main
    validation:
      - check: "branch_is_features_kds"
        algorithm: "check_kds_branch"
        failure_action: "HALT"
      - check: "only_kds_files_modified"
        algorithm: "check_kds_files_only"
        failure_action: "HALT"
    post_merge_action: "auto_switch_to_features_kds"
    benefits:
      - "Isolation of KDS changes"
      - "Clean git history"
      - "Easy rollback"
    
  rule_06_explicit_templates:
    id: 6
    title: "Explicit Templates (templates/ for boilerplate)"
    severity: "MEDIUM"
    scope: "project_structure"
    description: |
      Store reusable templates in KDS/templates/:
      - Component templates
      - Test templates
      - Configuration templates
    validation:
      - check: "templates_in_correct_folder"
        algorithm: "check_template_location"
        failure_action: "AUTO_MOVE"
    benefits:
      - "Consistent structure"
      - "Easy to find"
      - "Reusable patterns"
    
  rule_07_documentation_updates:
    id: 7
    title: "Documentation Updates (No orphaned docs)"
    severity: "HIGH"
    scope: "documentation"
    description: |
      When code changes, update:
      - Inline comments
      - README files
      - KDS-DESIGN.md (if architecture changes)
      - governance/rules.md (if rules change)
    validation:
      - check: "documentation_synchronized"
        algorithm: "check_doc_sync"
        failure_action: "WARN"
    benefits:
      - "Documentation stays current"
      - "No orphaned docs"
      - "Knowledge preserved"
    
  rule_08_test_first_always:
    id: 8
    title: "Test-First Always (Write tests before code)"
    severity: "CRITICAL"
    scope: "testing"
    description: |
      Write tests BEFORE implementation:
      1. Write failing test
      2. Implement feature
      3. Test passes
      4. Refactor
    validation:
      - check: "tests_exist_for_feature"
        algorithm: "check_test_coverage"
        failure_action: "HALT"
    benefits:
      - "Better design"
      - "Testable code"
      - "Regression prevention"
    
  rule_09_tooling_awareness:
    id: 9
    title: "Tooling Awareness (Read tooling-inventory.json)"
    severity: "MEDIUM"
    scope: "project_setup"
    description: |
      Before suggesting new tools, read tooling-inventory.json
      to avoid duplication and conflicts.
    validation:
      - check: "tooling_inventory_consulted"
        algorithm: "check_tooling_awareness"
        failure_action: "WARN"
    benefits:
      - "No tool duplication"
      - "Consistent tooling"
      - "Avoid conflicts"
    
  rule_10_no_duplication:
    id: 10
    title: "No Duplication (DRY principle)"
    severity: "HIGH"
    scope: "code_quality"
    description: |
      Avoid duplicating logic across prompts, code, or documentation.
      Use shared modules and references.
    validation:
      - check: "no_duplicate_logic"
        algorithm: "check_duplication"
        failure_action: "WARN"
    benefits:
      - "Easier maintenance"
      - "Single source of truth"
      - "Reduced bugs"
    
  rule_11_mandatory_build_success:
    id: 11
    title: "Mandatory Build Success (HALT on build failure)"
    severity: "CRITICAL"
    scope: "continuous_integration"
    description: |
      After code changes, MUST verify build succeeds.
      If build fails, HALT and fix before continuing.
    validation:
      - check: "build_succeeds"
        algorithm: "check_build_status"
        failure_action: "HALT"
    benefits:
      - "No broken builds"
      - "Immediate feedback"
      - "Prevents cascading failures"
    
  rule_12_test_registry:
    id: 12
    title: "Test Registry (tests/index.json)"
    severity: "MEDIUM"
    scope: "testing"
    description: |
      Maintain tests/index.json with all test metadata:
      - Test name
      - Test type
      - Framework
      - File path
      - Last run
    validation:
      - check: "test_registry_updated"
        algorithm: "check_test_registry"
        failure_action: "AUTO_UPDATE"
    benefits:
      - "Discoverable tests"
      - "Test metadata centralized"
      - "Easy test execution"
    
  rule_13_auto_reorganize:
    id: 13
    title: "Auto-Reorganize (Fix misplaced files)"
    severity: "MEDIUM"
    scope: "file_management"
    description: |
      Automatically move misplaced files to correct locations:
      - Services → Services/
      - Tests → Tests/
      - Docs → Docs/
    validation:
      - check: "files_in_correct_folders"
        algorithm: "check_file_organization"
        failure_action: "AUTO_MOVE"
    benefits:
      - "Consistent structure"
      - "Easy navigation"
      - "Reduces clutter"
    
  rule_14_auto_publish_patterns:
    id: 14
    title: "Auto-Publish Patterns (knowledge/ folder)"
    severity: "MEDIUM"
    scope: "knowledge_management"
    description: |
      Automatically publish reusable patterns to knowledge/:
      - Test patterns (after 2+ uses)
      - UI mappings (after 3+ unique IDs)
      - Validated data (after 3+ attempts)
    validation:
      - check: "patterns_published"
        algorithm: "check_pattern_publishing"
        failure_action: "AUTO_PUBLISH"
    benefits:
      - "Knowledge capture"
      - "Reusable patterns"
      - "Continuous learning"
    
  rule_15_ui_test_ids:
    id: 15
    title: "UI Test IDs (BOTH id AND data-testid)"
    severity: "CRITICAL"
    scope: "ui_testing"
    description: |
      UI elements MUST have BOTH attributes:
      - id="semantic-kebab-case"
      - data-testid="semantic-kebab-case"
      Naming: [component]-[section]-[element]
    validation:
      - check: "ui_elements_have_both_ids"
        algorithm: "check_ui_test_ids"
        failure_action: "HALT"
      - check: "ui_element_naming_convention"
        algorithm: "check_naming_convention"
        failure_action: "WARN"
    benefits:
      - "Reliable test selectors"
      - "Consistent naming"
      - "Better maintainability"
    
  rule_16_mandatory_post_task:
    id: 16
    title: "Mandatory Post-Task Execution (5-step validation)"
    severity: "CRITICAL"
    scope: "task_execution"
    description: |
      After EVERY task, run 5-step validation:
      1. Build verification (HALT if fails)
      2. Pattern publishing (auto-publish if reused)
      3. Clutter cleanup (auto-delete archive/, *.old)
      4. Organization check (auto-move misplaced files)
      5. KDS verification (redundancy, conflict, performance, consistency)
    validation:
      - check: "post_task_validation_executed"
        algorithm: "check_post_task_execution"
        failure_action: "HALT"
    sub_checks:
      step_1_build:
        algorithm: "run_build_verification"
        failure_action: "HALT"
      step_2_patterns:
        algorithm: "auto_publish_patterns"
        failure_action: "LOG"
      step_3_cleanup:
        algorithm: "auto_cleanup_clutter"
        failure_action: "AUTO_DELETE"
      step_4_organize:
        algorithm: "auto_reorganize_files"
        failure_action: "AUTO_MOVE"
      step_5_kds_verification:
        algorithm: "kds_health_check"
        failure_action: "WARN"
        checks:
          - "redundancy_check"
          - "conflict_check"
          - "performance_check"
          - "consistency_check"
    benefits:
      - "Automated quality checks"
      - "Immediate feedback"
      - "Prevents tech debt"
    
  rule_17_challenge_user_requests:
    id: 17
    title: "Challenge User Requests (Protect KDS design)"
    severity: "CRITICAL"
    scope: "kds_modifications"
    description: |
      DO NOT blindly accept user requests that may harm KDS.
      Challenge requests that:
      - Duplicate existing functionality
      - Violate governance rules
      - Add unnecessary complexity
      - Bypass governance mechanisms
      
      Provide alternatives and require explicit confirmation.
    validation:
      - check: "request_validated_against_kds"
        algorithm: "challenge_user_request"
        failure_action: "REQUIRE_CONFIRMATION"
    sub_checks:
      duplication_check:
        algorithm: "check_for_duplication"
        failure_action: "WARN"
      rule_violation_check:
        algorithm: "check_rule_violations"
        failure_action: "WARN"
      complexity_check:
        algorithm: "check_unnecessary_complexity"
        failure_action: "WARN"
    benefits:
      - "Protects KDS integrity"
      - "Prevents duplication"
      - "Maintains governance"
      - "Better design decisions"
    
  rule_18_project_tooling_awareness:
    id: 18
    title: "Project Tooling Awareness (Read BEFORE execution)"
    severity: "CRITICAL"
    scope: "task_execution"
    description: |
      BEFORE executing ANY task, read tooling-inventory.json to:
      - Know what tools are available
      - Use correct package managers
      - Avoid suggesting already-installed tools
      - Verify tooling is current (<7 days old)
      - Auto-refresh if package.json/csproj changed
    validation:
      - check: "tooling_inventory_read_before_task"
        algorithm: "check_tooling_awareness_pre_task"
        failure_action: "HALT"
      - check: "tooling_inventory_freshness"
        algorithm: "check_tooling_freshness"
        failure_action: "AUTO_REFRESH"
    benefits:
      - "Accurate tooling suggestions"
      - "No duplication"
      - "Faster execution"
      - "Better UX"

metadata:
  total_rules: 18
  version: "4.2.0"
  last_updated: "2025-11-02"
  source_file: "KDS/governance/rules.md"
  migration_date: "2025-11-04"
  tier: 0
  permanence: "NEVER_RESET"
  description: "Core governance rules that define KDS behavior - these rules NEVER change during brain amnesia"
