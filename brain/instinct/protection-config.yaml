# TIER 0: INSTINCT LAYER - Protection Configuration
# Version: 1.0 (migrated from kds-brain/knowledge-graph.yaml)
# Last Updated: 2025-11-03
# Permanence: NEVER reset during brain amnesia
# Source: KDS/kds-brain/knowledge-graph.yaml

protection_config:
  enabled: true
  version: "1.0"
  description: "Phase 1 Protection - Confidence checks and learning quality thresholds"
  purpose: "Prevent KDS from learning bad patterns and making incorrect routing decisions"
  
  learning_quality:
    description: "Prevents learning from insufficient data and detects anomalies"
    min_confidence_threshold: 0.70
    min_occurrences_for_pattern: 3
    max_single_event_confidence: 0.50
    anomaly_confidence_threshold: 0.95
    rationale:
      min_confidence: "Patterns below 70% confidence are too uncertain to learn"
      min_occurrences: "Need at least 3 examples to establish reliable pattern"
      max_single_event: "Single event can't establish >50% confidence (prevents overfitting)"
      anomaly_detection: "Confidence >95% from single event indicates data corruption"
    examples:
      good_pattern:
        phrase: "add share button"
        confidence: 0.95
        occurrences: 12
        status: "VALID - High confidence with strong evidence"
      insufficient_data:
        phrase: "make it blue"
        confidence: 0.80
        occurrences: 2
        status: "INVALID - Need at least 3 occurrences"
      suspicious_pattern:
        phrase: "do the thing"
        confidence: 0.98
        occurrences: 1
        status: "ANOMALY - Confidence too high for single event"
  
  routing_safety:
    description: "Asks user for clarification when confidence is low"
    enabled: true
    fallback_on_low_confidence: true
    ask_user_threshold: 0.70
    auto_route_threshold: 0.85
    rationale:
      ask_user: "Below 70% confidence = ambiguous intent, ask user"
      auto_route: "Above 85% confidence = clear intent, proceed automatically"
      medium_confidence: "70-85% range = show intent, ask for confirmation"
    decision_logic:
      high_confidence:
        condition: "confidence >= 0.85 AND occurrences >= 3"
        action: "AUTO_ROUTE"
        message: "âœ… High confidence - routing automatically"
      medium_confidence:
        condition: "confidence >= 0.70 AND < 0.85"
        action: "ASK_CONFIRMATION"
        message: "âš ï¸ Detected: {intent}. Proceed? (Y/n)"
      low_confidence:
        condition: "confidence < 0.70"
        action: "FALLBACK_TO_PATTERN_MATCHING"
        message: "âŒ Low confidence - using pattern matching"
      insufficient_data:
        condition: "confidence >= 0.70 BUT occurrences < 3"
        action: "DOWNGRADE_TO_PATTERN_MATCHING"
        message: "âš ï¸ Insufficient data - using pattern matching"
      anomaly_detected:
        condition: "confidence > 0.95 AND occurrences == 1"
        action: "OVERRIDE_TO_PATTERN_MATCHING"
        message: "ðŸš¨ Anomaly detected - overriding to pattern matching"
  
  correction_memory:
    description: "Prevents repeating the same mistakes"
    enabled: true
    alert_on_repeated_mistake: 3
    prevent_action_threshold: 5
    track_correction_patterns: true
    rationale:
      alert_threshold: "After 3 corrections of same mistake, warn user"
      prevent_threshold: "After 5 corrections of same mistake, halt and require override"
      track_patterns: "Learn which mistakes are most common for prevention"
    examples:
      file_mismatch:
        mistake: "Using wrong file location"
        occurrences: 1
        threshold: 3
        action: "LOG"
      approach_mismatch:
        mistake: "Using wrong technical approach"
        occurrences: 0
        threshold: 3
        action: "NONE"
    actions:
      first_occurrence:
        action: "LOG"
        message: "Noted: User corrected {mistake_type}"
      second_occurrence:
        action: "LOG + LEARN"
        message: "Learning pattern: {mistake_type} correction"
      third_occurrence:
        action: "ALERT"
        message: "âš ï¸ Pattern detected: {mistake_type} corrected 3 times. Adjusting behavior."
      fifth_occurrence:
        action: "HALT + REQUIRE_OVERRIDE"
        message: "ðŸš¨ Repeated mistake (5x): {mistake_type}. Manual intervention required."
  
  validation:
    description: "Ensures data integrity and removes stale information"
    validate_confidence_scores: true
    validate_file_references: true
    detect_stale_relationships: true
    max_relationship_age_days: 90
    rationale:
      confidence_validation: "Ensure all confidence scores are between 0.0 and 1.0"
      file_validation: "Verify all file references point to existing files"
      stale_detection: "Remove relationships older than 90 days (project evolution)"
    validation_rules:
      confidence_score:
        min: 0.0
        max: 1.0
        action_if_invalid: "RESET_TO_DEFAULT"
        default: 0.50
      file_references:
        check: "file_exists"
        action_if_missing: "MARK_STALE + LOG_WARNING"
      relationship_age:
        max_days: 90
        action_if_stale: "MARK_FOR_REVIEW"
        auto_delete_after_days: 180
    health_checks:
      daily:
        - "Validate all confidence scores"
        - "Check file references"
      weekly:
        - "Detect stale relationships"
        - "Clean up orphaned data"
      monthly:
        - "Full integrity check"
        - "Generate health report"

safety_mechanisms:
  brain_backup:
    description: "Automatic backup before risky operations"
    enabled: true
    backup_triggers:
      - "Before amnesia operation"
      - "Before bulk pattern deletion"
      - "Before confidence threshold changes"
      - "Before protection config changes"
    backup_location: "git commit (permanent history)"
    rollback_instructions: "git revert {commit_hash}"
  
  dry_run_mode:
    description: "Preview changes before applying them"
    enabled: true
    available_for:
      - "brain-amnesia.md"
      - "pattern-cleanup operations"
      - "confidence-threshold changes"
    output: "Detailed report of what will change"
  
  confirmation_requirements:
    description: "Require explicit confirmation for destructive operations"
    enabled: true
    operations_requiring_confirmation:
      - operation: "Brain amnesia"
        keyword: "AMNESIA"
        reason: "Deletes application-specific knowledge"
      - operation: "Pattern deletion (>10 patterns)"
        keyword: "DELETE_PATTERNS"
        reason: "Bulk deletion of learned patterns"
      - operation: "Protection config changes"
        keyword: "MODIFY_PROTECTION"
        reason: "Changes safety thresholds"
  
  rollback_capability:
    description: "Easy rollback for all changes"
    enabled: true
    mechanism: "Git history"
    instructions:
      view_history: "git log --oneline"
      rollback: "git revert {commit_hash}"
      verify: "Check BRAIN integrity tests"

phase_roadmap:
  phase_1:
    status: "ACTIVE"
    features:
      - "Confidence thresholds"
      - "Learning quality checks"
      - "Routing safety"
      - "Correction memory"
      - "Data validation"
  
  phase_2:
    status: "PLANNED"
    features:
      - "Pattern confidence decay (reduce old patterns over time)"
      - "Conflict resolution (handle contradicting patterns)"
      - "Cross-validation (verify patterns across sessions)"
  
  phase_3:
    status: "FUTURE"
    features:
      - "Self-healing (auto-fix corrupted data)"
      - "Anomaly learning (improve anomaly detection)"
      - "Adaptive thresholds (adjust based on accuracy)"

metadata:
  version: "1.0"
  last_updated: "2025-11-03"
  source_file: "KDS/kds-brain/knowledge-graph.yaml"
  migration_date: "2025-11-04"
  tier: 0
  permanence: "NEVER_RESET"
  description: "Protection configuration that prevents KDS from learning bad patterns - these thresholds NEVER change during brain amnesia"
  purpose: "Safety system for BRAIN intelligence"
  phase: 1
