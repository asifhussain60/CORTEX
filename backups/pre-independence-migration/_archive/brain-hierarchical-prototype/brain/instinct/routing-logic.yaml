# TIER 0: INSTINCT LAYER - Intent Routing Logic
# Version: 5.0 (migrated from prompts/internal/intent-router.md)
# Last Updated: 2025-11-03
# Permanence: NEVER reset during brain amnesia
# Source: KDS/prompts/internal/intent-router.md

intent_patterns:
  plan:
    description: "User wants to start new feature work"
    keywords:
      - "I want to"
      - "add"
      - "create"
      - "build"
      - "implement"
    patterns:
      - "I want to [add|create|build|implement]..."
      - "Add a [feature]..."
      - "Create a [component]..."
      - "Build a [service]..."
      - "Implement [functionality]..."
    routes_to: "work-planner.md"
    confidence_threshold: 0.85
    examples:
      - "I want to add a FAB button pulse animation"
      - "Create a PDF export feature"
      - "Build a dark mode toggle"
      - "Implement session sharing"
  
  execute:
    description: "User wants to continue active work"
    keywords:
      - "continue"
      - "next"
      - "keep going"
      - "proceed"
      - "execute"
    patterns:
      - "continue"
      - "next"
      - "next task"
      - "keep going"
      - "proceed"
      - "execute"
    routes_to: "code-executor.md"
    confidence_threshold: 0.95
    requires_active_session: true
    examples:
      - "continue"
      - "next task"
      - "keep going"
      - "proceed with the plan"
  
  resume:
    description: "User wants to see progress or pickup after break"
    keywords:
      - "resume"
      - "where was I"
      - "status"
      - "progress"
    patterns:
      - "resume"
      - "where was I"
      - "where am I"
      - "show progress"
      - "left off"
      - "status"
      - "current status"
      - "what's next"
    routes_to: "session-resumer.md"
    confidence_threshold: 0.90
    examples:
      - "Show me where I left off"
      - "What's the current status?"
      - "Resume work"
      - "Where was I?"
  
  correct:
    description: "User needs to fix Copilot's mistake/misunderstanding"
    keywords:
      - "wrong"
      - "not"
      - "actually"
      - "correction"
      - "incorrect"
    patterns:
      - "wrong [file|approach|assumption]"
      - "not [that|what I meant]"
      - "actually..."
      - "correction..."
      - "you're [working on|using|modifying] the wrong..."
      - "that's incorrect"
    routes_to: "error-corrector.md"
    confidence_threshold: 0.95
    priority: "HIGHEST"
    halt_current_work: true
    examples:
      - "You're working on the wrong file"
      - "That's not what I meant"
      - "Actually, use SignalR not polling"
      - "Wrong file! The FAB is in Content.razor"
  
  test:
    description: "User wants to create or run tests"
    keywords:
      - "test"
      - "playwright"
      - "visual regression"
      - "unit test"
      - "integration test"
    patterns:
      - "test..."
      - "create [test|tests] for..."
      - "playwright..."
      - "visual regression..."
      - "unit test..."
      - "integration test..."
      - "run tests"
    routes_to: "test-generator.md"
    confidence_threshold: 0.85
    examples:
      - "Create visual tests for the share button"
      - "Run all Playwright tests"
      - "Add unit tests for PDF service"
      - "Create integration tests for the API"
  
  validate:
    description: "User wants system health check"
    keywords:
      - "validate"
      - "health"
      - "check"
      - "quality"
      - "errors"
    patterns:
      - "validate..."
      - "health..."
      - "check [system|quality|errors]..."
      - "run all [validations|tests|checks]..."
      - "quality check"
      - "show errors"
    routes_to: "health-validator.md"
    confidence_threshold: 0.85
    examples:
      - "Check system health"
      - "Validate all changes"
      - "Run quality checks"
      - "Show me all errors"
  
  ask:
    description: "User has questions about KDS or codebase"
    keywords:
      - "how"
      - "what"
      - "explain"
      - "tell me"
      - "where"
      - "which"
      - "?"
    patterns:
      - "how do I..."
      - "what is..."
      - "explain..."
      - "tell me about..."
      - "?" # question mark present
      - "where is..."
      - "which..."
    routes_to: "knowledge-retriever.md"
    confidence_threshold: 0.70
    examples:
      - "How do I test canvas elements with Playwright?"
      - "What test patterns exist?"
      - "Explain the session state system"
      - "Where is the FAB button located?"
  
  govern:
    description: "User modified KDS and needs review"
    keywords:
      - "I updated KDS"
      - "I modified"
      - "review"
      - "I changed"
    patterns:
      - "I updated [KDS|KDS]..."
      - "I modified [prompt|rule|agent]..."
      - "review [my changes|my KDS changes]..."
      - "I changed [the|a] [rule|prompt|agent]..."
    routes_to: "change-governor.md"
    confidence_threshold: 0.90
    context_check: "modifies files in KDS/"
    examples:
      - "I updated the test-generator to support Percy"
      - "Review my KDS modifications"
      - "I changed Rule #15"
      - "I modified the intent-router prompt"
  
  metrics:
    description: "User wants to see KDS performance metrics and BRAIN health"
    keywords:
      - "metrics"
      - "performance"
      - "stats"
      - "brain health"
    patterns:
      - "run metrics"
      - "show metrics"
      - "brain metrics"
      - "performance report"
      - "kds stats"
      - "show [me] performance"
      - "how is [kds|brain] performing"
      - "brain health"
    routes_to: "metrics-reporter.md"
    confidence_threshold: 0.85
    examples:
      - "run metrics"
      - "show metrics"
      - "brain metrics"
      - "performance report"
      - "how is KDS performing?"
      - "show me BRAIN health stats"
  
  commit:
    description: "User wants to commit changes to git with intelligent categorization"
    keywords:
      - "commit"
      - "git commit"
      - "save"
      - "create commit"
    patterns:
      - "commit changes"
      - "commit [my|the] work"
      - "git commit"
      - "save [to|changes to] git"
      - "create [a|] commit[s]"
      - "commit and tag"
      - "commit everything"
    routes_to: "commit-handler.md"
    confidence_threshold: 0.90
    examples:
      - "commit changes"
      - "commit my work"
      - "git commit with proper messages"
      - "save changes to git"
      - "commit everything and tag if needed"
  
  analyze_screenshot:
    description: "User uploads screenshot/image with requirements, mockups, or annotations"
    keywords:
      - "screenshot"
      - "image"
      - "mockup"
      - "design"
      - "wireframe"
      - "annotations"
    patterns:
      - "analyze [this|the] screenshot"
      - "extract requirements from [image|screenshot]"
      - "what does this [mockup|design|wireframe] show"
      - "read [the|these] annotations"
      - "implement what's shown in [this|the] image"
      - "convert this design to code"
      - "extract [specs|requirements] from screenshot"
    routes_to: "screenshot-analyzer.md"
    confidence_threshold: 0.85
    context_check: "image attachment detected"
    examples:
      - "Analyze this screenshot and extract requirements"
      - "What does this mockup show?"
      - "Extract requirements from this annotated image"
      - "Implement the design shown in this screenshot"
      - "Read the annotations on this bug report"
      - "[User attaches image without text - auto-detect]"
  
  amnesia:
    description: "User wants to reset BRAIN for a new application (remove application-specific data)"
    keywords:
      - "reset brain"
      - "amnesia"
      - "clear application"
      - "start fresh"
      - "new project"
    patterns:
      - "reset brain [for|to] [new|different] application"
      - "brain amnesia"
      - "clear application data from brain"
      - "start fresh with new project"
      - "remove [application|project]-specific [data|knowledge]"
      - "prepare brain for new application"
      - "wipe application context"
    routes_to: "brain-amnesia.md"
    confidence_threshold: 0.95
    requires_confirmation: true
    confirmation_keyword: "AMNESIA"
    safety_mechanisms:
      - "Backup created before changes"
      - "Dry-run mode available"
      - "Confirmation required"
      - "Generic patterns preserved"
      - "Full rollback possible"
    examples:
      - "Reset BRAIN for new application"
      - "Brain amnesia - starting new project"
      - "Clear all NoorCanvas data from BRAIN"
      - "Prepare KDS for different application"
      - "Wipe application-specific knowledge"
      - "Start fresh - new project setup"

routing_priority:
  description: "Priority order when multiple intents detected"
  order:
    1: "CORRECT"     # Highest priority - stop current work
    2: "RESUME"      # Check session state first
    3: "COMMIT"      # Save work before new actions
    4: "ANALYZE_SCREENSHOT"  # Visual requirements extraction
    5: "PLAN"        # Start new work
    6: "EXECUTE"     # Continue work
    7: "TEST"        # Create/run tests
    8: "VALIDATE"    # Check system health
    9: "METRICS"     # Performance reporting
    10: "GOVERN"     # Review KDS changes
    11: "ASK"        # Answer questions (lowest priority)

multi_intent_handling:
  description: "How to handle requests with multiple intents"
  strategy:
    - "Identify all matching intents"
    - "Use priority order to select primary intent"
    - "Pass secondary intents as context to specialist agent"
    - "Specialist agent includes secondary intents in plan"
  examples:
    plan_and_test:
      user_request: "I want to add dark mode and test it"
      detected_intents:
        primary: "PLAN"
        secondary: "TEST"
      routing_decision:
        - "Route to work-planner.md (PLAN)"
        - "Planner includes testing phase in plan"
        - "Testing handled automatically in execution"
    execute_and_validate:
      user_request: "Continue and run validation after"
      detected_intents:
        primary: "EXECUTE"
        secondary: "VALIDATE"
      routing_decision:
        - "Route to code-executor.md (EXECUTE)"
        - "After task completes, auto-run health-validator.md"
        - "Report combined results"

ambiguity_resolution:
  description: "How to handle unclear intents"
  strategy:
    - "If no intent matches patterns → Ask for clarification"
    - "If multiple intents with equal confidence → Ask user to choose"
    - "If required session missing → Show error with suggestions"
  examples:
    no_clear_match:
      user_request: "do something"
      response: |
        ❓ Intent unclear. Did you mean:
           1. Continue current work? (execute)
           2. Check progress? (resume)
           3. Start new feature? (plan)
           
        Please clarify or describe what you want.
    no_active_session:
      user_request: "continue"
      check: "current-session.json exists?"
      response_if_no_session: |
        ❌ No active session found.
        Did you mean to start new work?
        
        Use: "I want to [describe feature]"
    multiple_possible_intents:
      user_request: "check the tests"
      could_mean:
        - "VALIDATE: Run all tests"
        - "ASK: Explain test structure"
        - "TEST: Create new tests"
      response: |
        ❓ Did you mean:
           1. Run all existing tests? (validate)
           2. Explain the test structure? (ask)
           3. Create new tests? (test)
           
        Please clarify.

session_state_awareness:
  description: "Routing decisions based on session state"
  session_active:
    execute_intent:
      decision: "Route to code-executor.md"
      confidence: "HIGH"
    plan_intent:
      decision: "Warn about active session, ask to complete or start new"
      confidence: "MEDIUM"
    resume_intent:
      decision: "Route to session-resumer.md"
      confidence: "HIGH"
  no_session:
    execute_intent:
      decision: "Error - no active session"
      suggestion: "Start with 'I want to [feature]'"
    plan_intent:
      decision: "Route to work-planner.md (new session)"
      confidence: "HIGH"
    resume_intent:
      decision: "Info - no active session to resume"
      suggestion: "Start with 'I want to [feature]'"
  session_paused:
    resume_intent:
      decision: "Resume paused session"
      confidence: "HIGH"
    execute_intent:
      decision: "Resume session first, then execute"
      confidence: "MEDIUM"
  session_blocked:
    any_intent:
      decision: "Warn - session blocked"
      show_blockers: true
      suggest_actions: true

brain_integration:
  description: "Use BRAIN knowledge graph for intent confidence"
  enabled: true
  query_before_pattern_matching: true
  confidence_threshold: 0.70
  steps:
    1: "Query BRAIN for intent confidence using user's phrase"
    2: "Apply protection thresholds from protection_config"
    3: "If confidence >= 0.85 AND occurrences >= 3 → Auto-route"
    4: "If confidence >= 0.70 AND < 0.85 → Ask for confirmation"
    5: "If confidence < 0.70 → Fall back to pattern matching"
    6: "If occurrences < 3 → Downgrade to pattern matching (insufficient data)"
    7: "If anomaly detected → Override to pattern matching (safety)"
  fallback_to_pattern_matching:
    - "BRAIN unavailable (empty knowledge graph)"
    - "Low confidence (< 0.70)"
    - "Insufficient data (< 3 occurrences)"
    - "Anomaly detected (confidence > 0.95 with only 1 occurrence)"

conversation_context:
  description: "Load recent conversation for pronoun resolution"
  enabled: true
  buffer_file: "kds-brain/conversation-context.jsonl"
  max_messages: 10
  max_age_hours: 2
  steps:
    1: "Load last 10 messages from conversation-context.jsonl"
    2: "Resolve pronouns (it, that, this) to actual entities"
    3: "Expand message with explicit references"
    4: "Detect context switching (new topic vs continuation)"
    5: "Use expanded message for intent detection"
    6: "Log current message after intent detected"
    7: "Auto-rotate (keep only last 10)"
    8: "Auto-expire (remove messages > 2 hours old)"
  examples:
    pronoun_resolution:
      original_message: "Make it purple"
      context_ref: "FAB button"
      expanded_message: "Make the FAB button purple"

metadata:
  version: "5.0"
  last_updated: "2025-11-03"
  source_file: "KDS/prompts/internal/intent-router.md"
  migration_date: "2025-11-04"
  tier: 0
  permanence: "NEVER_RESET"
  description: "Intent routing logic that determines which specialist agent to invoke - these patterns NEVER change during brain amnesia"
  total_intents: 13
  solid_version: "5.0"
  brain_protection: true
