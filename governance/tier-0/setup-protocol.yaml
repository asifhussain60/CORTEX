# KDS Tier 0: Setup Protocol
# Status: INSTINCT (Permanent, Cannot Be Modified)
# Purpose: 5-step initialization sequence for new applications
# Version: 1.0.0

metadata:
  tier: 0
  classification: INSTINCT
  immutable: true
  created: 2025-11-06
  last_reviewed: 2025-11-06

# Setup Sequence (6 Phases)
setup_phases:
  phase_1:
    name: "Environment Validation"
    duration_estimate: "2-3 minutes"
    required: true
    
    steps:
      - step: "1.1"
        name: "Verify KDS Structure"
        checks:
          - "KDS/ directory exists"
          - "All 10 specialist agents present"
          - "BRAIN directories exist (kds-brain/, sessions/, knowledge/)"
          - "Abstraction layer present (session-loader, test-runner, file-accessor)"
        success_criteria: "All checks pass"
        
      - step: "1.2"
        name: "Detect Application Type"
        actions:
          - "Identify primary language (C#, TypeScript, Python, etc.)"
          - "Detect frameworks (ASP.NET, React, Django, etc.)"
          - "Find build tools (dotnet, npm, pip, etc.)"
          - "Locate test frameworks (Playwright, Jest, xUnit, etc.)"
        output: "Application profile"
        
      - step: "1.3"
        name: "Validate Dependencies"
        checks:
          - "Git available (required for Tier 3)"
          - "PowerShell/Bash available (required for scripts)"
          - "Workspace structure readable"
          - "File system permissions valid"
        success_criteria: "All dependencies available"
        
    output:
      - "Environment validation report"
      - "Application profile"
      - "Dependency status"
      
  phase_2:
    name: "BRAIN Initialization"
    duration_estimate: "7-12 minutes (longest phase)"
    required: true
    warning: "This phase takes the longest - please be patient!"
    
    steps:
      - step: "2.1"
        name: "Create BRAIN Storage"
        actions:
          - "Initialize KDS/kds-brain/ directory structure"
          - "Create conversation-history.jsonl (Tier 1 - empty initially)"
          - "Create knowledge-graph.yaml (Tier 2 - base template)"
          - "Create development-context.yaml (Tier 3 - empty initially)"
          - "Create events.jsonl (event stream - empty)"
          - "Create crawler-state.yaml (crawler tracking)"
          - "Set up session storage (KDS/sessions/)"
          - "Create knowledge repository (KDS/knowledge/)"
        success_criteria: "All BRAIN files created"
        
      - step: "2.2"
        name: "Run Deep Codebase Crawler"
        agent: "brain-crawler.md"
        mode: "deep"
        duration: "5-10 minutes"
        status_updates: "Every 60 seconds"
        
        discovers:
          - "File structure & architecture"
          - "Code relationships (dependencies, imports, DI patterns)"
          - "Test patterns (frameworks, selectors, test data)"
          - "Technology stack (languages, frameworks, libraries)"
          - "Naming conventions (PascalCase, kebab-case, etc.)"
          - "Configuration patterns (appsettings, env vars)"
          - "Documentation locations (README files, API docs)"
          - "Database schemas (SQL files first, then connection strings)"
          
        feeds_brain:
          - "architectural_patterns"
          - "file_relationships"
          - "test_patterns"
          - "conventions"
          - "technology_stack"
          
        output: "Crawler report (KDS/kds-brain/crawler-report-{timestamp}.md)"
        
      - step: "2.3"
        name: "Initialize Development Context (Tier 3)"
        agent: "development-context-collector.md"
        duration: "2-5 minutes"
        status_updates: "Every 30 seconds"
        
        collects:
          - "Git activity (last 30 days)"
          - "Code change velocity (lines added/deleted per week)"
          - "File hotspots (high churn rate files)"
          - "KDS session history (if any exist)"
          - "Testing activity (if tests exist)"
          - "Build/deploy patterns (if scripts exist)"
          
        feeds_brain:
          - "Baseline metrics (velocity, churn, activity)"
          - "Productivity patterns (commit frequency)"
          - "File stability analysis (churn rates)"
          - "Initial correlations (commit size vs complexity)"
          
        output: "KDS/kds-brain/development-context.yaml (baseline metrics)"
        
  phase_3:
    name: "Knowledge Graph Population"
    duration_estimate: "3-5 minutes"
    required: true
    
    steps:
      - step: "3.1"
        name: "Process Crawler Results"
        agent: "brain-updater.md"
        mode: "bootstrap"
        
        actions:
          - "Transform crawler discoveries into knowledge graph entries"
          - "Assign confidence scores (0.50 - 0.98)"
          - "Create file_relationships section"
          - "Create architectural_patterns section"
          - "Create validation_insights section"
          - "Create intent_patterns (empty, will learn from usage)"
          
        confidence_scoring:
          direct_observations: "0.95+ (imports, explicit references)"
          pattern_inference: "0.70-0.85 (naming conventions)"
          statistical: "0.50-0.70 (co-modification patterns)"
          
        output: "Knowledge graph populated with 3,247+ entries"
        
      - step: "3.2"
        name: "Build Intent Vocabulary (Bootstrapping)"
        
        if_templates_available:
          - "Import common intent patterns"
          - "Seed with generic workflow patterns"
          - "Import common file confusion warnings"
          
        if_no_templates:
          - "Start with empty intent_patterns"
          - "BRAIN will learn from first interactions"
          
        output: "Intent vocabulary seeded with 47+ patterns"
        
      - step: "3.3"
        name: "Validate Knowledge Graph"
        
        checks:
          - "YAML syntax validation"
          - "Confidence score ranges (0.50-1.00)"
          - "File references exist"
          - "Query functionality works"
          - "Protection rules active"
          
        success_criteria: "All validations pass"
        
  phase_4:
    name: "Three-Tier BRAIN Setup"
    duration_estimate: "1-2 minutes"
    required: true
    
    steps:
      - step: "4.1"
        name: "Initialize Tier 1 (Conversation History)"
        actions:
          - "Create conversation-history.jsonl"
          - "Set FIFO queue capacity (20 conversations)"
          - "Initialize first conversation (the setup itself)"
          - "Configure conversation boundary detection"
        success_criteria: "Tier 1 initialized"
        
      - step: "4.2"
        name: "Verify Tier 2 (Knowledge Graph)"
        checks:
          - "knowledge-graph.yaml populated"
          - "brain-query queries work"
          - "All sections present (intent_patterns, file_relationships, etc.)"
        success_criteria: "Tier 2 verified"
        
      - step: "4.3"
        name: "Verify Tier 3 (Development Context)"
        checks:
          - "development-context.yaml has baseline metrics"
          - "proactive_warnings generation works"
          - "Correlation analysis available"
          - "Hotspot detection working"
        success_criteria: "Tier 3 verified"
        
      - step: "4.4"
        name: "Enable Automatic Learning"
        configuration:
          - "Configure event logging (all agents → events.jsonl)"
          - "Set automatic update triggers (50+ events OR 24 hours)"
          - "Enable Tier 3 collection (runs after brain updates)"
          - "Verify Rule #16 Step 5 compliance (event count check)"
        success_criteria: "Automatic learning enabled"
        
  phase_5:
    name: "Testing & Validation"
    duration_estimate: "2-3 minutes"
    required: true
    
    steps:
      - step: "5.1"
        name: "Test Core Workflows"
        tests:
          - "Test intent routing (sample phrases)"
          - "Test BRAIN queries"
          - "Test file operations"
        success_criteria: "All core workflows tested successfully"
        
      - step: "5.2"
        name: "Run Health Validator"
        agent: "health-validator.md"
        checks:
          - "All agents loadable"
          - "BRAIN files readable/writable"
          - "Knowledge graph valid"
          - "Session storage functional"
          - "Test framework detection working"
          - "Git integration working"
        success_criteria: "All health checks passed"
        
      - step: "5.3"
        name: "Generate Setup Report"
        output: "KDS/setup-report-{timestamp}.md"
        contents:
          - "Environment summary (languages, frameworks, tools)"
          - "Discovered patterns (components, services, tests)"
          - "BRAIN status (all 3 tiers operational)"
          - "File counts (components, services, tests)"
          - "Known issues (if any)"
          - "Next steps (ready to use!)"
          
  phase_6:
    name: "First Interaction Guidance"
    duration_estimate: "1 minute"
    required: true
    
    steps:
      - step: "6.1"
        name: "Show User Quick Start"
        display:
          - "Setup complete! KDS is ready."
          - "What KDS learned about your application"
          - "BRAIN Status (all 3 tiers)"
          - "Ready to start! Try: #file:KDS/prompts/user/kds.md I want to [feature]"
          
      - step: "6.2"
        name: "Log Setup Event"
        actions:
          - "Record setup completion in events.jsonl"
          - "Create first conversation in conversation-history.jsonl"
          - "Mark setup as successful in crawler-state.yaml"
        success_criteria: "All done!"

# Long-Running Process Protocol
long_running_protocol:
  applies_to: "All operations >30 seconds"
  
  required_elements:
    - "Upfront expectation setting (padded time estimate)"
    - "Visual progress indicators (percentage, phase)"
    - "Heartbeat status updates (every 30-60 seconds)"
    - "Informative messages (what's happening now)"
    - "Completion confirmation"
    - "Graceful interruption (Ctrl+C handling)"
    - "Error recovery guidance"
    
  implementation:
    progress_bar: "[▓▓▓▓▓▓▓░░░] 45%"
    phase_indicator: "Phase 3/6: Knowledge Graph Population"
    time_estimate: "⏱️ Estimated time: 3-5 minutes"
    heartbeat: "[01:30] Processing 612 files for architectural patterns..."
    
# Setup Modes
setup_modes:
  full_setup:
    name: "Full Setup (Recommended)"
    command: "#file:KDS/prompts/user/kds.md Setup"
    duration: "15-20 minutes (padded estimate)"
    includes:
      - "All 6 phases"
      - "Deep crawler"
      - "Complete BRAIN initialization"
    status_updates: "Every 30-60 seconds"
    ready_for: "Production use"
    
  quick_setup:
    name: "Quick Mode (For Testing)"
    command: "#file:KDS/prompts/user/kds.md Setup --quick"
    duration: "3-5 minutes (padded estimate)"
    includes:
      - "Quick crawler scan (not deep)"
      - "Minimal Tier 3 data"
    status_updates: "Every 60 seconds"
    ready_for: "Experimentation only"
    
  migration_setup:
    name: "Migration Mode (Import Existing Knowledge)"
    command: "#file:KDS/prompts/user/kds.md Setup --import 'path/to/old-kds/kds-brain/'"
    duration: "7-10 minutes (padded estimate)"
    includes:
      - "Import generic patterns from previous KDS"
      - "Deep crawler for new application"
      - "Merge old patterns with new discoveries"
    status_updates: "Every 45 seconds"
    ready_for: "Similar project migration"

# Success Criteria
setup_success_indicators:
  - "All 6 phases completed without errors"
  - "KDS/setup-report-{timestamp}.md exists"
  - "knowledge-graph.yaml has 50+ entries"
  - "development-context.yaml has baseline metrics"
  - "Health validator reports 'All checks passed'"
  - "Test query returns architectural patterns"
  - "First kds.md request routes correctly"

# Post-Setup Best Practices
post_setup:
  verification:
    after_first_interactions:
      - "Check events.jsonl (should have new events)"
      - "Check conversation-history.jsonl (should have conversations)"
      - "Run manual brain-updater.md"
      - "Verify knowledge-graph.yaml updated"
      
  maintenance:
    daily: "Let automatic learning work (no action needed)"
    weekly: "Check proactive_warnings in development-context.yaml"
    monthly: "Run incremental crawler (keep structure current)"
    after_refactoring: "Run deep crawler (re-learn architecture)"
    
  optimization:
    if_misroutes:
      - "Check intent_patterns in knowledge-graph.yaml"
      - "Add manual entries for common phrases"
      
    if_wrong_suggestions:
      - "Check architectural_patterns"
      - "Run targeted crawler on new modules"
      
    if_inaccurate_estimates:
      - "Let development-context accumulate data (2-4 weeks)"
      - "Correlations improve with more history"
