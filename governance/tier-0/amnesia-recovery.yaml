# KDS Tier 0: Amnesia Recovery Protocol
# Status: INSTINCT (Permanent, Cannot Be Modified)
# Purpose: Detection and recovery from BRAIN amnesia states
# Version: 1.0.0

metadata:
  tier: 0
  classification: INSTINCT
  immutable: true
  created: 2025-11-06
  last_reviewed: 2025-11-06

# Amnesia Definition
amnesia_states:
  partial_amnesia:
    description: "Loss of some BRAIN data (Tier 1, 2, or 3)"
    severity: "MEDIUM"
    
    symptoms:
      - "Conversation history empty or corrupted"
      - "Knowledge graph missing sections"
      - "Development context outdated (>7 days)"
      - "Event stream missing or gaps"
      
    causes:
      - "File corruption (disk errors)"
      - "Manual deletion of BRAIN files"
      - "Failed brain-updater.md run"
      - "Git checkout reverting BRAIN state"
      
  complete_amnesia:
    description: "Loss of all BRAIN data (fresh install state)"
    severity: "HIGH"
    
    symptoms:
      - "All Tier 1-4 files empty or missing"
      - "No conversation history"
      - "No knowledge graph patterns"
      - "No development context"
      
    causes:
      - "Intentional reset (brain-amnesia.ps1)"
      - "Workspace corruption"
      - "Fresh KDS installation"
      - "Migration to new application"
      
  selective_amnesia:
    description: "Intentional removal of application-specific data"
    severity: "LOW (by design)"
    
    symptoms:
      - "Application paths removed"
      - "Application workflows removed"
      - "Conversations cleared"
      - "Generic patterns preserved"
      
    causes:
      - "User-triggered brain-amnesia.ps1"
      - "Migration to new project"
      - "Clean slate for new application"

# Detection Protocol
detection:
  automatic_checks:
    on_startup:
      - check: "conversation-history.jsonl exists and readable"
        action: "If missing, create empty file, log warning"
        
      - check: "knowledge-graph.yaml exists and valid YAML"
        action: "If corrupt, restore from template or backup"
        
      - check: "development-context.yaml exists and has baseline"
        action: "If missing, trigger collection immediately"
        
      - check: "events.jsonl exists"
        action: "If missing, create empty file"
        
    on_query:
      - check: "BRAIN query returns results"
        action: "If empty, log 'Partial Amnesia' event"
        
      - check: "Conversation context available for recent requests"
        action: "If missing, warn user about context loss"
        
    on_health_check:
      - check: "test-brain-integrity.ps1 detects missing data"
        action: "Generate amnesia report, recommend recovery"
        
  manual_detection:
    user_symptoms:
      - "KDS doesn't remember previous conversations"
      - "'Make it purple' doesn't know what 'it' refers to"
      - "No architectural patterns found"
      - "Estimates are always generic (no historical data)"
      
    diagnosis_command: "#file:KDS/prompts/internal/health-validator.md"
    
    dashboard_indicators:
      - "Tier 1: 0/20 conversations (empty)"
      - "Tier 2: < 50 patterns (suspiciously low)"
      - "Tier 3: last_collection > 7 days (stale)"
      - "Tier 4: 0 events (no activity logged)"

# Recovery Protocol
recovery:
  tier_1_recovery:
    condition: "conversation-history.jsonl empty or corrupt"
    
    automatic:
      - step: "Create empty conversation-history.jsonl"
      - step: "Create empty conversation-context.jsonl"
      - step: "Log amnesia event to events.jsonl"
      - step: "Start fresh with current conversation"
      
    manual:
      - step: "Restore from backup (if available)"
        command: "Copy-Item 'backups/pre-amnesia-*/conversation-history.jsonl' 'kds-brain/'"
      - step: "Accept data loss and rebuild"
        note: "Conversations will rebuild naturally from usage"
        
  tier_2_recovery:
    condition: "knowledge-graph.yaml empty, corrupt, or < 50 patterns"
    
    automatic:
      - step: "Restore from base template (if available)"
        source: "governance/tier-0/knowledge-graph-template.yaml"
      - step: "Run brain-crawler.ps1 (deep mode)"
        duration: "5-10 minutes"
        purpose: "Rebuild architectural patterns"
      - step: "Trigger brain-updater.md to process any pending events"
        
    manual:
      - step: "Restore from backup (if available)"
        command: "Copy-Item 'backups/pre-amnesia-*/knowledge-graph.yaml' 'kds-brain/'"
      - step: "Import generic patterns from templates (if migrating)"
        command: ".\scripts\brain-amnesia.ps1 -Import 'templates/generic-patterns/'"
      - step: "Rebuild from scratch via crawler"
        command: ".\scripts\brain-crawler.ps1 -Mode deep"
        
  tier_3_recovery:
    condition: "development-context.yaml missing or stale (> 7 days)"
    
    automatic:
      - step: "Trigger development-context-collector.md immediately"
        duration: "2-5 minutes"
        purpose: "Rebuild baseline metrics from Git history"
      - step: "Update last_collection_time"
      - step: "Log recovery event"
      
    manual:
      - step: "Force immediate collection"
        command: ".\scripts\collect-development-context.ps1 -Force"
      - step: "Restore from backup (if recent)"
        command: "Copy-Item 'backups/pre-amnesia-*/development-context.yaml' 'kds-brain/'"
        
  tier_4_recovery:
    condition: "events.jsonl missing or has gaps"
    
    automatic:
      - step: "Create empty events.jsonl"
      - step: "Log 'amnesia_detected' event"
      - step: "Start fresh logging from now"
      
    manual:
      - step: "Restore from backup (rare - events are transient)"
      - step: "Accept data loss (events rebuild naturally)"
        note: "Events are transient, loss is not critical"
        
  full_recovery:
    condition: "All tiers empty (complete amnesia)"
    
    protocol:
      - step: "Run #file:KDS/prompts/user/kds.md Setup"
        duration: "15-20 minutes"
        purpose: "Complete BRAIN initialization"
        
      - step: "Deep crawler run"
        included: true
        purpose: "Discover application architecture"
        
      - step: "Development context collection"
        included: true
        purpose: "Rebuild baseline metrics"
        
      - step: "Validation"
        check: "All tiers operational"
        
    alternative:
      - step: "Restore from backup (if available)"
        command: ".\scripts\restore-brain-backup.ps1 -BackupDir 'backups/pre-amnesia-{timestamp}/'"
        duration: "1-2 minutes"

# Prevention Measures
prevention:
  automatic_backups:
    frequency: "Before any risky operation (amnesia, brain reset, migration)"
    location: "kds-brain/backups/pre-{operation}-{timestamp}/"
    retention: "Last 5 backups (automatic cleanup)"
    
    triggers:
      - "brain-amnesia.ps1 invocation"
      - "brain-reset.ps1 invocation"
      - "Setup --import (migration)"
      - "Manual user request"
      
  gitignore_protection:
    rule: "BRAIN state files SHOULD be in .gitignore"
    rationale: "Prevent accidental commits of transient data"
    
    files_to_ignore:
      - "kds-brain/conversation-context.jsonl (Tier 1 - transient)"
      - "kds-brain/events.jsonl (Tier 4 - transient)"
      - "kds-brain/crawler-state.yaml (transient state)"
      
    files_to_commit:
      - "kds-brain/conversation-history.jsonl (Tier 1 - valuable)"
      - "kds-brain/knowledge-graph.yaml (Tier 2 - valuable)"
      - "kds-brain/development-context.yaml (Tier 3 - valuable)"
      
  validation_on_commit:
    hook: "post-commit"
    action: "Verify BRAIN integrity after every commit"
    alert: "If corruption detected, warn user immediately"
    
  health_monitoring:
    schedule: "Daily or on-demand"
    command: "test-brain-integrity.ps1"
    alerts:
      - "Tier 1 conversations < 5 (possible data loss)"
      - "Tier 2 patterns < 50 (possible corruption)"
      - "Tier 3 last_collection > 7 days (stale data)"
      - "Tier 4 events > 100 (processing backlog)"

# Amnesia Reporting
reporting:
  amnesia_report_format:
    file: "kds-brain/amnesia-report-{timestamp}.md"
    
    sections:
      - "Detection Summary"
        - "Amnesia type (partial, complete, selective)"
        - "Affected tiers (1, 2, 3, 4, 5)"
        - "Severity (LOW, MEDIUM, HIGH)"
        
      - "Data Loss Assessment"
        - "Tier 1: {count} conversations lost"
        - "Tier 2: {count} patterns missing"
        - "Tier 3: Metrics stale by {days} days"
        - "Tier 4: {count} events lost"
        
      - "Root Cause Analysis"
        - "Trigger event (file deletion, corruption, reset)"
        - "Timestamp of last known good state"
        - "Possible recovery options"
        
      - "Recovery Actions Taken"
        - "Automatic recovery steps executed"
        - "Manual intervention required (if any)"
        - "Estimated recovery time"
        
      - "Prevention Recommendations"
        - "Enable automatic backups"
        - "Schedule health checks"
        - "Review gitignore configuration"
        
  user_notification:
    on_detection:
      message: |
        ⚠️ **BRAIN AMNESIA DETECTED**
        
        KDS has detected data loss in the BRAIN system.
        
        Severity: {severity}
        Affected: {affected_tiers}
        
        Automatic recovery in progress...
        
        See: kds-brain/amnesia-report-{timestamp}.md for details
        
    on_recovery:
      message: |
        ✅ **BRAIN RECOVERY COMPLETE**
        
        KDS has recovered from amnesia.
        
        Recovered:
          - Tier 1: {tier1_status}
          - Tier 2: {tier2_status}
          - Tier 3: {tier3_status}
          
        Next Steps:
          1. Verify BRAIN health: #file:KDS/prompts/internal/health-validator.md
          2. Review recovery report: kds-brain/amnesia-report-{timestamp}.md
          3. Consider enabling automatic backups

# Selective Amnesia (Intentional)
selective_amnesia_protocol:
  purpose: "Reset BRAIN for new application while preserving generic knowledge"
  command: ".\scripts\brain-amnesia.ps1"
  
  what_gets_removed:
    - "All application-specific file paths"
    - "All application-specific workflows"
    - "All conversations (application context)"
    - "All events (application interactions)"
    - "Development metrics (git stats, velocity)"
    - "Feature components (application-specific)"
    
  what_gets_preserved:
    - "Generic intent patterns ('add [X] button' → plan)"
    - "Generic workflow patterns (test_first_id_preparation)"
    - "KDS-specific patterns (kds_health_monitoring)"
    - "Protection configuration (confidence thresholds)"
    - "All 10 specialist agents"
    - "All governance rules"
    - "All Tier 0 instincts"
    
  safety_measures:
    - "Backup created before amnesia"
    - "Dry-run mode available (-DryRun)"
    - "Requires confirmation (type 'AMNESIA')"
    - "Full rollback possible from backup"
    - "BRAIN integrity verified after amnesia"
    
  post_amnesia_workflow:
    - step: "Amnesia complete (BRAIN reset)"
    - step: "Update kds.config.json (new project details)"
    - step: "Run Setup command (discover new application)"
    - step: "KDS learns from new interactions"
    - step: "BRAIN rebuilds application-specific knowledge over time"

# Rollback Procedures
rollback:
  from_backup:
    condition: "Recovery failed or user wants previous state"
    
    command: |
      # Restore from backup
      $backupDir = "kds-brain/backups/pre-amnesia-{timestamp}"
      Copy-Item -Path "$backupDir/*.yaml" -Destination "kds-brain/" -Force
      Copy-Item -Path "$backupDir/*.jsonl" -Destination "kds-brain/" -Force
      
    verification:
      - "Run test-brain-integrity.ps1"
      - "Verify all tiers operational"
      - "Check conversation count"
      - "Validate knowledge graph patterns"
      
  from_git:
    condition: "Recent commit has good BRAIN state"
    
    command: |
      # Restore BRAIN files from git history
      git checkout HEAD~1 -- kds-brain/conversation-history.jsonl
      git checkout HEAD~1 -- kds-brain/knowledge-graph.yaml
      git checkout HEAD~1 -- kds-brain/development-context.yaml
      
    verification:
      - "Run test-brain-integrity.ps1"
      - "Check if restored state is functional"
      
  factory_reset:
    condition: "Complete rebuild from scratch"
    
    command: "#file:KDS/prompts/user/kds.md Setup"
    duration: "15-20 minutes"
    note: "All previous BRAIN data will be lost"
