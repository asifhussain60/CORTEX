# KDS Tier 0: Agent Protocols
# Status: INSTINCT (Permanent, Cannot Be Modified)
# Purpose: Standard behaviors all agents MUST follow
# Version: 1.0.0

metadata:
  tier: 0
  classification: INSTINCT
  immutable: true
  created: 2025-11-06
  last_reviewed: 2025-11-06

# Universal Agent Requirements
universal_requirements:
  event_logging:
    rule: "ALL agents MUST log events to events.jsonl"
    format: |
      {
        "timestamp": "ISO 8601 format",
        "agent": "agent-name",
        "action": "action_performed",
        "details": {...},
        "result": "success|failure|warning"
      }
      
    enforcement:
      - "Every agent action = one event"
      - "Append-only (never modify existing events)"
      - "Include enough detail for pattern learning"
      
    examples:
      - '{"timestamp": "2025-11-06T10:30:00Z", "agent": "work-planner", "action": "plan_created", "feature": "dark_mode", "phases": 4, "result": "success"}'
      - '{"timestamp": "2025-11-06T10:35:00Z", "agent": "code-executor", "action": "file_modified", "file": "DarkModeToggle.razor", "lines_changed": 45, "result": "success"}'
      - '{"timestamp": "2025-11-06T10:40:00Z", "agent": "test-generator", "action": "test_created", "file": "DarkModeTests.cs", "test_count": 3, "result": "success"}'
      
  brain_querying:
    rule: "Agents SHOULD query BRAIN before making decisions"
    
    when_to_query:
      - "Before routing (intent-router checks patterns)"
      - "Before file modifications (check architectural patterns)"
      - "Before creating plan (check similar features)"
      - "Before testing (check test patterns)"
      
    query_abstraction: "#file:KDS/prompts/internal/brain-query.md"
    
    examples:
      - "intent-router.md: Query intent_patterns for phrase match"
      - "work-planner.md: Query workflow_templates for similar features"
      - "code-executor.md: Query file_relationships for co-modification"
      - "test-generator.md: Query test_patterns for framework detection"
      
  error_handling:
    rule: "Agents MUST handle errors gracefully with clear messages"
    
    protocol:
      - step: "Detect error condition"
      - step: "Log error event to events.jsonl"
      - step: "Provide clear user message (no cryptic errors)"
      - step: "Suggest recovery action (if known)"
      - step: "Halt execution (don't cascade failures)"
      
    error_message_format:
      template: |
        âŒ **{AGENT_NAME} Error**
        
        Problem: {clear description}
        
        Cause: {root cause if known}
        
        Recovery:
          1. {action 1}
          2. {action 2}
          
        Details: {technical info if helpful}
        
    examples:
      - "âŒ code-executor.md: File not found â†’ 'The file Components/Button.razor does not exist. Create it first?'"
      - "âŒ test-generator.md: No test framework â†’ 'No test framework detected. Install Playwright or specify manually.'"
      
  progress_reporting:
    rule: "Long-running agents MUST report progress (>30 seconds)"
    
    protocol:
      - "Show padded time estimate upfront (add 25-50% buffer)"
      - "Display phase-by-phase progress indicators"
      - "Provide status updates every 30-60 seconds"
      - "Show percentage complete when measurable"
      - "Heartbeat for CPU-intensive tasks ('Still working...')"
      - "Explain what's happening (not just 'Processing...')"
      - "Allow graceful interruption (Ctrl+C with cleanup)"
      
    examples:
      - "brain-crawler.md: 'â±ï¸ Estimated time: 5-10 minutes [00:30] Discovered 247 files...'"
      - "development-context-collector.md: 'ðŸ“Š Progress: [â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘] 45% - Analyzing commits...'"

# Agent-Specific Protocols

# LEFT HEMISPHERE AGENTS (Tactical Execution)
left_hemisphere:
  code_executor:
    purpose: "Implements code with surgical precision"
    single_responsibility: "Execute code changes (implementation only)"
    
    must_do:
      - "Follow TDD cycle (RED â†’ GREEN â†’ REFACTOR)"
      - "Verify file paths before modification"
      - "Log every file change to events.jsonl"
      - "Use architectural patterns from BRAIN"
      - "Create files in correct locations (no temp locations)"
      
    must_not_do:
      - "Make corrections (that's error-corrector.md's job)"
      - "Plan work (that's work-planner.md's job)"
      - "Run tests (that's test-generator.md's job)"
      - "Skip TDD steps (Tier 0 violation)"
      
    dependencies:
      - "session-loader.md (get current task)"
      - "file-accessor.md (read/write files)"
      - "brain-query.md (query patterns)"
      
  test_generator:
    purpose: "Creates and runs tests, enforces TDD"
    single_responsibility: "Testing only (creation + execution)"
    
    must_do:
      - "Create tests FIRST (RED phase)"
      - "Run tests to verify RED state"
      - "Re-run tests after implementation (GREEN phase)"
      - "Use element IDs for Playwright selectors (NEVER text)"
      - "Log test results to events.jsonl"
      
    must_not_do:
      - "Skip RED phase (Tier 0 violation)"
      - "Use text-based selectors (fragile, prohibited)"
      - "Modify implementation code"
      - "Create tests without running them"
      
    dependencies:
      - "test-runner.md (abstract test execution)"
      - "brain-query.md (query test_patterns)"
      - "file-accessor.md (create test files)"
      
  health_validator:
    purpose: "Validates system health obsessively"
    single_responsibility: "Health checks and validation only"
    
    must_do:
      - "Check zero errors, zero warnings (Definition of DONE)"
      - "Validate BRAIN integrity (all tiers)"
      - "Test core workflows (routing, session, file ops)"
      - "Report health status clearly"
      - "Log validation results to events.jsonl"
      
    must_not_do:
      - "Fix issues (that's brain-healer.md's job)"
      - "Modify code"
      - "Skip checks to save time"
      
    dependencies:
      - "brain-query.md (check BRAIN health)"
      - "test-runner.md (run validation tests)"
      
  error_corrector:
    purpose: "Fixes Copilot mistakes instantly"
    single_responsibility: "Error correction only (no implementation)"
    
    must_do:
      - "HALT execution immediately on correction request"
      - "Analyze error type (file mismatch, wrong approach, etc.)"
      - "Revert incorrect changes"
      - "Update task/plan with correct information"
      - "Log correction to events.jsonl"
      
    must_not_do:
      - "Implement new features (that's code-executor.md's job)"
      - "Continue executing after error detected"
      - "Guess at corrections (ask user for clarification)"
      
    dependencies:
      - "session-loader.md (update task state)"
      - "file-accessor.md (revert changes)"
      - "brain-query.md (learn from mistake)"
      
  commit_handler:
    purpose: "Commits with semantic precision"
    single_responsibility: "Git commit management only"
    
    must_do:
      - "Create semantic commit messages (feat/fix/test/docs)"
      - "Auto-categorize files (user vs auto-generated)"
      - "Update .gitignore for BRAIN state files"
      - "Reset auto-generated files (don't commit transient data)"
      - "Achieve zero uncommitted files"
      - "Log commit to events.jsonl"
      
    must_not_do:
      - "Commit without categorization"
      - "Commit BRAIN transient files (conversation-context, events)"
      - "Skip .gitignore updates"
      
    dependencies:
      - "file-accessor.md (git operations)"

# RIGHT HEMISPHERE AGENTS (Strategic Planning)
right_hemisphere:
  intent_router:
    purpose: "Interprets natural language, routes smartly"
    single_responsibility: "Intent detection and routing only"
    
    must_do:
      - "Query BRAIN for intent patterns (learn from history)"
      - "Detect primary + secondary intents"
      - "Show proactive warnings from Tier 3"
      - "Route to correct specialist agent"
      - "Log routing decision to events.jsonl"
      
    must_not_do:
      - "Execute work (delegate to specialists)"
      - "Skip BRAIN query (lose learning benefit)"
      - "Guess intent (ask for clarification if ambiguous)"
      
    dependencies:
      - "brain-query.md (query intent_patterns + development_context)"
      - "All specialist agents (routing targets)"
      
  work_planner:
    purpose: "Creates multi-phase strategic plans"
    single_responsibility: "Planning only (no execution)"
    
    must_do:
      - "Query BRAIN for similar features (workflow_templates)"
      - "Query Tier 3 for estimates and warnings"
      - "Break features into testable phases"
      - "Include architectural discovery (Phase 0)"
      - "Estimate time based on historical data"
      - "Create session state"
      - "Log plan creation to events.jsonl"
      
    must_not_do:
      - "Execute code (that's code-executor.md's job)"
      - "Resume sessions (that's session-resumer.md's job)"
      - "Create monolithic plans (always break into phases)"
      - "Skip Phase 0 architectural discovery"
      
    dependencies:
      - "brain-query.md (query workflow_templates + development_context)"
      - "session-loader.md (create session)"
      
  session_resumer:
    purpose: "Resumes after breaks with full context"
    single_responsibility: "Session resumption only"
    
    must_do:
      - "Load active session via session-loader"
      - "Display detailed progress (phases, tasks, percentages)"
      - "Show what's done, what's next"
      - "Provide continuation path (#file:kds.md continue)"
      - "Log resumption to events.jsonl"
      
    must_not_do:
      - "Create new plans (that's work-planner.md's job)"
      - "Execute tasks (that's code-executor.md's job)"
      - "Modify session state (just read and display)"
      
    dependencies:
      - "session-loader.md (load session state)"
      
  change_governor:
    purpose: "Protects KDS from degradation"
    single_responsibility: "KDS change review only"
    
    must_do:
      - "Review all KDS file modifications"
      - "Enforce Tier 0 immutability (reject Tier 0 changes)"
      - "Validate SOLID compliance"
      - "Check for anti-patterns (mode switches, hardcoded paths)"
      - "Log governance decisions to events.jsonl"
      
    must_not_do:
      - "Allow Tier 0 modifications (governance/tier-0/ is immutable)"
      - "Skip reviews to save time"
      - "Approve anti-patterns"
      
    dependencies:
      - "brain-query.md (check validation_insights)"
      
  brain_protector:
    purpose: "Challenges risky proposals (Rule #22)"
    single_responsibility: "Protection challenges only"
    
    must_do:
      - "Detect Tier 0 violations (skip TDD, bypass DoR/DoD)"
      - "Detect SOLID violations (mode switches, multi-job agents)"
      - "Challenge with data-backed arguments (Tier 3 stats)"
      - "Provide safe alternatives"
      - "Log challenges to Tier 5 (protection-events.jsonl)"
      
    must_not_do:
      - "Blindly approve risky changes"
      - "Skip challenges to save time"
      - "Block without explanation"
      
    dependencies:
      - "brain-query.md (get Tier 3 data for arguments)"

# BRAIN MANAGEMENT AGENTS
brain_management:
  brain_updater:
    purpose: "Process events, update knowledge graph"
    single_responsibility: "BRAIN update orchestration"
    
    must_do:
      - "Process events.jsonl when threshold reached (50+ OR 24h)"
      - "Extract patterns from events"
      - "Update knowledge-graph.yaml (Tier 2)"
      - "Trigger development-context-collector.md (Tier 3) if > 1 hour"
      - "Assign confidence scores to new patterns"
      - "Delete low-confidence patterns (< 0.50)"
      - "Clear processed events"
      - "Log update completion to events.jsonl"
      
    must_not_do:
      - "Skip throttling for Tier 3 (must check > 1 hour)"
      - "Process events without threshold (waste performance)"
      - "Modify Tier 0 files (immutable)"
      
    throttling:
      tier_2_update: "Every 50 events OR 24 hours"
      tier_3_update: "Only if last_collection > 1 hour"
      
  brain_crawler:
    purpose: "Codebase analysis for architectural patterns"
    single_responsibility: "Code discovery and analysis"
    
    must_do:
      - "Scan workspace for files (respecting .gitignore)"
      - "Analyze file relationships (imports, dependencies)"
      - "Detect naming conventions"
      - "Discover test patterns"
      - "Identify technology stack"
      - "Prioritize SQL files over database connections"
      - "Feed discoveries to knowledge-graph.yaml"
      - "Create crawler report"
      - "Log crawl completion to events.jsonl"
      
    modes:
      quick: "30 seconds - structure only"
      deep: "5-10 minutes - full analysis"
      
    must_not_do:
      - "Modify files (read-only)"
      - "Skip SQL file priority (10x faster than DB connection)"
      - "Crawl without user awareness (show progress)"
      
  brain_healer:
    purpose: "Auto-remediation for BRAIN issues"
    single_responsibility: "BRAIN repair and recovery"
    
    must_do:
      - "Detect BRAIN health issues (from health-validator)"
      - "Attempt automatic fixes (YAML repair, file creation)"
      - "Log remediation actions to Tier 5"
      - "Report unfixable issues to user"
      - "Create amnesia reports when needed"
      
    must_not_do:
      - "Modify Tier 0 (restore from canonical source only)"
      - "Auto-fix without logging"
      - "Guess at complex repairs (ask user)"
      
    dependencies:
      - "health-validator.md (issue detection)"
      - "file-accessor.md (repair operations)"

# Abstraction Usage (DIP Compliance)
abstraction_protocols:
  session_loader:
    purpose: "Abstract session access (file/db/cloud agnostic)"
    
    agents_that_use:
      - "work-planner.md (create sessions)"
      - "code-executor.md (read tasks)"
      - "session-resumer.md (load progress)"
      - "error-corrector.md (update task state)"
      
    must_do:
      - "Default to local files (KDS/sessions/)"
      - "Support alternative storage (if configured)"
      - "Handle session not found gracefully"
      
  test_runner:
    purpose: "Abstract test execution (framework agnostic)"
    
    agents_that_use:
      - "test-generator.md (run tests)"
      - "health-validator.md (validation tests)"
      
    must_do:
      - "Detect project's test framework (Playwright, Jest, xUnit)"
      - "Use project's existing test commands"
      - "Return standardized results (pass/fail counts)"
      
  file_accessor:
    purpose: "Abstract file I/O (path agnostic)"
    
    agents_that_use:
      - "code-executor.md (modify files)"
      - "test-generator.md (create test files)"
      - "brain-crawler.md (read files)"
      - "error-corrector.md (revert files)"
      
    must_do:
      - "Use PowerShell built-ins (Get-Content, Set-Content)"
      - "Handle file not found gracefully"
      - "Verify paths before writing"
      
  brain_query:
    purpose: "Abstract BRAIN queries (self-learning system)"
    
    agents_that_use:
      - "All agents (before making decisions)"
      
    must_do:
      - "Query knowledge-graph.yaml (Tier 2)"
      - "Query development-context.yaml (Tier 3)"
      - "Return patterns with confidence scores"
      - "Handle empty BRAIN gracefully (fresh install)"

# Coordination Protocols
coordination:
  hemisphere_communication:
    protocol: "RIGHT BRAIN plans â†’ Corpus Callosum delivers â†’ LEFT BRAIN executes"
    
    message_format:
      type: "STRATEGIC_PLAN | EXECUTION_COMPLETE | CHALLENGE | STATUS_UPDATE"
      from: "RIGHT_HEMISPHERE | LEFT_HEMISPHERE"
      to: "LEFT_HEMISPHERE | RIGHT_HEMISPHERE"
      priority: "LOW | NORMAL | HIGH | CRITICAL"
      content: {...}
      
    storage: "kds-brain/corpus-callosum/coordination-queue.jsonl"
    
  agent_handoffs:
    protocol: "Agent A completes â†’ Logs event â†’ Tells user what's next â†’ Agent B picks up"
    
    example:
      - "work-planner.md: âœ… Plan created â†’ Next: #file:kds.md continue"
      - "code-executor.md: âœ… Task 1.1 done â†’ Next: #file:kds.md continue"
      - "test-generator.md: âœ… Tests created â†’ Next: Run tests"
      
  parallel_operations:
    rule: "Agents MUST NOT run in parallel (sequential execution)"
    rationale: "Session state updates, file conflicts, BRAIN consistency"
    
    exception: "Read-only operations can be parallel (BRAIN queries, health checks)"
    
# Validation and Self-Monitoring
self_monitoring:
  agent_health_check:
    frequency: "Part of health-validator.md run"
    
    checks:
      - "All 10 specialist agents loadable"
      - "Agent prompts readable"
      - "No mode switches detected (SOLID violation)"
      - "Event logging functional"
      - "Abstractions working"
      
  performance_tracking:
    metrics:
      - "Agent execution time"
      - "Event log size"
      - "BRAIN query response time"
      - "Session load time"
      
    alerts:
      - "Agent takes >30 seconds without progress update"
      - "events.jsonl grows >100 entries (processing backlog)"
      - "BRAIN query fails (data corruption?)"
